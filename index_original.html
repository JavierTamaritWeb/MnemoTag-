<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImageMetadataPro - Editor de metadatos e imágenes</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style id="app-style">
    /* Theme Variables - Enhanced dark mode support */
    :root {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f5f5f5;
      --bg-accent: #f8fafc;
      --bg-card: #ffffff;
      --bg-overlay: rgba(0, 0, 0, 0.5);
      --bg-tooltip: rgba(0, 0, 0, 0.9);
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-tertiary: #64748b;
      --text-muted: #94a3b8;
      --text-inverse: #ffffff;
      --border-color: #e2e8f0;
      --border-focus: #3b82f6;
      --border-hover: #cbd5e1;
      --accent-primary: #3b82f6;
      --accent-secondary: #06b6d4;
      --accent-hover: #1d4ed8;
      --success: #10b981;
      --success-hover: #059669;
      --warning: #f59e0b;
      --warning-hover: #d97706;
      --error: #ef4444;
      --error-hover: #dc2626;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --radius: 0.5rem;
      --radius-lg: 0.75rem;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Enhanced Dark Mode */
    [data-theme="dark"] {
      --bg-primary: #0a0f1c;
      --bg-secondary: #1a202e;
      --bg-tertiary: #2d3748;
      --bg-accent: #374151;
      --bg-card: #1e293b;
      --bg-overlay: rgba(0, 0, 0, 0.8);
      --bg-tooltip: rgba(17, 24, 39, 0.95);
      --text-primary: #f8fafc;
      --text-secondary: #e2e8f0;
      --text-tertiary: #cbd5e1;
      --text-muted: #94a3b8;
      --text-inverse: #0f172a;
      --border-color: #475569;
      --border-focus: #60a5fa;
      --border-hover: #64748b;
      --accent-primary: #60a5fa;
      --accent-secondary: #22d3ee;
      --accent-hover: #93c5fd;
      --success: #34d399;
      --success-hover: #6ee7b7;
      --warning: #fbbf24;
      --warning-hover: #fcd34d;
      --error: #f87171;
      --error-hover: #fca5a5;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.4);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
    }

    /* Global Theme Styles - Enhanced dark mode support */
    * {
      box-sizing: border-box;
      transition: background-color var(--transition-slow), 
                  color var(--transition-slow), 
                  border-color var(--transition-slow),
                  box-shadow var(--transition);
      text-transform: uppercase !important;
    }

    html {
      transition: background-color var(--transition-slow);
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: var(--transition-slow);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    /* Dark mode specific body enhancements */
    [data-theme="dark"] body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    /* Enhanced selection colors for dark mode */
    ::selection {
      background: var(--accent-primary);
      color: var(--text-inverse);
    }

    [data-theme="dark"] ::selection {
      background: var(--accent-hover);
      color: var(--text-inverse);
    }

    /* Enhanced scrollbar with dark mode support */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
      transition: var(--transition);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    [data-theme="dark"] ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 4px;
      transition: var(--transition);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    /* Focus styles for accessibility */
    *:focus {
      outline: 2px solid var(--border-focus);
      outline-offset: 2px;
    }

    *:focus:not(:focus-visible) {
      outline: none;
    }

    /* Loading state */
    .loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes loadingBar {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .animate-fade-in { animation: fadeIn var(--transition-slow) ease-out; }
    .animate-slide-up { animation: slideUp var(--transition-slow) ease-out; }
    .animate-slide-down { animation: slideDown var(--transition-medium) ease-out; }
    .animate-fade-out { animation: fadeOut var(--transition-medium) ease-out; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-loading-bar { animation: loadingBar 1.5s ease-in-out infinite; }

    /* Enhanced button effects */
    .btn {
      position: relative;
      overflow: hidden;
      will-change: transform, box-shadow;
      backface-visibility: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    /* Enhanced tooltips with dark mode support - DISABLED
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-tooltip);
      color: var(--text-inverse);
      padding: 10px 14px;
      border-radius: var(--radius);
      font-size: 0.875rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-slow) ease;
      z-index: 1000;
      pointer-events: none;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      max-width: 250px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
    }

    [data-tooltip]::before {
      content: '';
      position: absolute;
      bottom: 117%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--bg-tooltip);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-slow) ease;
      z-index: 1000;
    }

    [data-tooltip]:hover::after,
    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }
    */

    /* Dark mode specific tooltips - DISABLED
    [data-theme="dark"] [data-tooltip]::after {
      background: var(--bg-tooltip);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-xl);
    }

    [data-theme="dark"] [data-tooltip]::before {
      border-top-color: var(--bg-tooltip);
    }
    */

    /* Enhanced focus states */
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    /* Dark mode specific enhancements - DISABLED
    .dark [data-tooltip]::after {
      --bg-tooltip: rgba(55, 65, 81, 0.95);
    }

    .dark [data-tooltip]::before {
      --bg-tooltip: rgba(55, 65, 81, 0.95);
      border-top-color: rgba(55, 65, 81, 0.95);
    }
    */

    /* Performance optimizations */
    .card {
      will-change: transform;
      backface-visibility: hidden;
    }

    /* Responsive enhancements */
    @media (max-width: 768px) {
      .animate-slide-up {
        animation-duration: 0.3s;
      }
      
      .btn {
        min-height: 44px; /* Touch-friendly size */
      }
      
      /* [data-tooltip]::after {
        font-size: 0.8rem;
        max-width: 200px;
        white-space: normal;
      } */
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .btn {
        border: 2px solid;
      }
      
      .form-input,
      .form-textarea,
      .form-select {
        border-width: 2px;
      }
    }
    /* Upload dropzone with enhanced dark mode */
    .upload__dropzone {
      border: 2px dashed var(--border-color);
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: var(--transition-slow);
      background-color: var(--bg-secondary);
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px);
    }

    .upload__dropzone::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .upload__dropzone--active {
      border-color: var(--accent-primary);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(34, 211, 238, 0.05));
      transform: scale(1.02);
      box-shadow: var(--shadow-xl);
    }

    .upload__dropzone--active::before {
      left: 100%;
    }

    .upload__dropzone:hover {
      border-color: var(--border-hover);
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      background-color: var(--bg-accent);
    }

    .upload__icon {
      color: var(--accent-primary);
      transition: var(--transition-slow);
      margin-bottom: 1rem;
      filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.2));
    }

    .upload__dropzone:hover .upload__icon {
      transform: scale(1.15) translateY(-5px);
      color: var(--accent-secondary);
      filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3));
    }

    /* Dark mode upload styles */
    [data-theme="dark"] .upload__dropzone {
      background-color: var(--bg-tertiary);
      border-color: var(--border-color);
      box-shadow: var(--shadow);
    }

    [data-theme="dark"] .upload__dropzone:hover {
      background-color: var(--bg-secondary);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-xl);
    }

    [data-theme="dark"] .upload__dropzone--active {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.08), rgba(34, 211, 238, 0.08));
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-xl);
    }

    [data-theme="dark"] .upload__icon {
      filter: drop-shadow(0 2px 4px rgba(96, 165, 250, 0.3));
    }

    [data-theme="dark"] .upload__dropzone:hover .upload__icon {
      filter: drop-shadow(0 4px 8px rgba(96, 165, 250, 0.4));
    }

    /* Mis Botones - Upload Button con estilo premium */
    .upload__button {
      /* Base azul mejorada con gradiente sutil */
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      padding: 16px 36px;
      font-size: 15px;
      font-weight: 600;
      line-height: 1.4;
      
      /* Comportamiento con transición premium */
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      text-transform: uppercase !important;
      letter-spacing: 0.025em;
      
      /* Layout optimizado para texto e icono */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      min-height: 56px;
      min-width: 200px;
      white-space: nowrap;
      margin: 0 auto;
      
      /* Sombra elegante */
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1);
      transform: none !important;
      animation: none !important;
      position: relative;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Hover con color celeste único para upload */
    .upload__button:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: #ffffff;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px) scale(1.02);
    }

    /* Efecto de brillo en hover */
    .upload__button:hover::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
      left: 100%;
    }

    /* Estado activo */
    .upload__button:active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px) scale(0.98);
    }

    /* Focus con ring azul elegante */
    .upload__button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3), 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    /* Iconos mejorados */
    .upload__button i {
      font-size: 18px;
      color: #ffffff;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    /* Iconos con animación sutil en hover */
    .upload__button:hover i {
      color: #ffffff;
      transform: scale(1.1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .upload__button:active i {
      color: #ffffff;
      transform: scale(1.05);
    }

    /* Modo oscuro */
    [data-theme="dark"] .upload__button {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #ffffff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3), 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    [data-theme="dark"] .upload__button:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: #ffffff;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25);
      transform: translateY(-3px) scale(1.02);
    }

    [data-theme="dark"] .upload__button:active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    /* File Info Block - Enhanced */
    .file-info {
      margin-top: 1rem;
      animation: slideUp 0.3s ease-out;
    }
    .file-info--hidden {
      display: none;
    }
    .file-info__content {
      display: flex;
      align-items: center;
      background-color: var(--bg-accent);
      padding: 0.75rem;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }
    .file-info__content:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--border-hover);
    }
    .file-info__icon {
      color: var(--accent-primary);
      margin-right: 0.75rem;
      font-size: 1.25rem;
    }
    .file-info__name {
      color: var(--text-secondary);
      flex: 1;
      font-weight: 500;
    }
    .file-info__remove {
      color: var(--error);
      transition: var(--transition);
      padding: 0.25rem;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .file-info__remove:hover {
      background-color: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      transform: scale(1.1);
    }
    
    /* Error Block - Enhanced */
    .error {
      margin-top: 1rem;
      color: var(--error);
      background-color: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 0.75rem;
      border-radius: var(--radius);
      animation: slideUp 0.3s ease-out;
    }
    .error--hidden {
      display: none;
    }
    
    /* Success Block - Enhanced */
    .success {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 1rem 1.25rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 1000;
      animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 300px;
      font-weight: 500;
    }

    [data-theme="dark"] .success {
      background: linear-gradient(135deg, #065f46, var(--success));
      box-shadow: var(--shadow-xl);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%) scale(0.8);
        opacity: 0;
      }
      to {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }
    
    /* Editor Container Block */
    .editor-container--hidden {
      display: none;
    }

    /* Card Styles - Enhanced with dark mode support */
    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transform: scaleX(0);
      transition: transform 0.3s ease;
      transform-origin: left;
    }

    .card:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
      border-color: var(--border-hover);
    }

    .card:hover::before {
      transform: scaleX(1);
    }

    /* Dark mode specific card enhancements */
    [data-theme="dark"] .card {
      background-color: var(--bg-card);
      border-color: var(--border-color);
      box-shadow: var(--shadow-lg);
    }

    [data-theme="dark"] .card:hover {
      box-shadow: var(--shadow-xl);
      border-color: var(--accent-primary);
      background-color: var(--bg-secondary);
    }

    [data-theme="dark"] .card::before {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    /* Form Controls - Enhanced with dark mode */
    .form-input,
    .form-select,
    .form-textarea {
      background-color: var(--bg-secondary);
      border: 1.5px solid var(--border-color);
      color: var(--text-primary);
      transition: var(--transition);
      border-radius: var(--radius);
      font-size: 0.875rem;
      line-height: 1.5;
      box-shadow: var(--shadow-sm);
    }

    .form-input:hover,
    .form-select:hover,
    .form-textarea:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: scale(1.01);
      outline: none;
    }

    /* Dark mode form controls */
    [data-theme="dark"] .form-input,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .form-textarea {
      background-color: var(--bg-tertiary);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: var(--shadow);
    }

    [data-theme="dark"] .form-input:hover,
    [data-theme="dark"] .form-select:hover,
    [data-theme="dark"] .form-textarea:hover {
      border-color: var(--border-hover);
      background-color: var(--bg-secondary);
    }

    [data-theme="dark"] .form-input:focus,
    [data-theme="dark"] .form-select:focus,
    [data-theme="dark"] .form-textarea:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
      background-color: var(--bg-secondary);
    }

    /* Enhanced placeholder styles */
    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.8;
    }

    [data-theme="dark"] .form-input::placeholder,
    [data-theme="dark"] .form-textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.9;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Text transformation utilities - Mayúsculas para UI */
    .ui-text-uppercase {
      text-transform: uppercase !important;
    }

    /* Apply text transform to UI elements (buttons, labels, titles) - SELECTIVE */
    .form-label,
    label:not(.btn):not(.form-label):not(.range-label),
    .range-label,
    .upload-text,
    .upload-info,
    .section-title,
    .text-content,
    .config-title,
    .footer-text,
    h1, h2, h3, h4, h5, h6,
    .card h3,
    .card h4,
    .metadata-title,
    .location-status,
    .copyright-generator,
    .quality-progress span,
    .quality-progress .text-sm,
    .quality-progress .font-medium,
    .quality-progress .font-bold {
      text-transform: uppercase;
    }

    /* Buttons should NOT have forced text transform */
    .btn,
    button,
    .tab-button,
    .upload__button,
    .gps-button,
    .btn-primary,
    .btn-secondary,
    .btn-outline,
    .btn-success,
    .btn-danger {
      text-transform: uppercase !important;
    }

    /* Placeholders en mayúsculas */
    input::placeholder,
    textarea::placeholder {
      text-transform: uppercase;
    }
    select option {
      text-transform: none !important;
    }

    /* Character counters */
    .char-counter {
      font-size: 0.75rem;
      text-align: right;
      margin-top: 4px;
      transition: color 0.3s ease;
    }
    
    .char-counter.good {
      color: #059669; /* green-600 */
    }
    
    .char-counter.warning {
      color: #d97706; /* amber-600 */
    }
    
    .char-counter.danger {
      color: #dc2626; /* red-600 */
    }
    
    [data-theme="dark"] .char-counter.good {
      color: #10b981; /* green-500 */
    }
    
    [data-theme="dark"] .char-counter.warning {
      color: #f59e0b; /* amber-500 */
    }
    
    [data-theme="dark"] .char-counter.danger {
      color: #ef4444; /* red-500 */
    }

    /* Progress bar styles */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .progress-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .progress-container {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    [data-theme="dark"] .progress-container {
      background: #374151; /* gray-700 */
      color: white;
    }
    
    .progress-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1f2937; /* gray-800 */
    }
    
    [data-theme="dark"] .progress-title {
      color: #f9fafb; /* gray-50 */
    }
    
    .progress-bar-container {
      background: #e5e7eb; /* gray-200 */
      border-radius: 9999px;
      height: 8px;
      margin: 16px 0;
      overflow: hidden;
    }
    
    [data-theme="dark"] .progress-bar-container {
      background: #4b5563; /* gray-600 */
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #3b82f6, #1d4ed8); /* blue gradient */
      height: 100%;
      border-radius: 9999px;
      transition: width 0.3s ease;
      width: 0%;
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      font-size: 0.875rem;
      color: #6b7280; /* gray-500 */
      margin-top: 8px;
    }
    
    [data-theme="dark"] .progress-text {
      color: #d1d5db; /* gray-300 */
    }
    
    .progress-eta {
      font-size: 0.75rem;
      color: #9ca3af; /* gray-400 */
      margin-top: 4px;
    }
    
    [data-theme="dark"] .progress-eta {
      color: #9ca3af; /* gray-400 */
    }

    /* Asegurar que el texto de botones esté en una sola línea */
    .btn,
    button,
    .upload__button {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Alineación de iconos en botones */
    .btn i,
    button i,
    .upload__button i {
      flex-shrink: 0;
      margin-right: 0.25rem;
    }

    /* ===== MODERN BUTTON SYSTEM ===== */
    .btn {
      /* Layout & Structure */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      min-height: 48px;
      min-width: 48px;
      border-radius: 12px;
      border: 2px solid transparent;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      
      /* Typography */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: 15px;
      line-height: 1.2;
      text-decoration: none;
      text-transform: uppercase !important;
      white-space: nowrap;
      text-overflow: ellipsis;
      letter-spacing: 0.025em;
      
      /* Behavior */
      cursor: pointer;
      user-select: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Visual Enhancement */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      backdrop-filter: blur(10px);
    }
    
    /* Focus Ring for Accessibility */
    .btn:focus {
      outline: none;
    }
    
    .btn:focus-visible {
      outline: 3px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }

    /* Button Size Variants */
    .btn.btn-sm {
      padding: 10px 18px;
      min-height: 40px;
      font-size: 14px;
      gap: 6px;
      border-radius: 10px;
    }
    
    .btn.btn-lg {
      padding: 18px 32px;
      min-height: 56px;
      font-size: 16px;
      gap: 10px;
      border-radius: 14px;
      font-weight: 700;
    }
    
    /* Icon-only buttons */
    .btn.btn-icon,
    .btn:has(i:only-child) {
      width: 48px;
      height: 48px;
      padding: 12px;
      min-width: 48px;
    }
    
    .btn.btn-sm.btn-icon,
    .btn.btn-sm:has(i:only-child) {
      width: 40px;
      height: 40px;
      padding: 10px;
      min-width: 40px;
    }
    
    .btn.btn-lg.btn-icon,
    .btn.btn-lg:has(i:only-child) {
      width: 56px;
      height: 56px;
      padding: 16px;
      min-width: 56px;
    }
    
    /* Button States */
    .btn:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
      transition: all 0.1s ease;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
      pointer-events: none;
    }
    
    /* Loading state */
    .btn.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    
    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 18px;
      height: 18px;
      margin: -9px 0 0 -9px;
      border: 2px solid currentColor;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Form validation styles */
    .field-error {
      color: var(--error);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      animation: slideDown 0.3s ease-out;
    }

    .field-error::before {
      content: '⚠';
      font-size: 0.875rem;
    }

    .field-invalid {
      border-color: var(--error) !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    [data-theme="dark"] .field-invalid {
      box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
    }

    .field-valid {
      border-color: var(--success) !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    }

    [data-theme="dark"] .field-valid {
      box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.2) !important;
    }

    /* Loading states for forms */
    .form-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .form-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    /* ===== BUTTON VARIANTS - MODERN DESIGN ===== */
    
    /* Primary Button - Modern Blue with Gradient */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      border-color: #5a67d8;
    }
    
    .btn-primary:active:not(:disabled) {
      background: linear-gradient(135deg, #4c51bf 0%, #553c9a 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
    }
    
    /* Secondary Button - Modern Gray with Subtle Gradient */
    .btn-secondary {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      color: #2d3748;
      border-color: #e2e8f0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
      color: #1a202c;
      border-color: #cbd5e0;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .btn-secondary:active:not(:disabled) {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Outline Button - Clean Modern Look */
    .btn-outline {
      background: rgba(255, 255, 255, 0.8);
      color: #667eea;
      border: 2px solid #667eea;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }
    
    .btn-outline:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px) scale(1.05);
    }
    
    .btn-outline:active:not(:disabled) {
      background: #5a67d8;
      border-color: #5a67d8;
    }
    
    /* Success Button - Modern Green */
    .btn-success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border-color: #48bb78;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }
    
    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
      border-color: #38a169;
    }
    
    .btn-success:active:not(:disabled) {
      background: linear-gradient(135deg, #2f855a 0%, #276749 100%);
    }
    
    /* Danger Button - Modern Red */
    .btn-danger {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      color: white;
      border-color: #f56565;
      box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
    }
    
    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      box-shadow: 0 8px 25px rgba(245, 101, 101, 0.6);
      border-color: #e53e3e;
    }
    
    .btn-danger:active:not(:disabled) {
      background: linear-gradient(135deg, #c53030 0%, #9c2626 100%);
    }
    
    /* Warning Button - Modern Orange */
    .btn-warning {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      color: white;
      border-color: #ed8936;
      box-shadow: 0 4px 15px rgba(237, 137, 54, 0.4);
    }
    
    .btn-warning:hover:not(:disabled) {
      background: linear-gradient(135deg, #dd6b20 0%, #c05621 100%);
      box-shadow: 0 8px 25px rgba(237, 137, 54, 0.6);
      border-color: #dd6b20;
    }

    /* ===== DARK MODE BUTTON STYLES - MODERN ===== */
    [data-theme="dark"] .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6);
    }

    [data-theme="dark"] .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
      box-shadow: 0 8px 30px rgba(124, 58, 237, 0.7);
      border-color: #7c3aed;
    }

    [data-theme="dark"] .btn-secondary {
      background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      color: #e2e8f0;
      border-color: #4a5568;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
      color: #f7fafc;
      border-color: #718096;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .btn-outline {
      background: rgba(45, 55, 72, 0.6);
      color: #667eea;
      border: 2px solid #667eea;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    [data-theme="dark"] .btn-outline:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    [data-theme="dark"] .btn-success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 4px 20px rgba(72, 187, 120, 0.5);
    }

    [data-theme="dark"] .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      box-shadow: 0 8px 30px rgba(72, 187, 120, 0.7);
    }

    [data-theme="dark"] .btn-danger {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      box-shadow: 0 4px 20px rgba(245, 101, 101, 0.5);
    }

    [data-theme="dark"] .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      box-shadow: 0 8px 30px rgba(245, 101, 101, 0.7);
    }

    [data-theme="dark"] .btn-warning {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      box-shadow: 0 4px 20px rgba(237, 137, 54, 0.5);
    }

    /* ===== BOTONES DE INTERFAZ DE IMAGEN - DISEÑO PREMIUM ===== */
    
    /* Botones de rotación - Estilo circular moderno */
    .rotation-controls .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 16px 20px;
      font-weight: 700;
      font-size: 15px;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      min-height: 56px;
    }
    
    .rotation-controls .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }
    
    .rotation-controls .btn:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      transform: translateY(-4px) scale(1.08);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
      border-color: rgba(255, 255, 255, 0.4);
    }
    
    .rotation-controls .btn:hover::before {
      left: 100%;
    }
    
    .rotation-controls .btn:active {
      transform: translateY(-2px) scale(1.02);
      transition: all 0.1s ease;
    }
    
    /* Botón "Original" con estilo especial */
    .rotation-controls .btn-outline {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
      color: #667eea;
      border: 3px solid #667eea;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
    }
    
    .rotation-controls .btn-outline:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
    }
    
    /* Botones de volteo horizontal/vertical */
    .button-group .btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 14px 18px;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 48px;
    }
    
    /* ===== BOTONES MEJORADOS CON DISEÑO PREMIUM ===== */
    
    /* Reset completo de todos los botones */
    .action-buttons .btn,
    .button--action,
    .rotation-controls .btn,
    .filter-preset,
    #fullscreen-btn,
    #undo-btn,
    #redo-btn,
    #reset-changes,
    #download-image,
    button[type="button"],
    .btn-secondary,
    .btn-outline {
      /* Base azul mejorada con gradiente sutil */
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      padding: 16px 36px;
      font-size: 15px;
      font-weight: 600;
      line-height: 1.4;
      
      /* Comportamiento con transición premium */
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      text-transform: uppercase !important;
      letter-spacing: 0.025em;
      
      /* Layout optimizado para texto e icono */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      min-height: 56px;
      min-width: 160px;
      white-space: nowrap;
      padding-left: 36px;
      padding-right: 36px;
      
      /* Sombra elegante */
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1);
      transform: none !important;
      animation: none !important;
      position: relative;
      overflow: hidden;
    }
    
    /* Estados hover con cambios de color más dramáticos */
    .action-buttons .btn:hover,
    .button--action:hover,
    .rotation-controls .btn:hover,
    .filter-preset:hover,
    #fullscreen-btn:hover,
    #undo-btn:hover,
    #redo-btn:hover,
    #reset-changes:hover,
    #download-image:hover,
    button[type="button"]:hover,
    .btn-secondary:hover,
    .btn-outline:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: #ffffff;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px) scale(1.02);
    }
    
    /* Hover específico para Deshacer - Color verde */
    #undo-btn:hover {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Hover específico para Rehacer - Color púrpura */
    #redo-btn:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Hover específico para Restablecer - Color naranja */
    #reset-changes:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Hover específico para Descargar - Color verde esmeralda */
    #download-image:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
      box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Efecto de brillo en hover */
    .action-buttons .btn:hover::before,
    .button--action:hover::before,
    .rotation-controls .btn:hover::before,
    .filter-preset:hover::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
      left: 100%;
    }
    
    /* Estados activos con colores específicos */
    .action-buttons .btn:active,
    .button--action:active,
    .rotation-controls .btn:active,
    .filter-preset:active,
    #fullscreen-btn:active,
    .btn-secondary:active,
    .btn-outline:active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px) scale(0.98);
    }
    
    /* Active específicos para cada botón */
    #undo-btn:active {
      background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }
    
    #redo-btn:active {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%) !important;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }
    
    #reset-changes:active {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
      box-shadow: 0 4px 12px rgba(217, 119, 6, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }
    
    #download-image:active {
      background: linear-gradient(135deg, #047857 0%, #065f46 100%) !important;
      box-shadow: 0 4px 12px rgba(4, 120, 87, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Focus con ring azul elegante */
    .action-buttons .btn:focus,
    .button--action:focus,
    .rotation-controls .btn:focus,
    .filter-preset:focus,
    #fullscreen-btn:focus,
    .btn-secondary:focus,
    .btn-outline:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3), 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    /* Iconos mejorados con mejor espaciado */
    .action-buttons .btn i,
    .button--action i,
    .rotation-controls .btn i,
    .filter-preset i,
    #fullscreen-btn i,
    .btn-secondary i,
    .btn-outline i {
      font-size: 18px;
      color: #ffffff;
      margin-right: 10px;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    /* Iconos con animación sutil en hover */
    .action-buttons .btn:hover i,
    .button--action:hover i,
    .rotation-controls .btn:hover i,
    .filter-preset:hover i,
    #fullscreen-btn:hover i,
    .btn-secondary:hover i,
    .btn-outline:hover i {
      color: #ffffff;
      transform: scale(1.1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    
    .action-buttons .btn:active i,
    .button--action:active i,
    .rotation-controls .btn:active i,
    .filter-preset:active i,
    #fullscreen-btn:active i,
    .btn-secondary:active i,
    .btn-outline:active i {
      color: #ffffff;
      transform: scale(1.05);
    }
    
    /* Botones deshabilitados con estilo elegante */
    .action-buttons .btn:disabled,
    .button--action:disabled,
    .rotation-controls .btn:disabled,
    #undo-btn:disabled,
    #redo-btn:disabled,
    .btn-secondary:disabled,
    .btn-outline:disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      color: #e5e7eb;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
      transform: none !important;
      opacity: 0.7;
    }
    
    .action-buttons .btn:disabled:hover,
    .button--action:disabled:hover,
    .rotation-controls .btn:disabled:hover,
    .btn-secondary:disabled:hover,
    .btn-outline:disabled:hover {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
      color: #e5e7eb;
      box-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
      transform: none !important;
    }
    
    .action-buttons .btn:disabled::before,
    .button--action:disabled::before,
    .rotation-controls .btn:disabled::before,
    .btn-secondary:disabled::before,
    .btn-outline:disabled::before {
      display: none;
    }
    
    .action-buttons .btn:disabled i,
    .button--action:disabled i,
    .rotation-controls .btn:disabled i,
    .btn-secondary:disabled i,
    .btn-outline:disabled i {
      color: #d1d5db;
      transform: none !important;
      filter: none !important;
    }
    
    /* Eliminar todos los pseudo-elementos */
    .action-buttons .btn::before,
    .action-buttons .btn::after,
    .button--action::before,
    .button--action::after,
    .rotation-controls .btn::before,
    .rotation-controls .btn::after,
    .filter-preset::before,
    .filter-preset::after {
      display: none !important;
    }
    
    /* Modo oscuro con hovers coloridos */
    [data-theme="dark"] .action-buttons .btn,
    [data-theme="dark"] .button--action,
    [data-theme="dark"] .rotation-controls .btn,
    [data-theme="dark"] .filter-preset,
    [data-theme="dark"] #fullscreen-btn,
    [data-theme="dark"] #undo-btn,
    [data-theme="dark"] #redo-btn,
    [data-theme="dark"] #reset-changes,
    [data-theme="dark"] #download-image {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: #ffffff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3), 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    [data-theme="dark"] .action-buttons .btn:hover,
    [data-theme="dark"] .button--action:hover,
    [data-theme="dark"] .rotation-controls .btn:hover,
    [data-theme="dark"] .filter-preset:hover,
    [data-theme="dark"] #fullscreen-btn:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: #ffffff;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25);
      transform: translateY(-3px) scale(1.02);
    }
    
    /* Hovers específicos en modo oscuro */
    [data-theme="dark"] #undo-btn:hover {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }
    
    [data-theme="dark"] #redo-btn:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }
    
    [data-theme="dark"] #reset-changes:hover {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }
    
    [data-theme="dark"] #download-image:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
      box-shadow: 0 8px 25px rgba(5, 150, 105, 0.5), 0 4px 12px rgba(0, 0, 0, 0.25) !important;
    }
    
    /* Botón pantalla completa - versión extendida para que quepa texto e icono */
    #fullscreen-btn {
      min-width: 280px !important;
      padding: 18px 32px !important;
      padding-left: 32px !important;
      padding-right: 32px !important;
      font-size: 15px !important;
      gap: 12px !important;
      white-space: nowrap !important;
      min-height: 58px !important;
    }

    /* Botones de rotación - versión compacta con estilo premium */
    .rotation-controls .btn {
      min-width: 100px !important;
      padding: 12px 16px !important;
      font-size: 13px !important;
      gap: 8px !important;
      min-height: 48px !important;
      border-radius: 10px !important;
      white-space: nowrap !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* Iconos de rotación más pequeños */
    .rotation-controls .btn i {
      font-size: 14px !important;
      margin-right: 6px !important;
    }

    /* Botón de resetear filtros - estilo completo de "Mis botones" */
    button[onclick="resetFilters()"] {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 16px 36px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      line-height: 1.4 !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      text-decoration: none !important;
      text-transform: uppercase !important;
      letter-spacing: 0.025em !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 12px !important;
      min-height: 56px !important;
      min-width: 200px !important;
      white-space: nowrap !important;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      overflow: hidden !important;
    }

    /* Hover para el botón de resetear filtros */
    button[onclick="resetFilters()"]:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      transform: translateY(-3px) scale(1.02) !important;
    }

    /* Active para el botón de resetear filtros */
    button[onclick="resetFilters()"]:active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      transform: translateY(-1px) scale(0.98) !important;
    }

    /* Icono del botón de resetear filtros */
    button[onclick="resetFilters()"] i {
      font-size: 18px !important;
      color: #ffffff !important;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)) !important;
      transition: all 0.3s ease !important;
      flex-shrink: 0 !important;
    }

    /* Icono en hover */
    button[onclick="resetFilters()"]:hover i {
      color: #ffffff !important;
      transform: scale(1.1) !important;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
    }

    /* Botones específicos - Aplicar marca de agua y Guardar metadatos */
    button:has(i.fa-paint-brush),
    button:has(i.fa-save) {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 18px 48px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      line-height: 1.4 !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      text-decoration: none !important;
      text-transform: uppercase !important;
      letter-spacing: 0.025em !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 14px !important;
      min-height: 60px !important;
      min-width: 240px !important;
      white-space: nowrap !important;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      overflow: hidden !important;
    }

    /* Hover para botones específicos */
    button:has(i.fa-paint-brush):hover,
    button:has(i.fa-save):hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      transform: translateY(-3px) scale(1.02) !important;
    }

    /* Active para botones específicos */
    button:has(i.fa-paint-brush):active,
    button:has(i.fa-save):active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      transform: translateY(-1px) scale(0.98) !important;
    }

    /* Botón "Original" - estilo completo de "Mis botones" */
    #reset-original-size {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 16px 36px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      line-height: 1.4 !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      text-decoration: none !important;
      text-transform: uppercase !important;
      letter-spacing: 0.025em !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 12px !important;
      min-height: 56px !important;
      min-width: 160px !important;
      white-space: nowrap !important;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25), 0 2px 6px rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      overflow: hidden !important;
    }

    /* Hover para el botón "Original" */
    #reset-original-size:hover {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      transform: translateY(-3px) scale(1.02) !important;
    }

    /* Active para el botón "Original" */
    #reset-original-size:active {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%) !important;
      color: #ffffff !important;
      box-shadow: 0 4px 12px rgba(8, 145, 178, 0.5), 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      transform: translateY(-1px) scale(0.98) !important;
    }

    /* Iconos del botón "Original" */
    #reset-original-size i {
      color: #ffffff !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)) !important;
    }

    #reset-original-size:hover i {
      color: #ffffff !important;
      transform: scale(1.1) !important;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
    }

    /* Iconos de botones específicos */
    button:has(i.fa-paint-brush) i,
    button:has(i.fa-save) i {
      font-size: 18px !important;
      color: #ffffff !important;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1)) !important;
      transition: all 0.3s ease !important;
      flex-shrink: 0 !important;
    }

    /* Iconos en hover */
    button:has(i.fa-paint-brush):hover i,
    button:has(i.fa-save):hover i {
      color: #ffffff !important;
      transform: scale(1.1) !important;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
    }

    /* Cuando está flotando en pantalla completa - versión compacta */
    #fullscreen-btn.floating {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 1002 !important;
      width: 56px !important;
      height: 56px !important;
      padding: 14px !important;
      font-size: 20px !important;
      border-radius: 14px !important;
      min-width: auto !important;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    #fullscreen-btn.floating i {
      margin-right: 0 !important;
      font-size: 20px !important;
    }
    
    #fullscreen-btn.floating:hover {
      box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Padding específico para botón de descarga */
    #download-image {
      padding: 18px 32px !important;
      padding-left: 32px !important;
      padding-right: 32px !important;
      min-width: 280px !important;
      gap: 12px !important;
      min-height: 58px !important;
    }
    
    #download-image i {
      margin-right: 12px !important;
    }
    
    /* Texto de información de imagen en mayúsculas */
    .image-info .text-blue-800.font-medium {
      text-transform: uppercase !important;
    }
    
    /* Responsive premium con mejor espaciado */
    @media (max-width: 768px) {
      .action-buttons .btn,
      .button--action,
      .rotation-controls .btn,
      .filter-preset {
        padding: 18px 24px;
        font-size: 14px;
        min-height: 52px;
        min-width: 140px;
        border-radius: 10px;
      }
      
      .action-buttons .btn i,
      .button--action i,
      .rotation-controls .btn i,
      .filter-preset i {
        font-size: 16px;
        margin-right: 8px;
      }
      
      #fullscreen-btn {
        width: 50px;
        height: 50px;
        border-radius: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        padding: 0 8px;
      }
      
      .action-buttons .btn,
      .button--action {
        width: 100%;
        padding: 20px 28px;
        font-size: 15px;
        min-height: 56px;
        border-radius: 12px;
      }
      
      .rotation-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        padding: 0 8px;
      }
      
      .rotation-controls .btn {
        flex: 1;
        min-width: calc(50% - 6px);
        max-width: 200px;
        padding: 18px 20px;
        border-radius: 10px;
      }
      
      .filter-preset {
        flex: 1;
        min-width: calc(50% - 6px);
        padding: 18px 20px;
        font-size: 14px;
        border-radius: 10px;
      }
      
      #fullscreen-btn {
        width: 48px;
        height: 48px;
        top: 16px;
        right: 16px;
        border-radius: 10px;
      }
    }
    
    /* Estilos específicos para sistema de filtros */
    .filter-control {
      margin-bottom: 1rem;
    }

    .filter-control label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
      color: var(--text-color);
    }

    .filter-range {
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .filter-value {
      color: var(--primary-color);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .filter-preset.btn-primary:hover,
    .filter-preset.active:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .filter-presets {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
      margin-bottom: 16px;
      padding: 8px;
    }

    /* Dark mode filter presets */
    [data-theme="dark"] .filter-preset {
      background: rgba(45, 55, 72, 0.6);
      border-color: #667eea;
      color: #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    [data-theme="dark"] .filter-preset:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    [data-theme="dark"] .filter-preset.btn-primary,
    [data-theme="dark"] .filter-preset.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
    }

    /* Estilos para metadatos y geolocalización */
    .metadata-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    [data-theme="dark"] .metadata-section {
      background: linear-gradient(135deg, var(--bg-accent), var(--bg-secondary));
      border-color: var(--border-color);
    }

    .metadata-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .location-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      margin-top: 0.25rem;
    }

    .location-status.success {
      background-color: #d1f2eb;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .location-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .location-status.loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    [data-theme="dark"] .location-status.success {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.3);
    }

    [data-theme="dark"] .location-status.error {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    [data-theme="dark"] .location-status.loading {
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border-color: rgba(59, 130, 246, 0.3);
    }

    /* Modern GPS Button */
    .gps-button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: 2px solid #48bb78;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 44px;
      min-width: 44px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
      text-transform: none !important;
      white-space: nowrap;
    }

    .gps-button:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
      border-color: #38a169;
    }

    .gps-button:active {
      background: linear-gradient(135deg, #2f855a 0%, #276749 100%);
      transform: translateY(0) scale(0.98);
      transition: all 0.1s ease;
    }

    .gps-button:focus-visible {
      outline: 3px solid rgba(72, 187, 120, 0.5);
      outline-offset: 2px;
    }

    /* Dark mode GPS button */
    [data-theme="dark"] .gps-button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      border-color: #48bb78;
      box-shadow: 0 4px 20px rgba(72, 187, 120, 0.5);
    }

    [data-theme="dark"] .gps-button:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      box-shadow: 0 8px 30px rgba(72, 187, 120, 0.7);
    }

    .copyright-generator {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.375rem 0.75rem;
      transition: all 0.2s ease;
    }

    .copyright-generator:hover {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* Mejoras para modo oscuro en sección de configuración */
    [data-theme="dark"] .quality-progress {
      background-color: var(--bg-secondary);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .quality-progress .text-gray-700 {
      color: var(--text-primary) !important;
    }

    [data-theme="dark"] .quality-progress .text-gray-500 {
      color: var(--text-secondary) !important;
    }

    [data-theme="dark"] .quality-progress .bg-gray-200 {
      background-color: var(--bg-tertiary) !important;
      border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .quality-progress .text-blue-600 {
      color: var(--accent-primary) !important;
    }

    /* Mejoras para controles de formato en modo oscuro */
    [data-theme="dark"] .format-info {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .format-info .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    [data-theme="dark"] .format-info .text-green-600 {
      color: #10b981 !important;
    }

    [data-theme="dark"] .format-info .text-blue-600 {
      color: var(--accent-primary) !important;
    }

    /* Estilos para grid de configuración */
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    .config-section {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .config-section:hover {
      border-color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    [data-theme="dark"] .config-section:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .config-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Estilos específicos para sección de metadatos */
    .metadata-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
      .metadata-grid {
        grid-template-columns: 1fr;
      }
    }

    .metadata-field {
      display: flex;
      flex-direction: column;
    }

    .metadata-field label {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    [data-theme="dark"] .metadata-field label {
      color: var(--text-primary);
    }

    /* Mejoras para botón de copyright en sección 2 */
    .copyright-input-group {
      display: flex;
      border-radius: 6px;
      overflow: hidden;
    }

    .copyright-input-group input {
      border-radius: 0 !important;
      border-right: none !important;
    }

    .copyright-input-group .copyright-generator {
      border-radius: 0 !important;
      border-left: none !important;
    }

    /* Estado del GPS mejorado */
    .gps-status {
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    /* Grid de geolocalización */
    .geo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
    }

    @media (max-width: 768px) {
      .geo-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      box-shadow: var(--shadow);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    [data-theme="dark"] .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: var(--shadow-md);
    }

    [data-theme="dark"] .btn-success:hover {
      background: linear-gradient(135deg, #059669, #047857);
      box-shadow: var(--shadow-xl);
    }

    /* Fullscreen styles */
    .fullscreen-mode {
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .fullscreen-mode canvas {
      border-radius: 8px;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    }

    /* Compare overlay styles */
    .preview__container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }

    /* History button animations */
    .btn:disabled {
      transform: none !important;
      transition: opacity 0.3s ease;
    }

    .btn:not(:disabled):hover {
      transform: translateY(-1px);
    }

    /* Tooltip styles */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      animation: fadeIn 0.2s ease-out;
    }

    [data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: calc(100% - 5px);
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: var(--bg-secondary);
      z-index: 1000;
    }

    /* Dark mode tooltips */
    [data-theme="dark"] [data-tooltip]:hover::after {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] [data-tooltip]:hover::before {
      border-top-color: var(--bg-tertiary);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), var(--success-hover));
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, var(--success-hover), var(--success));
    }

    /* Dark mode success button */
    [data-theme="dark"] .btn-success {
      background: linear-gradient(135deg, var(--success), var(--success-hover));
      box-shadow: var(--shadow);
    }

    [data-theme="dark"] .btn-success:hover {
      box-shadow: var(--shadow-xl);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Enhanced Labels and Typography */
    label {
      color: var(--text-primary) !important;
      transition: var(--transition);
      font-weight: 500;
      font-size: 0.875rem;
      line-height: 1.25rem;
    }

    .form-label {
      color: var(--text-primary) !important;
      display: block;
      margin-bottom: 0.5rem;
    }

    /* Enhanced Range Inputs */
    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-tertiary);
      outline: none;
      transition: var(--transition);
    }

    input[type=range]:hover {
      background: var(--border-color);
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: var(--shadow-md);
    }

    input[type=range]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      border: none;
      transition: var(--transition);
    }

    /* Radio buttons and checkboxes */
    .form-radio {
      accent-color: var(--accent-primary);
      transform: scale(1.1);
    }

    /* Progress indicator */
    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* Color overrides for theme compatibility */
    .text-gray-700 {
      color: var(--text-primary) !important;
    }

    .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    .text-gray-500 {
      color: var(--text-tertiary) !important;
    }

    .upload-text {
      color: var(--text-primary) !important;
      transition: var(--transition);
      font-weight: 500;
    }

    .upload-info {
      color: var(--text-tertiary) !important;
      transition: var(--transition);
      font-size: 0.875rem;
    }

    .text-content {
      color: var(--text-primary) !important;
      transition: var(--transition);
    }

    .range-label {
      color: var(--text-tertiary) !important;
      transition: var(--transition);
      font-size: 0.75rem;
    }
    
    /* Preview Block - Enhanced */
    .preview__canvas {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--border-color);
      background-color: var(--bg-accent);
      transition: var(--transition);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .preview__canvas:hover {
      box-shadow: var(--shadow-md);
    }

    .preview__container {
      position: relative;
      display: flex;
      justify-content: center;
      padding: 1rem;
      background: 
        linear-gradient(45deg, var(--bg-tertiary) 25%, transparent 25%), 
        linear-gradient(-45deg, var(--bg-tertiary) 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, var(--bg-tertiary) 75%), 
        linear-gradient(-45deg, transparent 75%, var(--bg-tertiary) 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      border-radius: var(--radius);
    }

    /* Quality Progress Bar Styles */
    .quality-progress {
      margin-top: 1rem;
    }

    .quality-progress .w-full {
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #quality-bar {
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #quality-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    #quality-percentage {
      font-size: 1rem;
      transition: color 0.3s ease;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Custom Range Slider Styles */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 30%, #22c55e 70%, #16a34a 100%);
      outline: none;
      opacity: 0.8;
      transition: opacity 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .slider:hover {
      opacity: 1;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      border: 3px solid #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
      position: relative;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      border-color: #1d4ed8;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(1.2);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.6);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      border: 3px solid #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
    }

    .slider::-moz-range-thumb:hover {
      transform: scale(1.1);
      border-color: #1d4ed8;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .slider::-moz-range-track {
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 30%, #22c55e 70%, #16a34a 100%);
      border: none;
    }

    /* Quality number input styles */
    #quality-number {
      border: 2px solid #d1d5db;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    #quality-number:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: scale(1.02);
    }

    #quality-number:hover {
      border-color: #9ca3af;
    }

    /* Quality indicators */
    .quality-progress .flex.justify-between:last-child span {
      font-size: 0.75rem;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .quality-progress .flex.justify-between:last-child span:hover {
      color: var(--text-primary);
    }

    /* Format Info Styles */
    #format-info {
      transition: all 0.3s ease;
      border-left: 4px solid;
    }

    #format-info.format-jpeg {
      border-left-color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
    }

    #format-info.format-png {
      border-left-color: #10b981;
      background-color: rgba(16, 185, 129, 0.1);
    }

    #format-info.format-webp {
      border-left-color: #8b5cf6;
      background-color: rgba(139, 92, 246, 0.1);
    }

    #format-info.format-avif {
      border-left-color: #ef4444;
      background-color: rgba(239, 68, 68, 0.1);
    }

    /* Dark mode support for output controls */
    [data-theme="dark"] .quality-progress span {
      color: var(--text-secondary);
    }

    [data-theme="dark"] #quality-percentage {
      color: var(--accent-primary);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .slider {
      background: linear-gradient(90deg, #f87171 0%, #fbbf24 30%, #34d399 70%, #22c55e 100%);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .slider:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .slider::-webkit-slider-thumb {
      background: var(--bg-secondary);
      border-color: var(--accent-primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .slider::-webkit-slider-thumb:hover {
      border-color: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.5);
    }

    [data-theme="dark"] .slider::-moz-range-thumb {
      background: var(--bg-secondary);
      border-color: var(--accent-primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] #quality-number {
      background-color: var(--bg-tertiary);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: var(--shadow);
    }

    [data-theme="dark"] #quality-number:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
      background-color: var(--bg-secondary);
    }

    [data-theme="dark"] #quality-number:hover {
      border-color: var(--border-hover);
      background-color: var(--bg-secondary);
    }

    [data-theme="dark"] .quality-progress .w-full {
      background-color: var(--bg-tertiary);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] #quality-bar {
      background: linear-gradient(90deg, #f87171 0%, #fbbf24 30%, #34d399 70%, #22c55e 100%) !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] #format-info {
      background-color: var(--bg-tertiary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] #format-info.format-jpeg {
      background-color: rgba(245, 158, 11, 0.15);
      border-left-color: #fbbf24;
    }

    [data-theme="dark"] #format-info.format-png {
      background-color: rgba(16, 185, 129, 0.15);
      border-left-color: #34d399;
    }

    [data-theme="dark"] #format-info.format-webp {
      background-color: rgba(139, 92, 246, 0.15);
      border-left-color: #a78bfa;
    }

    [data-theme="dark"] #format-info.format-avif {
      background-color: rgba(239, 68, 68, 0.15);
      border-left-color: #f87171;
    }

    /* Image Info Styles */
    #image-info {
      background-color: var(--bg-accent);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    #image-info .text-blue-800 {
      color: var(--accent-primary);
      font-weight: 600;
    }

    #image-info .text-blue-600 {
      color: var(--text-secondary);
    }

    /* Dark mode for image info */
    [data-theme="dark"] #image-info {
      background-color: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }

    [data-theme="dark"] #image-info .text-blue-800 {
      color: var(--accent-primary);
    }

    [data-theme="dark"] #image-info .text-blue-600 {
      color: var(--text-tertiary);
    }

    /* Resize Section Styles */
    #current-size-display {
      background-color: var(--bg-accent);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .preset-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: var(--radius);
      transition: var(--transition);
      cursor: pointer;
      text-align: center;
      font-size: 0.75rem;
      line-height: 1.2;
    }

    .preset-btn:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
      transform: translateY(-1px);
    }

    .preset-btn:active {
      transform: translateY(0);
    }

    /* Dark mode for resize section */
    [data-theme="dark"] #current-size-display {
      background-color: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: var(--text-tertiary);
    }

    [data-theme="dark"] .preset-btn {
      background: var(--bg-tertiary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .preset-btn:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    [data-theme="dark"] #format-description,
    [data-theme="dark"] #format-compatibility {
      color: var(--text-secondary);
    }
    
    /* Section Block - Enhanced collapsible sections */
    .section__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: var(--radius);
      position: relative;
    }

    .section__header::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent-primary);
      border-radius: 0 3px 3px 0;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .section__header:hover {
      background-color: var(--bg-accent);
      transform: translateX(4px);
    }

    .section__header:hover::before {
      transform: scaleY(1);
    }

    .section__header:focus {
      outline: 2px solid var(--border-focus);
      outline-offset: 2px;
      border-radius: var(--radius);
    }

    .section__icon {
      color: var(--text-tertiary);
      transition: var(--transition);
      font-size: 1.125rem;
    }

    .section__icon--collapsed {
      transform: rotate(-90deg);
    }

    .section__content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .section__content--open {
      max-height: 2000px;
    }

    .section__content--open .section__inner {
      animation: fadeIn 0.3s ease-out 0.1s both;
    }

    .section__inner {
      padding-top: 0.5rem;
    }

    /* Theme Toggle Button - Enhanced with dark mode animations */
    .theme-toggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition-slow);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      backdrop-filter: blur(15px);
      overflow: hidden;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      inset: -2px;
      padding: 2px;
      background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
      border-radius: inherit;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: xor;
      opacity: 0;
      transition: opacity 0.4s ease;
      animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .theme-toggle:hover {
      transform: scale(1.15);
      box-shadow: var(--shadow-xl);
      border-color: var(--accent-primary);
    }

    .theme-toggle:hover::before {
      opacity: 1;
    }

    .theme-toggle i {
      font-size: 1.4rem;
      transition: var(--transition-slow);
      position: relative;
      z-index: 1;
    }

    .theme-toggle:hover i {
      transform: rotate(15deg) scale(1.2);
      color: var(--accent-primary);
    }

    /* Dark mode specific theme toggle */
    [data-theme="dark"] .theme-toggle {
      background: var(--bg-secondary);
      border-color: var(--border-color);
      box-shadow: var(--shadow-xl);
    }

    [data-theme="dark"] .theme-toggle:hover {
      background: var(--bg-tertiary);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .theme-toggle::before {
      background: linear-gradient(45deg, var(--accent-primary), var(--warning), var(--accent-primary));
    }

    /* Header and Footer Styles - Enhanced */
    .header-title {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: var(--transition);
      position: relative;
    }

    .header-subtitle {
      color: var(--text-tertiary);
      transition: var(--transition);
    }

    .footer-text {
      color: var(--text-tertiary);
      transition: var(--transition);
    }

    /* App title animation */
    .app-title {
      animation: fadeIn 0.8s ease-out;
    }

    .app-subtitle {
      animation: fadeIn 1s ease-out 0.2s both;
    }

    /* Enhanced responsive design */
    @media (max-width: 768px) {
      .theme-toggle {
        width: 44px;
        height: 44px;
        top: 0.5rem;
        left: 0.5rem;
      }

      .card {
        margin: 0.5rem;
        border-radius: var(--radius);
      }

      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
      }

      .preview__container {
        padding: 0.5rem;
      }
    }

    /* Dark mode enhancements for specific elements */
    [data-theme="dark"] .bg-red-100 {
      background: linear-gradient(135deg, rgba(127, 29, 29, 0.6), rgba(153, 27, 27, 0.4));
      border-color: var(--error);
      color: #fca5a5;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-lg);
    }

    [data-theme="dark"] .text-blue-600 {
      color: var(--accent-primary) !important;
    }

    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6 {
      color: var(--text-primary) !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] p,
    [data-theme="dark"] span:not(.range-label):not(.text-content):not(.upload-text):not(.upload-info) {
      color: var(--text-secondary) !important;
    }

    /* Enhanced canvas preview for dark mode */
    [data-theme="dark"] .preview__canvas {
      border: 2px solid var(--border-color);
      box-shadow: var(--shadow-xl);
      border-radius: var(--radius);
    }

    /* Dark mode scrollbar in webkit browsers */
    [data-theme="dark"] *::-webkit-scrollbar {
      background: var(--bg-secondary);
    }

    [data-theme="dark"] *::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 4px;
    }

    [data-theme="dark"] *::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    /* Enhanced focus indicators for dark mode */
    [data-theme="dark"] *:focus {
      outline-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
    }

    /* Dark mode range inputs */
    [data-theme="dark"] input[type="range"] {
      background: var(--bg-tertiary);
    }

    [data-theme="dark"] input[type="range"]::-webkit-slider-thumb {
      background: var(--accent-primary);
      box-shadow: 0 2px 6px rgba(96, 165, 250, 0.3);
    }

    [data-theme="dark"] input[type="range"]::-moz-range-thumb {
      background: var(--accent-primary);
      box-shadow: 0 2px 6px rgba(96, 165, 250, 0.3);
    }

    /* Enhanced error/success states */
    [data-theme="dark"] .error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      border-color: var(--error);
      color: var(--error);
    }

    [data-theme="dark"] .success {
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.1), rgba(16, 185, 129, 0.05));
      border-color: var(--success);
      color: var(--success);
    }

    /* Tooltip styles */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--text-primary);
      color: var(--bg-primary);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius);
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 1000;
      opacity: 0;
      animation: fadeIn 0.2s ease-out forwards;
    }
    
    /* Watermark Options Block */
    .watermark-options__text {
      display: block;
    }
    .watermark-options__text--hidden {
      display: none;
    }
    .watermark-options__image {
      display: none;
    }
    .watermark-options__image--visible {
      display: block;
    }
    .watermark-options__custom-size {
      display: none;
      margin-bottom: 1rem;
    }
    .watermark-options__custom-size--visible {
      display: block;
    }

    /* Posicionamiento personalizado de imagen */
    .positioning-mode {
      cursor: crosshair !important;
      position: relative;
    }

    .positioning-mode::after {
      content: "Haz clic para posicionar la marca de agua";
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-primary);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 10;
      animation: pulse 2s infinite;
    }

    .custom-position-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--accent-primary);
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: var(--shadow-lg);
      z-index: 5;
      animation: bounce 1s ease-in-out;
    }

    .custom-position-marker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translate(-50%, -50%) scale(1);
      }
      40% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      60% {
        transform: translate(-50%, -50%) scale(1.1);
      }
    }

    /* Dark mode para posicionamiento */
    [data-theme="dark"] .positioning-mode::after {
      background: var(--accent-primary);
      box-shadow: var(--shadow-xl);
    }

    [data-theme="dark"] .custom-position-marker {
      background: var(--accent-primary);
      border-color: var(--bg-primary);
    }

    [data-theme="dark"] #custom-position-info {
      background-color: rgba(96, 165, 250, 0.1) !important;
      border-color: var(--accent-primary) !important;
    }

    [data-theme="dark"] #custom-position-info p {
      color: var(--accent-primary) !important;
    }

    /* Estilos para previsualización de metadatos */
    .metadata-preview--hidden {
      display: none;
    }

    .preview-field--hidden {
      display: none;
    }

    .metadata-preview {
      animation: slideDown 0.3s ease-out;
    }

    .metadata-preview .bg-gray-50 {
      background-color: var(--bg-accent) !important;
      border-color: var(--accent-primary);
      transition: var(--transition);
    }

    .metadata-preview h4 {
      color: var(--text-primary) !important;
    }

    .metadata-preview .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    .metadata-preview .text-gray-800 {
      color: var(--text-primary) !important;
    }

    /* Dark mode para previsualización */
    [data-theme="dark"] .metadata-preview .bg-gray-50 {
      background-color: var(--bg-tertiary) !important;
      border-color: var(--accent-primary);
    }

    [data-theme="dark"] .metadata-preview h4 {
      color: var(--text-primary) !important;
    }

    [data-theme="dark"] .metadata-preview .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    [data-theme="dark"] .metadata-preview .text-gray-800 {
      color: var(--text-primary) !important;
    }

    /* Form Controls */
    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3B82F6;
      cursor: pointer;
    }
    input[type=range]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3B82F6;
      cursor: pointer;
    }
    
    /* Loading Block */
    .loading__spinner {
      display: none;
    }
    .loading .loading__spinner {
      display: inline-block;
    }
    
    /* Grid Block */
    @media (min-width: 768px) {
      .grid--medium {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
    }
    @media (min-width: 1024px) {
      .grid--large {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        align-items: stretch;
      }
      .grid--large > section {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .grid--large > section > div {
        min-height: 650px;
        display: flex;
        flex-direction: column;
        flex: 1;
        height: 100%;
      }
      .grid--large .section__content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .grid--large .section__content form {
        display: flex;
        flex-direction: column;
        height: 100%;
        flex: 1;
      }
      .grid--large .section__content form > div:last-child {
        margin-top: auto;
        padding-top: 1.5rem;
        display: flex;
        justify-content: center;
      }
      
      /* Button styling for consistent appearance - same as upload button */
      .button--action {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
        width: 200px;
        height: 48px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .button--action:hover {
        background: linear-gradient(135deg, #1d4ed8, #0e7490);
      }

      .button--action:active {
        background: linear-gradient(135deg, #1e40af, #0c7489);
      }

      .button--action:focus-visible {
        outline: 2px solid var(--accent-secondary);
        outline-offset: 2px;
      }

      /* Dark mode action button styles */
      [data-theme="dark"] .button--action:hover {
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
      }

      [data-theme="dark"] .button--action:active {
        background: linear-gradient(135deg, #2563eb, #0891b2);
      }
    }

    /* Uniform button heights for all buttons */
    .btn,
    .upload__button,
    .button--action,
    button {
      height: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1;
      box-sizing: border-box;
    }

    /* Specific styling for upload button to maintain its design */
    .upload__button {
      padding: 0 1.5rem;
    }

    /* Specific styling for action buttons in forms */
    .button--action {
      width: 200px;
      padding: 0 1.25rem;
    }

    /* Enhanced global UI components for better maintainability */
    .global-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(2px);
    }

    .loader-content {
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .loader-message {
      color: var(--text-primary);
      margin: 0;
      font-size: 0.9rem;
    }

    /* Toast notifications */
    .error-toast,
    .success-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 400px;
      z-index: 9999;
      animation: slideInToast 0.3s ease-out;
    }

    .error-toast {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .success-toast {
      background: linear-gradient(135deg, #28a745, #218838);
    }

    .error-content,
    .success-content {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .error-icon,
    .success-icon {
      font-size: 1.2rem;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .error-message,
    .success-message {
      flex: 1;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .error-close,
    .success-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      margin-left: 0.75rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .error-close:hover,
    .success-close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    @keyframes slideInToast {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Form disabled state */
    .form-disabled {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .form-disabled::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      z-index: 1;
    }

    /* Enhanced form validation styles */
    .field-error {
      color: #dc3545;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: block;
      animation: shake 0.3s ease-in-out;
    }

    .field-invalid {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
    }

    .field-valid {
      border-color: #28a745 !important;
      box-shadow: 0 0 0 0.1rem rgba(40, 167, 69, 0.25) !important;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    /* Responsive improvements for mobile */
    @media (max-width: 768px) {
      .error-toast,
      .success-toast {
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .global-loader .loader-content {
        margin: 0 20px;
        padding: 1.5rem;
      }
    }
    @media (min-width: 768px) {
      .boton-marca{
        padding-top: 140px !important;
        }
    }
    
    /* ===== MOBILE-FIRST RESPONSIVE DESIGN IMPROVEMENTS ===== */
    
    /* Variables for mobile breakpoints */
    :root {
      --mobile-sm: 320px;
      --mobile-md: 375px;
      --mobile-lg: 414px;
      --tablet-sm: 768px;
      --tablet-lg: 1024px;
      --desktop: 1200px;
    }
    
    /* Touch-friendly base sizing */
    .btn, .form-input, .form-select, .form-textarea {
      min-height: 44px; /* Apple's recommended touch target size */
      min-width: 44px;
    }
    
    /* Enhanced button sizing for mobile */
    @media (max-width: 767px) {
      .btn {
        min-height: 48px;
        min-width: 48px;
        padding: 14px 20px;
        font-size: 15px;
        font-weight: 600;
        gap: 8px;
      }
      
      .btn.btn-sm {
        min-height: 40px;
        min-width: 40px;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .btn.btn-lg {
        min-height: 56px;
        min-width: 56px;
        padding: 18px 24px;
        font-size: 16px;
      }
      
      .btn:has(i:only-child),
      .btn.btn-icon {
        width: 48px;
        height: 48px;
        min-width: 48px;
        padding: 12px;
      }
      
      .btn.btn-sm:has(i:only-child) {
        width: 40px;
        height: 40px;
        min-width: 40px;
        padding: 10px;
      }
      
      .btn.btn-lg:has(i:only-child) {
        width: 56px;
        height: 56px;
        min-width: 56px;
        padding: 16px;
      }
    }
    
    /* Mobile-first container improvements */
    .container {
      padding-left: 16px;
      padding-right: 16px;
    }
    
    @media (min-width: 640px) {
      .container {
        padding-left: 24px;
        padding-right: 24px;
      }
    }
    
    /* Enhanced mobile header */
    @media (max-width: 767px) {
      .header-title {
        font-size: 1.875rem; /* text-3xl -> text-2xl on mobile */
        line-height: 1.2;
        margin-bottom: 8px;
      }
      
      .header-subtitle {
        font-size: 0.875rem;
        padding: 0 16px;
      }
    }
    
    /* Mobile-optimized cards and sections */
    @media (max-width: 767px) {
      .card {
        margin-bottom: 16px;
        padding: 16px !important;
        border-radius: 12px;
      }
      
      .config-section {
        margin-bottom: 24px;
      }
      
      .config-title {
        font-size: 1rem;
        margin-bottom: 12px;
      }
      
      /* Improved upload zone for mobile */
      .upload__dropzone {
        min-height: 160px;
        padding: 16px;
      }
      
      .upload__dropzone .text-center {
        padding: 16px !important;
      }
      
      .upload__icon {
        font-size: 2.5rem !important;
        margin-bottom: 12px;
      }
      
      .upload__button {
        padding: 12px 24px;
        font-size: 0.875rem;
      }
    }
    
    /* Mobile navigation and collapsibles */
    @media (max-width: 767px) {
      .collapsible-header {
        padding: 16px;
        font-size: 1.125rem;
      }
      
      .collapsible-content {
        padding: 16px;
      }
      
      .collapsible-toggle {
        font-size: 1.25rem;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    /* Mobile form improvements */
    @media (max-width: 767px) {
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-input, .form-textarea, .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px 16px;
        border-radius: 8px;
      }
      
      .form-label {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
      }
      
      /* Special handling for number inputs on mobile */
      input[type="number"], input[type="range"] {
        font-size: 16px;
      }
      
      /* Better slider controls for touch */
      input[type="range"] {
        height: 44px;
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }
      
      input[type="range"]::-webkit-slider-thumb {
        height: 24px;
        width: 24px;
        border-radius: 50%;
        -webkit-appearance: none;
        appearance: none;
      }
      
      input[type="range"]::-moz-range-thumb {
        height: 24px;
        width: 24px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
      }
    }
    
    /* Mobile button groups and controls */
    @media (max-width: 767px) {
      .button-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }
      
      .button-group .btn {
        width: 100%;
        justify-content: center;
        flex: none;
      }
      
      /* Rotation controls mobile optimization */
      .rotation-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin: 16px 0;
        width: 100%;
      }
      
      .rotation-controls .btn {
        padding: 14px 12px;
        font-size: 14px;
        font-weight: 600;
        min-height: 48px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        text-align: center;
      }
      
      .rotation-controls .btn i {
        font-size: 16px;
        margin-bottom: 2px;
      }
      
      /* Download and action buttons */
      .action-buttons {
        position: sticky;
        bottom: 16px;
        background: var(--bg-secondary);
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        margin: 16px -16px -16px -16px;
        z-index: 10;
        border: 1px solid var(--border-color);
      }
      
      .action-buttons .btn {
        width: 100%;
        margin-bottom: 8px;
        font-size: 15px;
        font-weight: 600;
        min-height: 52px;
      }
      
      .action-buttons .btn:last-child {
        margin-bottom: 0;
      }
      
      /* Flex action buttons for multiple buttons */
      .action-buttons.flex,
      .action-buttons .flex {
        display: flex;
        gap: 12px;
      }
      
      .action-buttons.flex .btn,
      .action-buttons .flex .btn {
        flex: 1;
        margin-bottom: 0;
      }
    }
    
    /* Mobile preview optimizations */
    @media (max-width: 767px) {
      #preview-canvas {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        object-fit: contain;
        width: auto;
      }
      
      .preview-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
      }
      
      .preview__container {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      /* Image info mobile layout */
      .image-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        font-size: 0.875rem;
      }
      
      .image-info-item {
        background: var(--bg-tertiary);
        padding: 8px 12px;
        border-radius: 6px;
        text-align: center;
      }
    }
    
    /* Extra small mobile screens - 480px and below */
    @media (max-width: 480px) {
      #preview-canvas {
        max-width: calc(100vw - 32px) !important;
        max-height: 60vh !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
        margin: 0 auto;
        display: block;
      }
      
      .preview__container,
      .preview-container {
        padding: 16px 0;
        width: 100%;
        overflow: visible;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      
      .preview__canvas {
        max-width: 100% !important;
        max-height: 60vh !important;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
      }
      
      /* Ensure canvas container doesn't force width */
      .card .preview__container {
        max-width: none;
        width: 100%;
      }
    }
    
    /* Mobile watermark controls */
    @media (max-width: 767px) {
      .watermark-controls {
        background: var(--bg-secondary);
        position: sticky;
        bottom: 0;
        margin: 16px -16px -16px -16px;
        padding: 16px;
        border-top: 1px solid var(--border-color);
        border-radius: 12px 12px 0 0;
      }
      
      .watermark-preview {
        margin-bottom: 16px;
      }
      
      /* Position controls for mobile */
      .position-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 16px 0;
      }
      
      .position-grid .btn {
        aspect-ratio: 1;
        padding: 8px;
        font-size: 0.75rem;
      }
    }
    
    /* Tablet optimizations */
    @media (min-width: 768px) and (max-width: 1023px) {
      .container {
        max-width: 768px;
      }
      
      .grid-cols-1 {
        grid-template-columns: 1fr;
      }
      
      .md\:grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .card {
        padding: 24px;
      }
      
      /* Tablet button groups */
      .button-group {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      .button-group .btn {
        flex: 1;
        min-width: 120px;
        max-width: 200px;
      }
      
      .rotation-controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        max-width: 600px;
        margin: 16px auto;
      }
      
      .rotation-controls .btn {
        min-height: 48px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .action-buttons {
        position: relative;
        bottom: auto;
        margin: 24px 0;
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .action-buttons .btn {
        flex: 0 1 auto;
        min-width: 160px;
        margin-bottom: 0;
      }
    }
    
    /* Large mobile landscape optimizations */
    @media (max-width: 767px) and (orientation: landscape) {
      .upload__dropzone {
        min-height: 120px;
      }
      
      .config-section {
        margin-bottom: 16px;
      }
      
      .action-buttons {
        position: relative;
        bottom: auto;
        margin: 16px 0;
      }
      
      .watermark-controls {
        position: relative;
        bottom: auto;
        margin: 16px 0;
      }
    }
    
    /* High DPI mobile displays */
    @media (max-width: 767px) and (-webkit-min-device-pixel-ratio: 2) {
      .upload__icon {
        font-size: 3rem !important;
      }
      
      .btn {
        font-weight: 500;
      }
    }
    
    /* Touch interaction improvements */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        transform: none;
      }
      
      .btn:active:not(:disabled) {
        transform: scale(0.96);
        transition: all 0.1s ease;
      }
      
      .btn:focus:not(:disabled) {
        transform: scale(0.98);
        transition: all 0.2s ease;
      }
      
      .collapsible-header:active,
      .upload__dropzone:active {
        transform: scale(0.995);
        transition: transform 0.1s ease;
      }
      
      /* Remove hover effects on touch devices */
      .card:hover,
      .form-input:hover,
      .form-select:hover {
        transform: none;
        box-shadow: var(--shadow);
      }
      
      /* Enhanced focus styles for touch navigation */
      .btn:focus,
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: 3px solid var(--accent-primary);
        outline-offset: 2px;
      }
      
      /* Better button press feedback */
      .btn:active:not(:disabled) {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }
      
      .btn-primary:active:not(:disabled) {
        box-shadow: 0 1px 8px rgba(59, 130, 246, 0.5);
      }
      
      .btn-secondary:active:not(:disabled) {
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.25);
      }
    }
    
    /* Dark mode mobile adjustments */
    [data-theme="dark"] {
      @media (max-width: 767px) {
        .action-buttons {
          background: var(--bg-secondary);
          border-top: 1px solid var(--border-color);
        }
        
        .watermark-controls {
          background: var(--bg-secondary);
          border-top: 1px solid var(--border-color);
        }
        
        .image-info-item {
          background: var(--bg-tertiary);
          color: var(--text-primary);
        }
      }
    }
    
    /* Mobile device specific enhancements */
    .mobile-device .btn {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.025em;
      -webkit-tap-highlight-color: transparent;
    }
    
    .mobile-device .btn.btn-sm {
      font-size: 14px;
    }
    
    .mobile-device .btn.btn-lg {
      font-size: 16px;
    }
    
    .mobile-device .form-input,
    .mobile-device .form-textarea,
    .mobile-device .form-select {
      font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Better spacing on mobile */
    .mobile-device .button-group {
      gap: 16px;
    }
    
    .mobile-device .rotation-controls {
      gap: 16px;
    }
    
    /* Enhanced loading states for mobile */
    .mobile-device .btn:disabled {
      background: #94a3b8 !important;
      color: #64748b !important;
      border-color: #94a3b8 !important;
    }
    
    /* Keyboard open state adjustments */
    .keyboard-open {
      height: 100vh;
      overflow: hidden;
    }
    
    .keyboard-open .action-buttons {
      position: relative;
      bottom: auto;
    }
    
    /* Fixed bottom state for action buttons */
    .action-buttons.fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0;
      border-radius: 0;
      z-index: 1000;
      box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Canvas zoom states */
    #preview-canvas {
      transition: transform 0.3s ease;
      transform-origin: center;
    }
    
    #preview-canvas.zoomed {
      cursor: grab;
    }
    
    #preview-canvas.zoomed:active {
      cursor: grabbing;
    }
    
    /* Controles de Zoom */
    .zoom-controls {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 10;
    }
    
    .zoom-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .zoom-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .zoom-btn:active {
      transform: scale(0.95);
    }
    
    .zoom-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .zoom-level {
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
      text-transform: uppercase;
    }
    
    .zoom-reset {
      background: rgba(255, 255, 255, 0.15);
      margin-left: 4px;
    }
    
    .zoom-reset:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .zoom-controls {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    [data-theme="dark"] .zoom-btn {
      background: rgba(148, 163, 184, 0.2);
    }
    
    [data-theme="dark"] .zoom-btn:hover {
      background: rgba(148, 163, 184, 0.3);
    }
    
    /* Loading states for mobile */
    @media (max-width: 767px) {
      .loading .btn {
        pointer-events: none;
        opacity: 0.7;
      }
      
      .loading .btn::after {
        content: '';
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    }
    
    /* ===== BUTTON TEXT AND LAYOUT FIXES ===== */
    .btn {
      /* Prevent text overflow issues */
      overflow: visible;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .btn.text-wrap {
      white-space: normal;
      text-align: center;
      line-height: 1.3;
    }
    
    /* Fix for buttons with long text on mobile */
    @media (max-width: 480px) {
      .btn {
        white-space: normal;
        text-align: center;
        line-height: 1.3;
        padding: 12px 16px;
        min-height: 48px;
        word-break: break-word;
        hyphens: auto;
      }
      
      .btn:has(i:only-child) {
        white-space: nowrap;
        word-break: normal;
        hyphens: none;
      }
      
      /* Specific adjustments for rotation buttons */
      .rotation-controls .btn {
        font-size: 12px;
        padding: 8px 6px;
        line-height: 1.2;
        min-height: 44px;
      }
      
      .rotation-controls .btn i {
        font-size: 14px;
        display: block;
        margin: 0 0 2px 0;
      }
      
      /* Action buttons on very small screens */
      .action-buttons .btn {
        font-size: 14px;
        padding: 12px 16px;
        line-height: 1.4;
      }
    }
    
    /* Fix button alignment issues */
    .btn i + span,
    .btn span + i {
      margin-left: 6px;
    }
    
    .btn i:first-child {
      margin-right: 8px;
      margin-left: 0;
    }
    
    .btn i:last-child {
      margin-left: 8px;
      margin-right: 0;
    }
    
    .btn i:only-child {
      margin: 0;
    }
    
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Theme Toggle Button -->
  <button id="theme-toggle" class="theme-toggle" aria-label="Cambiar tema">
    <i id="theme-icon" class="fas fa-moon" aria-hidden="true"></i>
  </button>

  <noscript>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
      <strong class="font-bold">JavaScript desactivado:</strong>
      <span>Esta aplicación requiere JavaScript para funcionar correctamente. Por favor, habilítalo en tu navegador.</span>
    </div>
  </noscript>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-center text-blue-600 header-title app-title">ImageMetadataPro</h1>
      <p class="text-center text-gray-600 mt-2 header-subtitle app-subtitle">Edita metadatos y añade marcas de agua a tus imágenes</p>
    </header>

    <main>
      <!-- Upload Zone -->
      <section class="mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 card">
          <h2 class="text-xl font-semibold mb-4">1. Selecciona una imagen</h2>
          <div id="drop-area" class="upload__dropzone rounded-lg cursor-pointer">
            <div class="text-center p-6">
              <i class="fas fa-cloud-upload-alt text-4xl upload__icon" aria-hidden="true"></i>
              <p class="text-gray-700 mb-2 upload-text">Arrastra y suelta tu imagen o</p>
              <button id="file-selector"
                      class="upload__button"
                      aria-label="Seleccionar archivo">
                <i class="fas fa-folder-open" aria-hidden="true"></i>
                Seleccionar archivo
              </button>
              <p class="text-sm text-gray-500 mt-2 upload-info">Formatos: JPG, JPEG, PNG, WEBP, AVIF</p>
              <p class="text-sm text-gray-500 upload-info">Tamaño máximo: 25 MB</p>
              <input type="file" id="file-input"
                     accept=".jpg,.jpeg,.png,.webp,.avif"
                     class="hidden"
                     aria-label="Seleccionar archivo de imagen">
            </div>
          </div>
          <div id="file-info" class="file-info file-info--hidden">
            <div class="file-info__content">
              <i class="fas fa-file-image file-info__icon" aria-hidden="true"></i>
              <span id="file-name" class="file-info__name"></span>
              <button id="remove-file"
                      class="file-info__remove"
                      aria-label="Eliminar imagen seleccionada">
                <i class="fas fa-times" aria-hidden="true"></i>
              </button>
            </div>
          </div>
          <div id="error-message"
               class="error error--hidden"
               aria-live="assertive"></div>
        </div>
      </section>

      <div id="editor-container" class="editor-container--hidden">
        <div class="grid--large mb-8">
          <!-- Metadata Section -->
          <section class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card">
              <div id="metadata-header"
                   class="section__header"
                   role="button"
                   tabindex="0"
                   aria-expanded="true"
                   aria-controls="metadata-content">
                <h2 class="text-xl font-semibold">2. Metadatos y Copyright</h2>
                <i class="fas fa-chevron-down section__icon" aria-hidden="true"></i>
              </div>
              <div id="metadata-content"
                   class="section__content section__content--open"
                   aria-hidden="false">
                <div class="section__inner">
                  <form id="metadata-form">
                  <!-- Metadatos básicos -->
                  <div class="metadata-grid">
                    <div class="metadata-field">
                      <label for="metaTitle">Título</label>
                      <input type="text" id="metaTitle" name="metaTitle"
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                             placeholder="Título de la imagen">
                      <div class="char-counter" id="title-counter">0/60 caracteres</div>
                    </div>
                    <div class="metadata-field">
                      <label for="metaAuthor">Autor</label>
                      <input type="text" id="metaAuthor" name="metaAuthor"
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                             placeholder="Nombre del autor">
                    </div>
                  </div>
                  
                  <!-- Copyright y Licencia -->
                  <div class="metadata-grid">
                    <div class="metadata-field">
                      <label for="metaCopyright">Copyright</label>
                      <div class="copyright-input-group">
                        <input type="text" id="metaCopyright" name="metaCopyright"
                               class="flex-1 px-3 py-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                               placeholder="© 2025 Tu Nombre">
                        <button type="button" class="copyright-generator border border-gray-300 px-3" id="autoCopyright" title="Generar copyright automático">
                          <i class="fas fa-magic"></i>
                        </button>
                      </div>
                    </div>
                    <div class="metadata-field">
                      <label for="metaLicense">Licencia</label>
                      <select id="metaLicense" name="metaLicense"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                        <option value="">Seleccionar licencia...</option>
                        <option value="all-rights-reserved">Todos los derechos reservados</option>
                        <option value="cc-by">Creative Commons - Atribución</option>
                        <option value="cc-by-sa">Creative Commons - Atribución-CompartirIgual</option>
                        <option value="cc-by-nc">Creative Commons - Atribución-NoComercial</option>
                        <option value="cc0">Creative Commons Zero (Dominio Público)</option>
                        <option value="royalty-free">Libre de regalías</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Geolocalización -->
                  <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2 form-label">
                      <i class="fas fa-map-marker-alt mr-1"></i>Geolocalización
                      <button type="button" class="gps-button ml-2" id="getCurrentLocation" title="Obtener ubicación actual">
                        <i class="fas fa-crosshairs"></i> Ubicación actual
                      </button>
                    </label>
                    <div class="geo-grid">
                      <input type="number" id="metaLatitude" name="metaLatitude"
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                             placeholder="Latitud" step="any">
                      <input type="number" id="metaLongitude" name="metaLongitude"
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                             placeholder="Longitud" step="any">
                      <input type="number" id="metaAltitude" name="metaAltitude"
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input"
                             placeholder="Altitud (m)" step="any">
                    </div>
                    <small class="location-status gps-status" id="locationStatus">
                      Haz clic en "Ubicación actual" para obtener coordenadas GPS
                    </small>
                  </div>
                  
                  <!-- Descripción y palabras clave -->
                  <div class="mb-4">
                    <label for="description" class="block text-gray-700 font-medium mb-2 form-label">Descripción</label>
                    <textarea id="description" name="description" rows="3"
                              placeholder="Describe brevemente el contenido de la imagen: paisaje, retrato, evento, objeto, etc. Esta información ayudará a catalogar y encontrar la imagen más fácilmente."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-textarea"></textarea>
                    <div class="char-counter" id="description-counter">0/160 caracteres</div>
                  </div>
                  <div class="mb-4">
                    <label for="keywords" class="block text-gray-700 font-medium mb-2 form-label">Palabras clave (separadas por comas)</label>
                    <input type="text" id="keywords" name="keywords"
                           placeholder="naturaleza, paisaje, montaña, fotografía, viaje, aventura, cielo, nubes"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                    <div class="char-counter" id="keywords-counter">0/200 caracteres</div>
                  </div>
                  <div>
                    <button type="submit"
                            class="btn btn-primary button--action">
                      <i class="fas fa-save" aria-hidden="true"></i>
                      Guardar metadatos
                    </button>
                  </div>
                </form>
                
                <!-- Previsualización de metadatos -->
                <div id="metadata-preview" class="metadata-preview--hidden">
                  <div class="mt-6 p-4 bg-gray-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-3">
                      <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-eye mr-2 text-blue-500"></i>
                        Metadatos guardados
                      </h4>
                      <button onclick="hideMetadataPreview()" 
                              class="text-gray-400 hover:text-gray-600 transition-colors"
                              aria-label="Ocultar previsualización">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                    <div class="space-y-2 text-sm">
                      <div id="preview-title" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Título:</span>
                        <span class="text-gray-800 ml-2" id="preview-title-value"></span>
                      </div>
                      <div id="preview-author" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Autor:</span>
                        <span class="text-gray-800 ml-2" id="preview-author-value"></span>
                      </div>
                      <div id="preview-copyright" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Copyright:</span>
                        <span class="text-gray-800 ml-2" id="preview-copyright-value"></span>
                      </div>
                      <div id="preview-license" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Licencia:</span>
                        <span class="text-gray-800 ml-2" id="preview-license-value"></span>
                      </div>
                      <div id="preview-location" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Ubicación:</span>
                        <span class="text-gray-800 ml-2" id="preview-location-value"></span>
                      </div>
                      <div id="preview-description" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Descripción:</span>
                        <span class="text-gray-800 ml-2" id="preview-description-value"></span>
                      </div>
                      <div id="preview-keywords" class="preview-field--hidden">
                        <span class="font-medium text-gray-600">Palabras clave:</span>
                        <span class="text-gray-800 ml-2" id="preview-keywords-value"></span>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Watermark Section -->
          <section class="mb-4">
            <div class="bg-white rounded-lg shadow-md p-6 card">
              <div id="watermark-header"
                   class="section__header"
                   role="button"
                   tabindex="0"
                   aria-expanded="true"
                   aria-controls="watermark-content">
                <h2 class="text-xl font-semibold">3. Añadir marca de agua</h2>
                <i class="fas fa-chevron-down section__icon" aria-hidden="true"></i>
              </div>
              <div id="watermark-content"
                   class="section__content section__content--open"
                   aria-hidden="false">
                <div class="section__inner">
                  <form id="watermark-form">
                  <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2 form-label">Tipo de marca</label>
                    <div class="flex space-x-4">
                      <label class="inline-flex items-center">
                        <input type="checkbox" id="watermark-text-enabled" name="watermark-text-enabled" checked
                               class="form-checkbox text-blue-500">
                        <span class="ml-2 text-content">Texto</span>
                      </label>
                      <label class="inline-flex items-center">
                        <input type="checkbox" id="watermark-image-enabled" name="watermark-image-enabled"
                               class="form-checkbox text-blue-500">
                        <span class="ml-2 text-content">Imagen</span>
                      </label>
                    </div>
                  </div>

                  <div id="text-watermark-options" class="watermark-options__text">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="mb-4">
                        <label for="watermark-text" class="block text-gray-700 font-medium mb-2 form-label">Texto</label>
                        <input type="text" id="watermark-text" name="watermark-text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                      </div>
                      <div class="mb-4">
                        <label for="watermark-font" class="block text-gray-700 font-medium mb-2 form-label">Fuente</label>
                        <select id="watermark-font" name="watermark-font"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-select">
                          <option value="Arial">Arial</option>
                          <option value="Helvetica">Helvetica</option>
                          <option value="Times New Roman">Times New Roman</option>
                          <option value="Courier New">Courier New</option>
                          <option value="Georgia">Georgia</option>
                        </select>
                      </div>
                      <div class="mb-4">
                        <label for="watermark-color" class="block text-gray-700 font-medium mb-2 form-label">Color</label>
                        <input type="color" id="watermark-color" name="watermark-color" value="#000000"
                               class="w-full h-10 cursor-pointer">
                      </div>
                      <div class="mb-4">
                        <label for="watermark-position" class="block text-gray-700 font-medium mb-2 form-label">Posición</label>
                        <select id="watermark-position" name="watermark-position"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-select">
                          <option value="top-left">Superior izquierda</option>
                          <option value="top-center">Superior centro</option>
                          <option value="top-right">Superior derecha</option>
                          <option value="center-left">Centro izquierda</option>
                          <option value="center">Centro</option>
                          <option value="center-right">Centro derecha</option>
                          <option value="bottom-left">Inferior izquierda</option>
                          <option value="bottom-center">Inferior centro</option>
                          <option value="bottom-right">Inferior derecha</option>
                        </select>
                      </div>
                      <div class="mb-4">
                        <label for="watermark-size" class="block text-gray-700 font-medium mb-2 form-label">Tamaño</label>
                        <input type="range" id="watermark-size" name="watermark-size" min="10" max="100" value="30"
                               class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                          <span class="range-label">Pequeño</span>
                          <span class="range-label">Grande</span>
                        </div>
                      </div>
                      <div class="mb-4">
                        <label for="watermark-opacity" class="block text-gray-700 font-medium mb-2 form-label">Opacidad</label>
                        <input type="range" id="watermark-opacity" name="watermark-opacity" min="0" max="100" value="50"
                               class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                          <span class="range-label">Transparente</span>
                          <span class="range-label">Opaco</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="image-watermark-options" class="watermark-options__image">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="mb-4">
                        <label for="watermark-image" class="block text-gray-700 font-medium mb-2 form-label">Imagen de marca</label>
                        <input type="file" id="watermark-image" name="watermark-image" accept=".png,.jpg,.jpeg"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                      </div>
                      <div class="mb-4">
                        <label for="watermark-image-size" class="block text-gray-700 font-medium mb-2 form-label">Tamaño</label>
                        <select id="watermark-image-size" name="watermark-image-size"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-select">
                          <option value="small">Pequeño</option>
                          <option value="medium" selected>Mediano</option>
                          <option value="large">Grande</option>
                          <option value="custom">Personalizado</option>
                        </select>
                      </div>
                      <div class="mb-4">
                        <label for="watermark-image-opacity" class="block text-gray-700 font-medium mb-2 form-label">Opacidad</label>
                        <input type="range" id="watermark-image-opacity" name="watermark-image-opacity" min="0" max="100" value="50"
                               class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                          <span class="range-label">Transparente</span>
                          <span class="range-label">Opaco</span>
                        </div>
                      </div>
                      <div class="mb-4">
                        <label for="watermark-image-position" class="block text-gray-700 font-medium mb-2 form-label">Posición</label>
                        <select id="watermark-image-position" name="watermark-image-position"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-select">
                          <option value="top-left">Superior izquierda</option>
                          <option value="top-center">Superior centro</option>
                          <option value="top-right">Superior derecha</option>
                          <option value="center-left">Centro izquierda</option>
                          <option value="center">Centro</option>
                          <option value="center-right">Centro derecha</option>
                          <option value="bottom-left">Inferior izquierda</option>
                          <option value="bottom-center">Inferior centro</option>
                          <option value="bottom-right">Inferior derecha</option>
                          <option value="custom">Posición personalizada (clic en imagen)</option>
                        </select>
                      </div>
                      <div id="custom-position-info" class="mb-4" style="display: none;">
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                          <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            Haz clic en la imagen de vista previa para posicionar la marca de agua donde quieras.
                          </p>
                        </div>
                      </div>
                    </div>
                    <div id="watermark-image-custom-size" class="watermark-options__custom-size">
                      <label class="block text-gray-700 font-medium mb-2 form-label">Tamaño personalizado</label>
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label for="watermark-image-width" class="block text-sm text-gray-600 mb-1 form-label">Ancho (px)</label>
                          <input type="number" id="watermark-image-width" name="watermark-image-width" min="10" max="1000"
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                        </div>
                        <div>
                          <label for="watermark-image-height" class="block text-sm text-gray-600 mb-1 form-label">Alto (px)</label>
                          <input type="number" id="watermark-image-height" name="watermark-image-height" min="10" max="1000"
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <button type="submit"
                            class="btn btn-primary button--action">
                      <i class="fas fa-paint-brush" aria-hidden="true"></i>
                      Aplicar marca de agua
                    </button>
                  </div>
                </form>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Filters Section -->
        <section class="mb-8">
          <div class="bg-white rounded-lg shadow-md p-6 card">
            <div id="filters-header"
                 class="section__header"
                 role="button"
                 tabindex="0"
                 aria-expanded="true"
                 aria-controls="filters-content">
              <h2 class="text-xl font-semibold">4. Filtros y Ajustes</h2>
              <i class="fas fa-chevron-down section__icon" aria-hidden="true"></i>
            </div>
            <div id="filters-content"
                 class="section__content section__content--open"
                 aria-hidden="false">
              <div class="section__inner">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Ajustes Básicos -->
                  <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">Ajustes Básicos</h3>
                    
                    <div class="space-y-3">
                      <div>
                        <label for="brightness" class="block text-gray-700 font-medium mb-2 form-label">
                          Brillo: <span id="brightness-value">0</span>
                        </label>
                        <input type="range" id="brightness" name="brightness" min="-100" max="100" value="0" 
                               class="w-full slider">
                      </div>
                      
                      <div>
                        <label for="contrast" class="block text-gray-700 font-medium mb-2 form-label">
                          Contraste: <span id="contrast-value">0</span>
                        </label>
                        <input type="range" id="contrast" name="contrast" min="-100" max="100" value="0" 
                               class="w-full slider">
                      </div>
                      
                      <div>
                        <label for="saturation" class="block text-gray-700 font-medium mb-2 form-label">
                          Saturación: <span id="saturation-value">0</span>
                        </label>
                        <input type="range" id="saturation" name="saturation" min="-100" max="100" value="0" 
                               class="w-full slider">
                      </div>
                      
                      <div>
                        <label for="blur" class="block text-gray-700 font-medium mb-2 form-label">
                          Desenfoque: <span id="blur-value">0</span>px
                        </label>
                        <input type="range" id="blur" name="blur" min="0" max="20" value="0" 
                               class="w-full slider">
                      </div>
                    </div>
                  </div>
                  
                  <!-- Filtros Preestablecidos -->
                  <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">Filtros Preestablecidos</h3>
                    
                    <div class="grid grid-cols-2 gap-3">
                      <button type="button" class="btn btn-outline filter-preset" data-filter="none">
                        Original
                      </button>
                      <button type="button" class="btn btn-outline filter-preset" data-filter="sepia">
                        Sepia
                      </button>
                      <button type="button" class="btn btn-outline filter-preset" data-filter="grayscale">
                        Blanco y Negro
                      </button>
                      <button type="button" class="btn btn-outline filter-preset" data-filter="vintage">
                        Vintage
                      </button>
                      <button type="button" class="btn btn-outline filter-preset" data-filter="cold">
                        Frío
                      </button>
                      <button type="button" class="btn btn-outline filter-preset" data-filter="warm">
                        Cálido
                      </button>
                    </div>
                    
                    <div class="mt-4">
                      <button type="button" class="btn btn-secondary w-full" onclick="resetFilters()">
                        <i class="fas fa-refresh" aria-hidden="true"></i>
                        Resetear Filtros
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Output Settings Section -->
        <section class="mb-8">
          <div class="bg-white rounded-lg shadow-md p-6 card">
            <div id="output-header"
                 class="section__header"
                 role="button"
                 tabindex="0"
                 aria-expanded="true"
                 aria-controls="output-content">
              <h2 class="text-xl font-semibold">5. Configuración de salida</h2>
              <i class="fas fa-chevron-down section__icon" aria-hidden="true"></i>
            </div>
            <div id="output-content"
                 class="section__content section__content--open"
                 aria-hidden="false">
              <div class="section__inner">
                <div class="grid grid-cols-1 gap-6">
                  <!-- Configuración de Calidad y Formato -->
                  <div class="config-grid">
                    <!-- Quality Control -->
                    <div class="config-section">
                      <h4 class="config-title">
                        <i class="fas fa-adjust"></i>Calidad de imagen
                      </h4>
                      <div class="flex gap-3 items-center mb-4">
                        <input type="range" 
                               id="output-quality" 
                               name="output-quality"
                               min="1" 
                               max="100" 
                               value="80"
                               step="1"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex items-center gap-2">
                          <input type="number" 
                                 id="quality-number" 
                                 name="quality-number"
                                 min="1" 
                                 max="100" 
                                 value="80"
                                 class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                          <span class="text-sm font-medium text-gray-600">%</span>
                        </div>
                      </div>
                      <div class="flex justify-between text-xs text-gray-500 mb-4">
                        <span>Baja (1%)</span>
                        <span>Media (50%)</span>
                        <span>Alta (100%)</span>
                      </div>
                      
                      <!-- Quality Progress Bar -->
                      <div class="quality-progress">
                        <div class="flex justify-between items-center mb-2">
                          <span class="text-sm font-medium text-gray-700">Calidad seleccionada:</span>
                          <span id="quality-percentage" class="text-sm font-bold text-blue-600">80%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden border border-gray-300">
                          <div id="quality-bar" 
                               class="h-full transition-all duration-500 rounded-full relative overflow-hidden"
                               style="width: 80%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 30%, #22c55e 70%, #16a34a 100%);">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
                          </div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                          <span class="flex flex-col items-center">
                            <span class="w-2 h-2 bg-red-500 rounded-full mb-1"></span>
                            <span>Baja</span>
                          </span>
                          <span class="flex flex-col items-center">
                            <span class="w-2 h-2 bg-yellow-500 rounded-full mb-1"></span>
                            <span>Media</span>
                          </span>
                          <span class="flex flex-col items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mb-1"></span>
                            <span>Alta</span>
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Image Resize Section -->
                    <div class="config-section">
                      <h4 class="config-title">
                        <i class="fas fa-expand-arrows-alt"></i>Redimensionar imagen
                      </h4>
                      
                      <!-- Current size display -->
                      <div id="current-size-display" class="mb-3 p-2 bg-gray-50 rounded text-sm hidden">
                        <span class="text-gray-600">Tamaño actual: </span>
                        <span id="current-dimensions" class="font-medium">-</span>
                      </div>
                      
                      <!-- Resize controls -->
                      <div class="space-y-3">
                        <!-- Maintain aspect ratio -->
                        <div class="flex items-center">
                          <input type="checkbox" id="maintain-aspect-ratio" class="mr-2" checked>
                          <label for="maintain-aspect-ratio" class="text-sm cursor-pointer">Mantener proporción</label>
                        </div>
                        
                        <!-- Dimension inputs -->
                        <div class="grid grid-cols-2 gap-3">
                          <div>
                            <label for="resize-width" class="block text-sm font-medium mb-1">Ancho (px)</label>
                            <input type="number" id="resize-width" min="1" max="8192" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                          </div>
                          <div>
                            <label for="resize-height" class="block text-sm font-medium mb-1">Alto (px)</label>
                            <input type="number" id="resize-height" min="1" max="8192"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input">
                          </div>
                        </div>
                        
                        <!-- Size presets -->
                        <div>
                          <label class="block text-sm font-medium mb-2">Tamaños predefinidos</label>
                          <div class="grid grid-cols-2 gap-2">
                            <button type="button" class="preset-btn btn-sm" data-width="1920" data-height="1080">
                              Full HD<br><span class="text-xs opacity-75">1920×1080</span>
                            </button>
                            <button type="button" class="preset-btn btn-sm" data-width="1280" data-height="720">
                              HD<br><span class="text-xs opacity-75">1280×720</span>
                            </button>
                            <button type="button" class="preset-btn btn-sm" data-width="800" data-height="600">
                              SVGA<br><span class="text-xs opacity-75">800×600</span>
                            </button>
                            <button type="button" class="preset-btn btn-sm" data-width="1024" data-height="1024">
                              Cuadrado<br><span class="text-xs opacity-75">1024×1024</span>
                            </button>
                            <button type="button" class="preset-btn btn-sm" data-width="1080" data-height="1080">
                              Instagram<br><span class="text-xs opacity-75">1080×1080</span>
                            </button>
                            <button type="button" class="preset-btn btn-sm" data-width="1200" data-height="630">
                              Facebook<br><span class="text-xs opacity-75">1200×630</span>
                            </button>
                          </div>
                        </div>
                        
                        <!-- Resize actions -->
                        <div class="flex gap-2">
                          <button type="button" id="apply-resize" class="btn btn-primary flex-1">
                            <i class="fas fa-check"></i>
                            Aplicar redimensión
                          </button>
                          <button type="button" id="reset-original-size" class="btn btn-secondary">
                            <i class="fas fa-undo"></i>
                            Original
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Image Rotation Section -->
                    <div class="config-section">
                      <h4 class="config-title">
                        <i class="fas fa-redo"></i>Rotación de imagen
                      </h4>
                      
                      <!-- Rotation controls -->
                      <div class="space-y-3">
                        <!-- Current rotation display -->
                        <div id="current-rotation-display" class="p-2 bg-gray-50 rounded text-sm hidden">
                          <span class="text-gray-600">Rotación actual: </span>
                          <span id="current-rotation" class="font-medium">0°</span>
                        </div>
                        
                        <!-- Rotation buttons -->
                        <div class="grid grid-cols-2 gap-2 rotation-controls">
                          <button type="button" id="rotate-90" class="btn btn-secondary">
                            <i class="fas fa-redo"></i>
                            90° ↻
                          </button>
                          <button type="button" id="rotate-180" class="btn btn-secondary">
                            <i class="fas fa-sync"></i>
                            180° ↻
                          </button>
                          <button type="button" id="rotate-270" class="btn btn-secondary">
                            <i class="fas fa-undo"></i>
                            270° ↻
                          </button>
                          <button type="button" id="reset-rotation" class="btn btn-outline">
                            <i class="fas fa-compass"></i>
                            Original
                          </button>
                        </div>
                        
                        <!-- Quick actions -->
                        <div class="flex gap-2 button-group">
                          <button type="button" id="flip-horizontal" class="btn btn-outline flex-1">
                            <i class="fas fa-arrows-alt-h"></i>
                            Voltear H
                          </button>
                          <button type="button" id="flip-vertical" class="btn btn-outline flex-1">
                            <i class="fas fa-arrows-alt-v"></i>
                            Voltear V
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Format Selection -->
                    <div class="config-section">
                      <h4 class="config-title">
                        <i class="fas fa-file-image"></i>Formato de salida
                      </h4>
                      <select id="output-format" name="output-format"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 form-input mb-4">
                        <option value="jpeg">JPEG (.jpg)</option>
                        <option value="png">PNG (.png)</option>
                        <option value="webp">WebP (.webp)</option>
                        <option value="avif">AVIF (.avif)</option>
                      </select>
                      
                      <!-- Format Info -->
                      <div id="format-info" class="format-info p-3 bg-blue-50 border border-blue-200 rounded-md format-jpeg">
                        <div class="flex items-start">
                          <i class="fas fa-info-circle text-blue-600 mt-1 mr-2"></i>
                          <div>
                            <p id="format-title" class="text-sm font-medium text-blue-800 mb-1">JPEG (.jpg)</p>
                            <p id="format-description" class="text-xs text-blue-600">Ideal para fotografías, menor tamaño de archivo.</p>
                            <p id="format-compatibility" class="text-xs text-green-600 mt-1">✓ Compatible con todos los navegadores</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Preview Section - Now below the grid -->
        <section class="mb-8">
          <div class="bg-white rounded-lg shadow-md p-6 card">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold">6. Vista previa</h2>
              <div class="flex gap-2">
                <button id="fullscreen-btn" class="btn btn-primary button--action">
                  <i class="fas fa-expand" aria-hidden="true"></i>
                  Pantalla completa
                </button>
              </div>
            </div>
            
            <!-- Image Info Section -->
            <div id="image-info" class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4 hidden image-info">
              <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 mt-1 mr-2"></i>
                <div class="flex-1">
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm image-info">
                    <div class="image-info-item">
                      <span class="text-blue-800 font-medium">Dimensiones:</span>
                      <div id="image-dimensions" class="text-blue-600">-</div>
                    </div>
                    <div>
                      <span class="text-blue-800 font-medium">Tamaño:</span>
                      <div id="image-size" class="text-blue-600">-</div>
                    </div>
                    <div>
                      <span class="text-blue-800 font-medium">Formato:</span>
                      <div id="image-format" class="text-blue-600">-</div>
                    </div>
                    <div>
                      <span class="text-blue-800 font-medium">Píxeles:</span>
                      <div id="image-pixels" class="text-blue-600">-</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="preview__container preview-container relative">
              <canvas id="preview-canvas" class="preview__canvas"></canvas>
              
              <!-- Controles de Zoom -->
              <div id="zoom-controls" class="zoom-controls hidden">
                <button id="zoom-out-btn" class="zoom-btn" title="Alejar (-)">
                  <i class="fas fa-minus"></i>
                </button>
                <span id="zoom-level" class="zoom-level">100%</span>
                <button id="zoom-in-btn" class="zoom-btn" title="Acercar (+)">
                  <i class="fas fa-plus"></i>
                </button>
                <button id="zoom-reset-btn" class="zoom-btn zoom-reset" title="Restablecer zoom (Ctrl+0)">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="mt-4 flex justify-between gap-3">
              <div class="flex gap-2">
                <button id="undo-btn" class="btn btn-primary button--action" disabled>
                  <i class="fas fa-undo-alt" aria-hidden="true"></i>
                  Deshacer
                </button>
                <button id="redo-btn" class="btn btn-primary button--action" disabled>
                  <i class="fas fa-redo-alt" aria-hidden="true"></i>
                  Rehacer
                </button>
              </div>
              <div class="flex gap-2 flex-wrap action-buttons">
                <button id="reset-changes" class="btn btn-primary button--action">
                  <i class="fas fa-refresh" aria-hidden="true"></i>
                  Restablecer
                </button>
                <button id="download-image" class="btn btn-primary button--action">
                  <i class="fas fa-download" aria-hidden="true"></i>
                  Descargar imagen
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="mt-12 text-center text-gray-500 text-sm">
      <p class="footer-text">© 2025 ImageMetadataPro. Todos los derechos reservados.</p>
    </footer>
  </div>

  <script>
    // Variables globales optimizadas
    let currentImage = null;
    let canvas = null;
    let ctx = null;
    let currentFile = null;
    let originalExtension = 'jpg';
    let lastDownloadDirectory = null;
    
    // Variables para redimensionado
    let originalImageDimensions = { width: 0, height: 0 };
    let isResizing = false;
    
    // Variables para rotación
    let currentRotation = 0; // Degrees: 0, 90, 180, 270
    let isFlippedHorizontally = false;
    let isFlippedVertically = false;
    
    // Variables para zoom
    let currentZoom = 1.0; // Factor de zoom (1.0 = 100%)
    let minZoom = 0.1; // Zoom mínimo (10%)
    let maxZoom = 5.0; // Zoom máximo (500%)
    let zoomStep = 0.1; // Incremento del zoom (10%)
    let isZoomed = false;
    
    // Variables para pan (navegación con zoom)
    let panX = 0; // Posición X del pan
    let panY = 0; // Posición Y del pan
    let isPanning = false; // Estado de arrastre
    let startPanX = 0; // Posición inicial X del mouse
    let startPanY = 0; // Posición inicial Y del mouse
    let startOffsetX = 0; // Offset inicial X
    let startOffsetY = 0; // Offset inicial Y
    
    // Variables para configuración de salida
    let outputQuality = 0.8; // Valor por defecto (80%)
    let outputFormat = 'jpeg'; // Formato por defecto
    
    // Variables para posicionamiento interactivo de imagen
    let customImagePosition = null;
    let isPositioningMode = false;
    let watermarkImagePreview = null;
    
    // Sistema de historial para deshacer/rehacer
    const historyManager = {
      states: [],
      currentIndex: -1,
      maxStates: 20,
      
      saveState: function() {
        if (!canvas || !currentImage) return;
        
        // Remover estados futuros si estamos en medio del historial
        this.states = this.states.slice(0, this.currentIndex + 1);
        
        // Guardar estado actual
        const state = {
          imageData: canvas.toDataURL(),
          metadata: this.getCurrentMetadata(),
          watermarkConfig: this.getCurrentWatermarkConfig(),
          timestamp: Date.now()
        };
        
        this.states.push(state);
        this.currentIndex++;
        
        // Limitar el número de estados
        if (this.states.length > this.maxStates) {
          this.states.shift();
          this.currentIndex--;
        }
        
        this.updateUndoRedoButtons();
      },
      
      undo: function() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.restoreState(this.states[this.currentIndex]);
          this.updateUndoRedoButtons();
          UIManager.showSuccess('Acción deshecha');
        }
      },
      
      redo: function() {
        if (this.currentIndex < this.states.length - 1) {
          this.currentIndex++;
          this.restoreState(this.states[this.currentIndex]);
          this.updateUndoRedoButtons();
          UIManager.showSuccess('Acción rehecha');
        }
      },
      
      canUndo: function() {
        return this.currentIndex > 0;
      },
      
      canRedo: function() {
        return this.currentIndex < this.states.length - 1;
      },
      
      updateUndoRedoButtons: function() {
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        if (undoBtn) {
          undoBtn.disabled = !this.canUndo();
          undoBtn.style.opacity = this.canUndo() ? '1' : '0.5';
        }
        
        if (redoBtn) {
          redoBtn.disabled = !this.canRedo();
          redoBtn.style.opacity = this.canRedo() ? '1' : '0.5';
        }
      },
      
      getCurrentMetadata: function() {
        const form = document.getElementById('metadata-form');
        if (!form) return {};
        
        const formData = new FormData(form);
        return Object.fromEntries(formData);
      },
      
      getCurrentWatermarkConfig: function() {
        return {
          textEnabled: document.getElementById('watermark-text-enabled')?.checked || false,
          imageEnabled: document.getElementById('watermark-image-enabled')?.checked || false,
          text: document.getElementById('watermark-text')?.value || '',
          font: document.getElementById('watermark-font')?.value || 'Arial',
          color: document.getElementById('watermark-color')?.value || '#000000',
          size: document.getElementById('watermark-size')?.value || '24',
          opacity: document.getElementById('watermark-opacity')?.value || '50',
          position: document.getElementById('watermark-position')?.value || 'bottom-right',
          imageOpacity: document.getElementById('watermark-image-opacity')?.value || '50',
          imageSize: document.getElementById('watermark-image-size')?.value || 'medium',
          imagePosition: document.getElementById('watermark-image-position')?.value || 'bottom-right',
          customPosition: customImagePosition
        };
      },
      
      restoreState: function(state) {
        if (!state || !canvas) return;
        
        const img = new Image();
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          
          // Restaurar metadatos
          if (state.metadata) {
            const form = document.getElementById('metadata-form');
            if (form) {
              Object.entries(state.metadata).forEach(([key, value]) => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) field.value = value;
              });
            }
          }
          
          // Restaurar configuración de marca de agua
          if (state.watermarkConfig) {
            const config = state.watermarkConfig;
            Object.entries(config).forEach(([key, value]) => {
              const element = document.getElementById(`watermark-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
              if (element) {
                if (element.type === 'checkbox') {
                  element.checked = value;
                } else {
                  element.value = value;
                }
              }
            });
            
            if (config.customPosition) {
              customImagePosition = config.customPosition;
            }
          }
          
          toggleWatermarkType();
        };
        img.src = state.imageData;
      },
      
      clear: function() {
        this.states = [];
        this.currentIndex = -1;
        this.updateUndoRedoButtons();
      }
    };
    
    // Cache para optimización de rendimiento - MEJORADO
    const cache = {
      watermarkImage: null,
      lastWatermarkConfig: null,
      processedImages: new Map(),
      thumbnails: new Map(),
      
      // Configuración del cache
      maxSize: 50, // Máximo 50 imágenes en cache
      maxAge: 30 * 60 * 1000, // 30 minutos
      
      // Generar clave única para cache
      generateKey: function(config) {
        return JSON.stringify(config);
      },
      
      // Obtener del cache
      get: function(key) {
        const item = this.processedImages.get(key);
        if (!item) return null;
        
        // Verificar si ha expirado
        if (Date.now() - item.timestamp > this.maxAge) {
          this.processedImages.delete(key);
          return null;
        }
        
        // Actualizar timestamp (LRU)
        item.timestamp = Date.now();
        return item.data;
      },
      
      // Guardar en cache
      set: function(key, data) {
        // Limpiar cache si está lleno
        if (this.processedImages.size >= this.maxSize) {
          this.cleanOldest();
        }
        
        this.processedImages.set(key, {
          data: data,
          timestamp: Date.now(),
          size: this.estimateSize(data)
        });
      },
      
      // Limpiar entradas más antiguas
      cleanOldest: function() {
        let oldest = null;
        let oldestTime = Date.now();
        
        for (const [key, item] of this.processedImages.entries()) {
          if (item.timestamp < oldestTime) {
            oldestTime = item.timestamp;
            oldest = key;
          }
        }
        
        if (oldest) {
          this.processedImages.delete(oldest);
        }
      },
      
      // Estimar tamaño de datos
      estimateSize: function(data) {
        if (typeof data === 'string') {
          return data.length * 2; // UTF-16
        }
        return 1000; // Estimación por defecto
      },
      
      // Limpiar cache completo
      clear: function() {
        this.processedImages.clear();
        this.thumbnails.clear();
        this.watermarkImage = null;
        this.lastWatermarkConfig = null;
      },
      
      // Obtener estadísticas del cache
      getStats: function() {
        const totalSize = Array.from(this.processedImages.values())
          .reduce((sum, item) => sum + (item.size || 0), 0);
          
        return {
          entries: this.processedImages.size,
          totalSize: totalSize,
          maxSize: this.maxSize,
          hitRate: this.hitCount / (this.hitCount + this.missCount) || 0
        };
      }
    };

    // Debounce function para optimizar eventos
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Throttle function para eventos de alta frecuencia
    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    // Optimized preview update with debouncing
    const debouncedUpdatePreview = debounce(updatePreview, 100);

    // Utility functions
    const utils = {
      showLoading: (element) => {
        element.classList.add('loading');
      },
      
      hideLoading: (element) => {
        element.classList.remove('loading');
      },
      
      createProgressBar: (container) => {
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        const progressFill = document.createElement('div');
        progressFill.className = 'progress-fill';
        progressFill.style.width = '0%';
        progressBar.appendChild(progressFill);
        container.appendChild(progressBar);
        return progressFill;
      },
      
      updateProgress: (progressElement, percentage) => {
        progressElement.style.width = `${percentage}%`;
      },
      
      removeProgress: (container) => {
        const progressBar = container.querySelector('.progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupFileNaming();
      initializeTheme();
      
    });

    // Enhanced utility functions for better code maintainability
    const UIManager = {
      // Loading state management
      showLoadingState: function(message = 'Procesando...') {
        const existingLoader = document.querySelector('.global-loader');
        if (existingLoader) return;

        const loader = document.createElement('div');
        loader.className = 'global-loader';
        loader.innerHTML = `
          <div class="loader-content">
            <div class="loader-spinner"></div>
            <p class="loader-message">${SecurityManager.sanitizeText(message)}</p>
          </div>
        `;
        document.body.appendChild(loader);
      },

      hideLoadingState: function() {
        const loader = document.querySelector('.global-loader');
        if (loader) {
          loader.remove();
        }
      },

      // Enhanced error handling
      showError: function(message, duration = 5000) {
        this.hideError(); // Clear any existing error
        
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-toast';
        errorContainer.innerHTML = `
          <div class="error-content">
            <span class="error-icon">⚠️</span>
            <span class="error-message">${SecurityManager.sanitizeText(message)}</span>
            <button class="error-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;
        
        document.body.appendChild(errorContainer);
        
        // Auto-hide after duration
        if (duration > 0) {
          setTimeout(() => {
            if (errorContainer.parentNode) {
              errorContainer.remove();
            }
          }, duration);
        }
      },

      hideError: function() {
        const existingErrors = document.querySelectorAll('.error-toast');
        existingErrors.forEach(error => error.remove());
      },

      // Enhanced success messages
      showSuccess: function(message, duration = 3000) {
        const successContainer = document.createElement('div');
        successContainer.className = 'success-toast';
        successContainer.innerHTML = `
          <div class="success-content">
            <span class="success-icon">✅</span>
            <span class="success-message">${SecurityManager.sanitizeText(message)}</span>
            <button class="success-close" onclick="this.parentElement.parentElement.remove()">×</button>
          </div>
        `;
        
        document.body.appendChild(successContainer);
        
        // Auto-hide after duration
        setTimeout(() => {
          if (successContainer.parentNode) {
            successContainer.remove();
          }
        }, duration);
      },

      // Form state management
      setFormDisabled: function(formId, disabled) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const inputs = form.querySelectorAll('input, textarea, select, button');
        inputs.forEach(input => {
          input.disabled = disabled;
        });
        
        if (disabled) {
          form.classList.add('form-disabled');
        } else {
          form.classList.remove('form-disabled');
        }
      },

      // Debounced functions for performance
      debounce: function(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      // Throttled functions for performance
      throttle: function(func, limit) {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }
    };

    // Enhanced configuration management
    const AppConfig = {
      // File validation settings
      maxFileSize: 10 * 1024 * 1024, // 10MB
      allowedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
      
      // Canvas settings
      maxCanvasWidth: 800,
      maxCanvasHeight: 600,
      
      // Validation limits
      maxTextLength: {
        title: 100,
        author: 100,
        description: 500,
        keywords: 200,
        copyright: 200,
        watermarkText: 100
      },
      
      // Performance settings
      debounceDelay: 300,
      throttleDelay: 100,
      
      // UI settings
      animationDuration: 300,
      toastDuration: 3000,
      errorDuration: 5000
    };

    function initializeApp() {
      console.log('Aplicación cargada');
      
      try {
        // Obtener elementos del DOM
        canvas = document.getElementById('preview-canvas');
        if (!canvas) {
          throw new Error('Canvas element not found');
        }
        
        ctx = canvas.getContext('2d');
        if (!ctx) {
          throw new Error('Canvas context not available');
        }
        
        // Configurar event listeners
        setupEventListeners();
        
        // Configurar event listeners de filtros con delay para asegurar DOM
        setTimeout(() => {
          console.log('=== CONFIGURACIÓN TARDÍA DE FILTROS ===');
          setupFilterListeners();
        }, 500);
        
        // Configurar collapsibles
        setupCollapsibles();
        
        // Configurar validación en tiempo real
        setupFormValidation();
        
        // Configurar interceptores de errores globales
        setupGlobalErrorHandling();
        
        // Cargar metadatos guardados
        MetadataManager.loadSavedMetadata();
        
        // Initialize character counters
        initCharacterCounters();
        
        // Initialize rotation functionality
        initRotation();
        
        // Initialize zoom keyboard shortcuts
        initZoomKeyboardShortcuts();
        
        // Initialize mouse wheel zoom
        initMouseWheelZoom();
        
        // Initialize pan navigation
        initPanNavigation();
        
        // Initialize mobile responsive features
        initMobileFeatures();
        
        // Inicializar estado de marcas de agua
        setTimeout(() => {
          toggleWatermarkType();
          // Inicializar modo de posicionamiento
          togglePositioningMode();
          // Inicializar controles de salida
          initializeOutputControls();
        }, 100);
        
        console.log('Aplicación inicializada correctamente');
        
      } catch (error) {
        console.error('Error al inicializar la aplicación:', error);
        UIManager.showError('Error al inicializar la aplicación. Por favor, recarga la página.');
      }
    }

    // Global error handling setup
    function setupGlobalErrorHandling() {
      // Manejar errores no capturados
      window.addEventListener('error', function(event) {
        console.error('Error global capturado:', event.error);
        UIManager.showError('Ha ocurrido un error inesperado. Por favor, inténtalo de nuevo.');
      });

      // Manejar promesas rechazadas no capturadas
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Promesa rechazada no manejada:', event.reason);
        UIManager.showError('Error de procesamiento. Por favor, inténtalo de nuevo.');
        event.preventDefault();
      });
    }

    // Enhanced form validation setup
    function setupFormValidation() {
      // Validación para campos de metadatos
      FormValidator.setupRealTimeValidation('title', (value) => {
        if (value.length > 100) {
          return { valid: false, message: 'El título no puede exceder 100 caracteres' };
        }
        return { valid: true };
      });

      FormValidator.setupRealTimeValidation('author', (value) => {
        if (value.length > 100) {
          return { valid: false, message: 'El autor no puede exceder 100 caracteres' };
        }
        return { valid: true };
      });

      FormValidator.setupRealTimeValidation('description', (value) => {
        if (value.length > 500) {
          return { valid: false, message: 'La descripción no puede exceder 500 caracteres' };
        }
        return { valid: true };
      });

      FormValidator.setupRealTimeValidation('keywords', (value) => {
        if (value.length > 200) {
          return { valid: false, message: 'Las palabras clave no pueden exceder 200 caracteres' };
        }
        return { valid: true };
      });

      FormValidator.setupRealTimeValidation('copyright', (value) => {
        if (value.length > 200) {
          return { valid: false, message: 'El copyright no puede exceder 200 caracteres' };
        }
        return { valid: true };
      });

      // Validación para marca de agua de texto
      FormValidator.setupRealTimeValidation('watermark-text', (value) => {
        if (value.length > 100) {
          return { valid: false, message: 'El texto de marca de agua no puede exceder 100 caracteres' };
        }
        // Verificar caracteres especiales peligrosos
        if (/<script|javascript:|on\w+=/i.test(value)) {
          return { valid: false, message: 'El texto contiene caracteres no permitidos' };
        }
        return { valid: true };
      });

      // Validación para dimensiones personalizadas
      FormValidator.setupRealTimeValidation('watermark-image-width', (value) => {
        const num = parseInt(value);
        if (isNaN(num) || num < 10 || num > 2000) {
          return { valid: false, message: 'El ancho debe estar entre 10 y 2000 píxeles' };
        }
        return { valid: true };
      });

      FormValidator.setupRealTimeValidation('watermark-image-height', (value) => {
        const num = parseInt(value);
        if (isNaN(num) || num < 10 || num > 2000) {
          return { valid: false, message: 'La altura debe estar entre 10 y 2000 píxeles' };
        }
        return { valid: true };
      });

      // Validación para calidad de imagen
      FormValidator.setupRealTimeValidation('quality-number', (value) => {
        const num = parseInt(value);
        if (isNaN(num) || num < 1 || num > 100) {
          return { valid: false, message: 'La calidad debe estar entre 1% y 100%' };
        }
        return { valid: true };
      });
    }

    // Initialize output controls
    function initializeOutputControls() {
      try {
        // Initialize quality control
        const qualitySelect = document.getElementById('output-quality');
        const qualityNumber = document.getElementById('quality-number');
        
        if (qualitySelect && qualityNumber) {
          // Set default value
          qualitySelect.value = '80';
          qualityNumber.value = '80';
          handleQualityChange();
        }
        
        // Initialize format control
        const formatSelect = document.getElementById('output-format');
        if (formatSelect) {
          // Set default format based on original file or JPEG
          if (originalExtension && ['jpg', 'jpeg'].includes(originalExtension.toLowerCase())) {
            formatSelect.value = 'jpeg';
          } else if (originalExtension && ['png'].includes(originalExtension.toLowerCase())) {
            formatSelect.value = 'png';
          } else if (originalExtension && ['webp'].includes(originalExtension.toLowerCase())) {
            formatSelect.value = 'webp';
          } else if (originalExtension && ['avif'].includes(originalExtension.toLowerCase())) {
            formatSelect.value = 'avif';
          } else {
            formatSelect.value = 'jpeg'; // default fallback
          }
          handleFormatChange();
        }
        
        // Check format support and disable unsupported formats
        checkAndUpdateFormatSupport();
        
        console.log('Output controls initialized successfully');
      } catch (error) {
        console.error('Error initializing output controls:', error);
      }
    }

    // Check format support and update UI
    async function checkAndUpdateFormatSupport() {
      const formatSelect = document.getElementById('output-format');
      if (!formatSelect) return;
      
      const formats = ['webp', 'avif'];
      
      for (const format of formats) {
        const isSupported = await checkFormatSupport(format);
        const option = formatSelect.querySelector(`option[value="${format}"]`);
        
        if (option) {
          if (!isSupported) {
            option.disabled = true;
            option.textContent += ' (No soportado)';
            option.style.color = '#9ca3af';
          }
        }
      }
    }

    // Funciones del tema oscuro
    function initializeTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      
      // Cargar tema guardado o usar preferencia del sistema
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
      
      setTheme(currentTheme);
      
      // Escuchar cambios en las preferencias del sistema
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      });
    }

    function setTheme(theme) {
      console.log('SetTheme llamado con:', theme);
      const themeIcon = document.getElementById('theme-icon');
      const html = document.documentElement;
      
      if (theme === 'dark') {
        html.setAttribute('data-theme', 'dark');
        if (themeIcon) {
          themeIcon.className = 'fas fa-sun';
        }
        console.log('Tema oscuro aplicado');
      } else {
        html.removeAttribute('data-theme');
        if (themeIcon) {
          themeIcon.className = 'fas fa-moon';
        }
        console.log('Tema claro aplicado');
      }
      
      localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
      console.log('Toggle theme llamado');
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      console.log('Cambiando de', currentTheme, 'a', newTheme);
      setTheme(newTheme);
    }

    function setupFileNaming() {
      const titleInput = document.getElementById('metaTitle');
      const fileInput = document.getElementById('file-input');

      // Agregar funcionalidad para seleccionar todo el texto al hacer clic
      titleInput.addEventListener('click', function() {
        this.select();
      });

      // También seleccionar todo al recibir foco (tabulación)
      titleInput.addEventListener('focus', function() {
        this.select();
      });

      // Cuando se selecciona un archivo
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length) {
          currentFile = e.target.files[0];
          // Guardar la extensión original del archivo
          originalExtension = currentFile.name.split('.').pop().toLowerCase();
          
          // Obtener el nombre del archivo sin extensión
          const fileNameWithoutExtension = currentFile.name.replace(/\.[^/.]+$/, "");
          
          // Actualizar el placeholder del campo título
          titleInput.placeholder = fileNameWithoutExtension;
          
          // Establecer el título inicial como el nombre del archivo (sin extensión)
          if (!titleInput.value.trim()) {
            titleInput.value = fileNameWithoutExtension;
          }
        }
      });
    }

    // Enhanced Security and Validation Module
    const SecurityManager = {
      // Sanitización de texto para prevenir XSS
      sanitizeText: function(text) {
        if (typeof text !== 'string') return '';
        return text
          .replace(/[<>'"&]/g, function(match) {
            const entities = {
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#x27;',
              '&': '&amp;'
            };
            return entities[match];
          })
          .trim();
      },

      // Validación de entrada de texto
      validateTextInput: function(text, maxLength = 500) {
        if (!text || typeof text !== 'string') return false;
        const sanitized = this.sanitizeText(text);
        return sanitized.length <= maxLength && sanitized.length > 0;
      },

      // Validación de archivos de imagen
      validateImageFile: function(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/avif'];
        const maxSize = 25 * 1024 * 1024; // 25MB
        
        const validation = {
          isValid: true,
          errors: []
        };

        if (!file) {
          validation.isValid = false;
          validation.errors.push('No se ha seleccionado ningún archivo');
          return validation;
        }

        if (!allowedTypes.includes(file.type)) {
          validation.isValid = false;
          validation.errors.push('Formato de archivo no válido. Solo se permiten JPG, JPEG, PNG, WEBP y AVIF');
        }

        if (file.size > maxSize) {
          validation.isValid = false;
          validation.errors.push('El archivo es demasiado grande. El tamaño máximo es 25 MB');
        }

        // Validación adicional del nombre del archivo
        const fileName = file.name;
        if (fileName.length > 255) {
          validation.isValid = false;
          validation.errors.push('El nombre del archivo es demasiado largo');
        }

        // Verificar extensión del archivo
        const extension = fileName.split('.').pop().toLowerCase();
        const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'avif'];
        if (!allowedExtensions.includes(extension)) {
          validation.isValid = false;
          validation.errors.push('Extensión de archivo no válida');
        }

        return validation;
      },

      // Validación de metadatos
      validateMetadata: function(metadata) {
        const validation = {
          isValid: true,
          errors: {},
          sanitized: {}
        };

        const fields = {
          title: { maxLength: 100, required: false },
          author: { maxLength: 100, required: false },
          description: { maxLength: 500, required: false },
          keywords: { maxLength: 200, required: false },
          copyright: { maxLength: 200, required: false }
        };

        for (const [field, rules] of Object.entries(fields)) {
          const value = metadata[field] || '';
          const sanitized = this.sanitizeText(value);
          
          if (rules.required && !sanitized) {
            validation.isValid = false;
            validation.errors[field] = 'Este campo es obligatorio';
            continue;
          }

          if (sanitized.length > rules.maxLength) {
            validation.isValid = false;
            validation.errors[field] = `Máximo ${rules.maxLength} caracteres permitidos`;
            continue;
          }

          validation.sanitized[field] = sanitized;
        }

        return validation;
      },

      // Validación de marca de agua de texto
      validateWatermarkText: function(text, size, opacity) {
        const validation = {
          isValid: true,
          errors: []
        };

        if (!text || typeof text !== 'string') {
          validation.errors.push('El texto de la marca de agua es requerido');
          validation.isValid = false;
        } else {
          const sanitized = this.sanitizeText(text);
          if (sanitized.length > 100) {
            validation.errors.push('El texto de la marca de agua no puede exceder 100 caracteres');
            validation.isValid = false;
          }
        }

        const sizeNum = parseInt(size);
        if (isNaN(sizeNum) || sizeNum < 10 || sizeNum > 200) {
          validation.errors.push('El tamaño debe estar entre 10 y 200 píxeles');
          validation.isValid = false;
        }

        const opacityNum = parseInt(opacity);
        if (isNaN(opacityNum) || opacityNum < 0 || opacityNum > 100) {
          validation.errors.push('La opacidad debe estar entre 0 y 100');
          validation.isValid = false;
        }

        return validation;
      }
    };

    // Form Validation Manager
    const FormValidator = {
      // Mostrar errores de validación
      showFieldError: function(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        // Remover errores anteriores
        this.clearFieldError(fieldId);

        // Crear elemento de error
        const errorElement = document.createElement('div');
        errorElement.className = 'field-error';
        errorElement.textContent = message;
        errorElement.id = `${fieldId}-error`;

        // Insertar después del campo
        field.parentNode.insertBefore(errorElement, field.nextSibling);
        
        // Agregar clase de error al campo
        field.classList.add('field-invalid');
      },

      // Limpiar errores de campo
      clearFieldError: function(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);
        
        if (field) {
          field.classList.remove('field-invalid');
        }
        
        if (errorElement) {
          errorElement.remove();
        }
      },

      // Limpiar todos los errores del formulario
      clearFormErrors: function(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        const errorElements = form.querySelectorAll('.field-error');
        const invalidFields = form.querySelectorAll('.field-invalid');

        errorElements.forEach(el => el.remove());
        invalidFields.forEach(field => field.classList.remove('field-invalid'));
      },

      // Validación en tiempo real
      setupRealTimeValidation: function(fieldId, validator) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        const validateField = debounce(() => {
          const isValid = validator(field.value);
          if (!isValid.valid) {
            this.showFieldError(fieldId, isValid.message);
          } else {
            this.clearFieldError(fieldId);
          }
        }, 300);

        field.addEventListener('input', validateField);
        field.addEventListener('blur', validateField);
      }
    };

    // Función para sanitizar nombres de archivo - mejorada
    function sanitizeFilename(filename) {
      if (!filename || typeof filename !== 'string') return 'imagen_editada';
      
      return filename
        .toLowerCase()
        .replace(/[^\w\s.-]/g, '') // Solo permitir letras, números, espacios, puntos y guiones
        .replace(/\s+/g, '-')      // Reemplazar espacios con guiones
        .replace(/-+/g, '-')       // Eliminar guiones múltiples
        .replace(/^-+|-+$/g, '')   // Eliminar guiones al inicio y final
        .substring(0, 100)         // Limitar longitud
        .trim() || 'imagen_editada'; // Fallback si queda vacío
    }

    function setupEventListeners() {
      try {
        console.log('=== CONFIGURANDO EVENT LISTENERS ===');
        
        // Configurar listeners para controles de filtros
        console.log('Configurando event listeners para filtros...');
        ['brightness', 'contrast', 'saturation', 'blur'].forEach(filter => {
          const slider = document.getElementById(filter);
          console.log(`Slider ${filter}:`, slider ? 'encontrado' : 'NO encontrado');
          if (slider) {
            slider.addEventListener('input', (e) => {
              FilterManager.applyFilter(filter, parseInt(e.target.value));
            });
          }
        });
        
        // Configurar presets de filtros
        const presetButtons = document.querySelectorAll('.filter-preset');
        console.log(`Botones de presets encontrados: ${presetButtons.length}`);
        presetButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            console.log(`Aplicando preset: ${btn.dataset.filter}`);
            FilterManager.applyPreset(btn.dataset.filter);
          });
        });
        
        // Listener para reset de filtros
        const resetFiltersBtn = document.getElementById('resetFilters');
        if (resetFiltersBtn) {
          resetFiltersBtn.addEventListener('click', resetFilters);
        }
        
        // Listeners para metadatos y geolocalización
        const autocopyrightBtn = document.getElementById('autoCopyright');
        if (autocopyrightBtn) {
          autocopyrightBtn.addEventListener('click', generateAutoCopyright);
        }
        
        const getCurrentLocationBtn = document.getElementById('getCurrentLocation');
        if (getCurrentLocationBtn) {
          getCurrentLocationBtn.addEventListener('click', () => {
            MetadataManager.getCurrentLocation();
          });
        }
        
        // Auto-actualizar copyright cuando cambia el autor
        const authorInput = document.getElementById('metaAuthor');
        if (authorInput) {
          authorInput.addEventListener('blur', () => {
            const copyrightInput = document.getElementById('metaCopyright');
            if (authorInput.value && !copyrightInput.value) {
              // Solo generar automáticamente si no hay copyright ya escrito
              setTimeout(() => generateAutoCopyright(), 100);
            }
          });
        }
        
        // Upload de archivos con optimización
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileSelector = document.getElementById('file-selector');
        const removeFile = document.getElementById('remove-file');
        
        // Solo configurar si los elementos existen
        if (dropArea && fileInput && fileSelector && removeFile) {
          // Simplified drag and drop without throttling for testing
          dropArea.addEventListener('dragover', handleDragOver);
          dropArea.addEventListener('dragleave', handleDragLeave);
          dropArea.addEventListener('drop', handleDrop);
          
          // Enhanced file selector
          fileSelector.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', handleFileSelect);
          removeFile.addEventListener('click', removeSelectedFile);
        }
        
        // Form submissions with loading states
        const metadataForm = document.getElementById('metadata-form');
        const watermarkForm = document.getElementById('watermark-form');
        
        if (metadataForm) {
          metadataForm.addEventListener('submit', handleMetadataSubmit);
        }
        
        if (watermarkForm) {
          watermarkForm.addEventListener('submit', handleWatermarkSubmit);
        }

        // Zoom controls
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        const zoomLevel = document.getElementById('zoom-level');

        if (zoomInBtn && zoomOutBtn && zoomResetBtn) {
          zoomInBtn.addEventListener('click', zoomIn);
          zoomOutBtn.addEventListener('click', zoomOut);
          zoomResetBtn.addEventListener('click', resetZoom);
        }
        
        // Watermark type toggle
        const textEnabledCheckbox = document.getElementById('watermark-text-enabled');
        const imageEnabledCheckbox = document.getElementById('watermark-image-enabled');
        
        if (textEnabledCheckbox) {
          textEnabledCheckbox.addEventListener('change', toggleWatermarkType);
        }
        
        if (imageEnabledCheckbox) {
          imageEnabledCheckbox.addEventListener('change', toggleWatermarkType);
        }
        
        // Custom image size toggle
        const watermarkImageSize = document.getElementById('watermark-image-size');
        if (watermarkImageSize) {
          watermarkImageSize.addEventListener('change', toggleCustomImageSize);
        }
        
        // Real-time controls with debouncing for better performance - con verificación de existencia
        const controls = [
          { id: 'watermark-text-enabled', event: 'change' },
          { id: 'watermark-image-enabled', event: 'change' },
          { id: 'watermark-text', event: 'input' },
          { id: 'watermark-font', event: 'change' },
          { id: 'watermark-color', event: 'change' },
          { id: 'watermark-size', event: 'input' },
          { id: 'watermark-opacity', event: 'input' },
          { id: 'watermark-position', event: 'change' },
          { id: 'watermark-image-size', event: 'change' },
          { id: 'watermark-image-opacity', event: 'input' },
          { id: 'watermark-image-position', event: 'change' },
          { id: 'watermark-image-width', event: 'input' },
          { id: 'watermark-image-height', event: 'input' }
        ];
        
        controls.forEach(({ id, event }) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener(event, debouncedUpdatePreview);
          }
        });
        
        // Posicionamiento personalizado para imagen
        const watermarkImagePosition = document.getElementById('watermark-image-position');
        if (watermarkImagePosition) {
          watermarkImagePosition.addEventListener('change', togglePositioningMode);
        }
        
        // Event listener para el canvas en modo posicionamiento
        if (canvas) {
          canvas.addEventListener('click', handleCanvasClick);
        }
        
        // Image watermark controls
        const watermarkImage = document.getElementById('watermark-image');
        if (watermarkImage) {
          watermarkImage.addEventListener('change', handleWatermarkImageChange);
        }
        
        // Action buttons
        const resetChangesBtn = document.getElementById('reset-changes');
        const downloadImageBtn = document.getElementById('download-image');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        if (resetChangesBtn) {
          resetChangesBtn.addEventListener('click', resetChanges);
        }
        
        if (downloadImageBtn) {
          downloadImageBtn.addEventListener('click', downloadImageWithProgress);
        }
        
        if (undoBtn) {
          undoBtn.addEventListener('click', () => historyManager.undo());
        }
        
        if (redoBtn) {
          redoBtn.addEventListener('click', () => historyManager.redo());
        }
        
        // Compare and fullscreen buttons
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        console.log('Botón fullscreen encontrado:', fullscreenBtn);
        
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', toggleFullscreen);
        }
        
        // Theme toggle button - CRÍTICO PARA EL MODO OSCURO
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', toggleTheme);
          console.log('Event listener del tema configurado correctamente');
        } else {
          console.error('Botón de tema no encontrado');
        }
        
        // Output configuration controls
        const outputQualitySelect = document.getElementById('output-quality');
        const outputQualityNumber = document.getElementById('quality-number');
        const outputFormatSelect = document.getElementById('output-format');
        const outputHeader = document.getElementById('output-header');
        
        if (outputQualitySelect) {
          outputQualitySelect.addEventListener('input', handleQualityChange);
          outputQualitySelect.addEventListener('change', handleQualityChange);
        }
        
        if (outputQualityNumber) {
          outputQualityNumber.addEventListener('input', handleQualityNumberChange);
          outputQualityNumber.addEventListener('change', handleQualityNumberChange);
          outputQualityNumber.addEventListener('blur', handleQualityNumberChange);
          // Handle Enter key
          outputQualityNumber.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.target.blur();
            }
          });
        }
        
        if (outputFormatSelect) {
          outputFormatSelect.addEventListener('change', handleFormatChange);
        }
        
        if (outputHeader) {
          outputHeader.addEventListener('click', () => toggleCollapsible('output'));
          outputHeader.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              toggleCollapsible('output');
            }
          });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
        
      } catch (error) {
        console.error('Error configurando event listeners:', error);
      }
    }

    // Configurar listeners de filtros con retraso para asegurar que el DOM esté listo
    function setupFilterListeners() {
      console.log('🔧 Configurando listeners de filtros...');
      
      // Listeners para los sliders de filtros
      const filterSliders = ['brightness', 'contrast', 'saturation', 'blur'];
      filterSliders.forEach(filterId => {
        const slider = document.getElementById(filterId);
        const valueDisplay = document.getElementById(filterId + 'Value');
        
        if (slider && valueDisplay) {
          console.log(`✅ Configurando listener para ${filterId}`);
          slider.addEventListener('input', (e) => {
            const value = e.target.value;
            valueDisplay.textContent = value;
            console.log(`🎚️ ${filterId} cambiado a: ${value}`);
            
            if (typeof FilterManager !== 'undefined' && FilterManager.applyFilter) {
              FilterManager.applyFilter();
            } else {
              console.warn('❌ FilterManager no está disponible');
            }
          });
        } else {
          console.warn(`❌ No se encontró elemento para ${filterId}`);
        }
      });
      
      // Listeners para los botones de presets
      const presetButtons = document.querySelectorAll('.preset-btn');
      console.log(`🎯 Configurando ${presetButtons.length} botones de preset`);
      
      presetButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const preset = e.target.dataset.preset;
          console.log(`🎨 Aplicando preset: ${preset}`);
          
          if (typeof FilterManager !== 'undefined' && FilterManager.applyPreset) {
            FilterManager.applyPreset(preset);
          } else {
            console.warn('❌ FilterManager no está disponible para preset');
          }
        });
      });
      
      // Listener para el botón de reset
      const resetBtn = document.getElementById('resetFilters');
      if (resetBtn) {
        console.log('🔄 Configurando botón de reset de filtros');
        resetBtn.addEventListener('click', () => {
          console.log('🧹 Reseteando filtros');
          if (typeof FilterManager !== 'undefined' && FilterManager.reset) {
            FilterManager.reset();
          } else {
            console.warn('❌ FilterManager no está disponible para reset');
          }
        });
      }
    }

    function handleWatermarkImageChange() {
      // Clear cache when new image is selected
      cache.watermarkImage = null;
      cache.lastWatermarkConfig = null;
      debouncedUpdatePreview();
    }

    // Output configuration handlers
    function handleQualityChange() {
      const qualitySelect = document.getElementById('output-quality');
      const qualityNumber = document.getElementById('quality-number');
      const qualityPercentage = document.getElementById('quality-percentage');
      const qualityBar = document.getElementById('quality-bar');
      
      if (!qualitySelect || !qualityNumber || !qualityPercentage || !qualityBar) return;
      
      const qualityValue = parseInt(qualitySelect.value);
      outputQuality = qualityValue / 100;
      
      // Sync the number input with slider
      qualityNumber.value = qualityValue;
      
      // Update percentage display
      qualityPercentage.textContent = qualityValue + '%';
      
      // Update progress bar with smooth animation
      qualityBar.style.width = qualityValue + '%';
      
      // Update color based on quality with more nuanced ranges
      if (qualityValue <= 30) {
        qualityPercentage.className = 'text-sm font-bold text-red-600';
      } else if (qualityValue <= 50) {
        qualityPercentage.className = 'text-sm font-bold text-orange-600';
      } else if (qualityValue <= 70) {
        qualityPercentage.className = 'text-sm font-bold text-yellow-600';
      } else if (qualityValue <= 85) {
        qualityPercentage.className = 'text-sm font-bold text-blue-600';
      } else {
        qualityPercentage.className = 'text-sm font-bold text-green-600';
      }
      
      // Update the slider track color dynamically
      updateSliderBackground(qualityValue);
      
      console.log('Quality changed to:', qualityValue + '%');
    }

    function handleQualityNumberChange() {
      const qualitySelect = document.getElementById('output-quality');
      const qualityNumber = document.getElementById('quality-number');
      
      if (!qualitySelect || !qualityNumber) return;
      
      let qualityValue = parseInt(qualityNumber.value);
      
      // Validate and constrain the value
      if (isNaN(qualityValue) || qualityValue < 1) {
        qualityValue = 1;
      } else if (qualityValue > 100) {
        qualityValue = 100;
      }
      
      // Update both inputs
      qualityNumber.value = qualityValue;
      qualitySelect.value = qualityValue;
      
      // Trigger the main quality change handler
      handleQualityChange();
    }

    function updateSliderBackground(value) {
      const slider = document.getElementById('output-quality');
      if (!slider) return;
      
      // Create a dynamic gradient based on the current value
      const percentage = value / 100;
      const hue1 = 0;   // Red
      const hue2 = 45;  // Orange/Yellow  
      const hue3 = 120; // Green
      
      let currentHue;
      if (percentage <= 0.5) {
        // Interpolate between red and yellow
        currentHue = hue1 + (hue2 - hue1) * (percentage * 2);
      } else {
        // Interpolate between yellow and green
        currentHue = hue2 + (hue3 - hue2) * ((percentage - 0.5) * 2);
      }
      
      const saturation = 70;
      const lightness = 55;
      
      // Update CSS custom property for dynamic coloring
      slider.style.setProperty('--slider-color', `hsl(${currentHue}, ${saturation}%, ${lightness}%)`);
    }

    function handleFormatChange() {
      const formatSelect = document.getElementById('output-format');
      const formatInfo = document.getElementById('format-info');
      const formatTitle = document.getElementById('format-title');
      const formatDescription = document.getElementById('format-description');
      const formatCompatibility = document.getElementById('format-compatibility');
      
      if (!formatSelect || !formatInfo || !formatTitle || !formatDescription || !formatCompatibility) return;
      
      outputFormat = formatSelect.value;
      
      // Remove previous format classes
      formatInfo.className = formatInfo.className.replace(/format-\w+/g, '');
      formatInfo.classList.add('p-3', 'border', 'rounded-md', `format-${outputFormat}`);
      
      // Update format information
      const formatData = getFormatInfo(outputFormat);
      formatTitle.textContent = formatData.title;
      formatDescription.textContent = formatData.description;
      formatCompatibility.textContent = formatData.compatibility;
      formatCompatibility.className = `text-xs mt-1 font-medium ${formatData.compatibilityClass}`;
      
      console.log('Format changed to:', outputFormat);
    }

    function getFormatInfo(format) {
      const formatInfo = {
        jpeg: {
          title: 'JPEG (.jpg)',
          description: 'Ideal para fotografías, menor tamaño de archivo.',
          compatibility: '✓ Compatible con todos los navegadores',
          compatibilityClass: 'text-green-600'
        },
        png: {
          title: 'PNG (.png)',
          description: 'Ideal para imágenes con transparencia, sin pérdida de calidad.',
          compatibility: '✓ Compatible con todos los navegadores',
          compatibilityClass: 'text-green-600'
        },
        webp: {
          title: 'WebP (.webp)',
          description: 'Mejor compresión que JPEG/PNG, menor tamaño de archivo.',
          compatibility: '✓ Compatible con navegadores modernos (95%+)',
          compatibilityClass: 'text-blue-600'
        },
        avif: {
          title: 'AVIF (.avif)',
          description: 'Nueva generación, máxima compresión y calidad.',
          compatibility: '⚠ Compatible con navegadores recientes (80%+)',
          compatibilityClass: 'text-orange-600'
        }
      };
      
      return formatInfo[format] || formatInfo.jpeg;
    }

    // Function to check format support
    function checkFormatSupport(format) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 1;
        canvas.height = 1;
        
        try {
          const mimeType = `image/${format}`;
          canvas.toBlob((blob) => {
            resolve(blob !== null);
          }, mimeType, 1);
        } catch (error) {
          resolve(false);
        }
        
        // Timeout fallback
        setTimeout(() => resolve(false), 100);
      });
    }

    function handleKeyboardShortcuts(e) {
      // Ctrl+S or Cmd+S to download
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (canvas && currentImage) {
          downloadImage();
        }
      }
      
      // Ctrl+Z or Cmd+Z to undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        if (historyManager.canUndo()) {
          historyManager.undo();
        }
      }
      
      // Ctrl+Y or Cmd+Y or Ctrl+Shift+Z to redo
      if (((e.ctrlKey || e.metaKey) && e.key === 'y') || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
        e.preventDefault();
        if (historyManager.canRedo()) {
          historyManager.redo();
        }
      }
      
      // Ctrl+R or Cmd+R to reset (prevent page reload)
      if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        if (currentImage) {
          resetChanges();
        }
      }
      
      // Escape to close any modals or reset focus
      if (e.key === 'Escape') {
        document.activeElement.blur();
      }
    }

    function setupCollapsibles() {
      const metadataHeader = document.getElementById('metadata-header');
      const watermarkHeader = document.getElementById('watermark-header');
      
      metadataHeader.addEventListener('click', () => toggleCollapsible('metadata'));
      watermarkHeader.addEventListener('click', () => toggleCollapsible('watermark'));
      
      metadataHeader.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleCollapsible('metadata');
        }
      });
      
      watermarkHeader.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleCollapsible('watermark');
        }
      });
    }

    function toggleCollapsible(section) {
      const header = document.getElementById(`${section}-header`);
      const content = document.getElementById(`${section}-content`);
      const icon = header.querySelector('.section__icon');
      
      const isOpen = content.classList.contains('section__content--open');
      
      if (isOpen) {
        content.classList.remove('section__content--open');
        icon.classList.add('section__icon--collapsed');
        header.setAttribute('aria-expanded', 'false');
        content.setAttribute('aria-hidden', 'true');
      } else {
        content.classList.add('section__content--open');
        icon.classList.remove('section__icon--collapsed');
        header.setAttribute('aria-expanded', 'true');
        content.setAttribute('aria-hidden', 'false');
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      document.getElementById('drop-area').classList.add('upload__dropzone--active');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      document.getElementById('drop-area').classList.remove('upload__dropzone--active');
    }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('drop-area').classList.remove('upload__dropzone--active');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    // Enhanced file handling with security validation
    function handleFile(file) {
      // Limpiar errores anteriores
      UIManager.hideError();
      
      // Validación completa del archivo
      const validation = SecurityManager.validateImageFile(file);
      
      if (!validation.isValid) {
        validation.errors.forEach(error => UIManager.showError(error));
        return;
      }

      // Mostrar estado de carga
      UIManager.showLoadingState('Procesando archivo...');

      // Guardar información del archivo
      currentFile = file;
      const fileExtension = file.name.split('.').pop().toLowerCase();
      originalExtension = fileExtension;
      
      // Verificación adicional del tipo MIME vs extensión
      const mimeToExt = {
        'image/jpeg': ['jpg', 'jpeg'],
        'image/png': ['png'],
        'image/webp': ['webp'],
        'image/avif': ['avif']
      };
      
      const allowedExtensionsForMime = mimeToExt[file.type];
      if (!allowedExtensionsForMime || !allowedExtensionsForMime.includes(fileExtension)) {
        UIManager.hideLoadingState();
        UIManager.showError('La extensión del archivo no coincide con su tipo');
        return;
      }

      // Leer archivo con manejo de errores mejorado
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          loadImage(e.target.result, file.name);
        } catch (error) {
          UIManager.hideLoadingState();
          console.error('Error al procesar la imagen:', error);
          UIManager.showError('Error al procesar la imagen. Por favor, inténtalo de nuevo.');
        }
      };
      
      reader.onerror = function() {
        UIManager.hideLoadingState();
        UIManager.showError('Error al leer el archivo. Por favor, inténtalo de nuevo.');
      };
      
      reader.readAsDataURL(file);
    }

    // Enhanced image loading with validation
    function loadImage(src, fileName) {
      const img = new Image();
      
      img.onload = function() {
        try {
          // Validar dimensiones de la imagen
          if (img.width < 1 || img.height < 1) {
            UIManager.hideLoadingState();
            UIManager.showError('La imagen no tiene dimensiones válidas');
            return;
          }

          // Validar dimensiones máximas (opcional)
          const maxDimension = 8192; // 8K máximo
          if (img.width > maxDimension || img.height > maxDimension) {
            UIManager.hideLoadingState();
            UIManager.showError(`Las dimensiones de la imagen son demasiado grandes. Máximo ${maxDimension}x${maxDimension} píxeles.`);
            return;
          }

          currentImage = img;
          
          // Store original dimensions for resize functionality
          originalWidth = img.width;
          originalHeight = img.height;
          
          // Reset rotation state when loading new image
          currentRotation = 0;
          isFlippedHorizontally = false;
          isFlippedVertically = false;
          
          console.log('=== IMAGEN CARGADA ===');
          console.log('currentImage asignado:', !!currentImage);
          console.log('Dimensiones originales:', originalWidth, 'x', originalHeight);
          
          // Sanitizar y mostrar información del archivo
          const sanitizedFileName = SecurityManager.sanitizeText(fileName);
          const fileNameElement = document.getElementById('file-name');
          const fileInfoElement = document.getElementById('file-info');
          
          if (fileNameElement) {
            fileNameElement.textContent = sanitizedFileName;
          }
          
          if (fileInfoElement) {
            fileInfoElement.classList.remove('file-info--hidden');
          }
          
          // Establecer título inicial si está vacío
          const titleInput = document.getElementById('metaTitle');
          if (titleInput && !titleInput.value.trim()) {
            const nameWithoutExt = sanitizedFileName.replace(/\.[^/.]+$/, "");
            titleInput.value = SecurityManager.sanitizeText(nameWithoutExt);
            titleInput.placeholder = nameWithoutExt;
          }
          
          // Mostrar editor
          const editorContainer = document.getElementById('editor-container');
          if (editorContainer) {
            editorContainer.classList.remove('editor-container--hidden');
          }
          
          // Mostrar controles de zoom
          const zoomControls = document.getElementById('zoom-controls');
          if (zoomControls) {
            zoomControls.classList.remove('hidden');
          }
          
          // Configurar canvas
          setupCanvas();
          
          // Initialize zoom
          currentZoom = 1.0;
          isZoomed = false;
          resetPan(); // Reset pan también
          updateZoomLevel();
          
          // Mostrar información de la imagen
          updateImageInfo();
          
          // Initialize resize functionality
          initResize();
          
          // Update resize inputs with original dimensions
          const widthInput = document.getElementById('resize-width');
          const heightInput = document.getElementById('resize-height');
          if (widthInput) widthInput.value = originalWidth;
          if (heightInput) heightInput.value = originalHeight;
          
          // Update rotation display
          updateRotationDisplay();
          
          // Actualizar vista previa
          updatePreview();
          
          // Limpiar estado de carga
          UIManager.hideLoadingState();
          
          // Inicializar historial con estado inicial
          setTimeout(() => {
            historyManager.clear();
            historyManager.saveState();
          }, 100);
          
        } catch (error) {
          UIManager.hideLoadingState();
          console.error('Error al configurar la imagen:', error);
          UIManager.showError('Error al configurar la imagen. Por favor, inténtalo de nuevo.');
        }
      };
      
      img.onerror = function() {
        UIManager.hideLoadingState();
        UIManager.showError('Error al cargar la imagen. El archivo puede estar corrupto.');
      };
      
      // Timeout para imágenes que no cargan
      const timeout = setTimeout(() => {
        if (!img.complete) {
          UIManager.hideLoadingState();
          UIManager.showError('La carga de la imagen está tomando demasiado tiempo. Por favor, inténtalo de nuevo.');
        }
      }, 10000);
      
      // Limpiar timeout cuando la imagen se carga exitosamente
      const originalOnload = img.onload;
      img.onload = function() {
        clearTimeout(timeout);
        originalOnload.call(this);
      };

      img.src = src;
    }

    function setupCanvas() {
      if (!currentImage) return;
      
      // Ajustar dimensiones máximas según el tamaño de pantalla
      let maxWidth = 800;
      let maxHeight = 600;
      
      // Para pantallas pequeñas, ajustar los límites
      if (window.innerWidth <= 480) {
        maxWidth = Math.min(window.innerWidth - 32, 400); // 32px de padding
        maxHeight = Math.min(window.innerHeight * 0.6, 400); // 60% de altura de ventana
      } else if (window.innerWidth <= 768) {
        maxWidth = Math.min(window.innerWidth - 48, 600); // 48px de padding
        maxHeight = Math.min(window.innerHeight * 0.7, 500);
      }
      
      let { width, height } = currentImage;
      
      // Calcular nuevas dimensiones manteniendo proporción
      if (width > maxWidth || height > maxHeight) {
        const ratio = Math.min(maxWidth / width, maxHeight / height);
        width *= ratio;
        height *= ratio;
      }
      
      canvas.width = width;
      canvas.height = height;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      
      // Asegurar que el canvas mantenga sus proporciones
      canvas.style.objectFit = 'contain';
      canvas.style.maxWidth = '100%';
      canvas.style.height = 'auto';
      
      // Configurar zoom con rueda del ratón en el canvas
      canvas.addEventListener('wheel', function(e) {
        if (!currentImage) return;
        e.preventDefault();
        
        const delta = e.deltaY;
        if (delta < 0) {
          zoomInWheel();
        } else if (delta > 0) {
          zoomOutWheel();
        }
      }, { passive: false });
    }

    function updatePreview() {
      if (!currentImage || !ctx) return;
      
      // Performance optimization: requestAnimationFrame for smooth rendering
      requestAnimationFrame(() => {
        // Clear canvas with optimized method
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw image with better quality
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
        
        // Apply watermark with caching
        applyWatermarkOptimized();
        
        // Aplicar filtros CSS al canvas
        applyCanvasFilters();
        
        // Save state to history (debounced)
        if (typeof debouncedSaveHistory === 'undefined') {
          window.debouncedSaveHistory = UIManager.debounce(() => {
            historyManager.saveState();
          }, 1000);
        }
        debouncedSaveHistory();
      });
    }

    function applyWatermarkOptimized() {
      const textEnabled = document.getElementById('watermark-text-enabled').checked;
      const imageEnabled = document.getElementById('watermark-image-enabled').checked;
      
      // Aplicar marca de agua de texto si está habilitada
      if (textEnabled) {
        applyTextWatermarkOptimized();
      }
      
      // Aplicar marca de agua de imagen si está habilitada
      if (imageEnabled) {
        applyImageWatermarkOptimized();
      }
    }

    function applyTextWatermarkOptimized() {
      const text = document.getElementById('watermark-text').value.trim();
      if (!text) return;
      
      const font = document.getElementById('watermark-font').value;
      const color = document.getElementById('watermark-color').value;
      const size = parseInt(document.getElementById('watermark-size').value);
      const opacity = parseInt(document.getElementById('watermark-opacity').value) / 100;
      const position = document.getElementById('watermark-position').value;
      
      // Cache font configuration for better performance
      const fontConfig = `${size}px ${font}`;
      ctx.font = fontConfig;
      ctx.fillStyle = color;
      ctx.globalAlpha = opacity;
      
      // Add text shadow for better visibility
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 2;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      
      // Calculate position with better precision
      const textMetrics = ctx.measureText(text);
      const textWidth = textMetrics.width;
      const textHeight = size;
      
      const positions = getWatermarkPosition(position, textWidth, textHeight);
      
      // Draw text with enhanced quality
      ctx.fillText(text, positions.x, positions.y);
      
      // Reset shadow and opacity
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      ctx.globalAlpha = 1;
    }

    function applyImageWatermarkOptimized() {
      const watermarkImageInput = document.getElementById('watermark-image');
      if (!watermarkImageInput.files[0]) return;
      
      // Use cached image if available and configuration hasn't changed
      const currentConfig = {
        file: watermarkImageInput.files[0],
        opacity: document.getElementById('watermark-image-opacity').value,
        size: document.getElementById('watermark-image-size').value,
        position: document.getElementById('watermark-image-position').value,
        width: document.getElementById('watermark-image-width').value,
        height: document.getElementById('watermark-image-height').value,
        customPosition: customImagePosition ? JSON.stringify(customImagePosition) : null
      };
      
      const configChanged = !cache.lastWatermarkConfig || 
        JSON.stringify(currentConfig) !== JSON.stringify(cache.lastWatermarkConfig);
      
      if (cache.watermarkImage && !configChanged) {
        drawCachedWatermark(cache.watermarkImage, currentConfig);
        return;
      }
      
      // Load new watermark image
      const reader = new FileReader();
      reader.onload = function(e) {
        const watermarkImg = new Image();
        watermarkImg.onload = function() {
          // Guardar imagen para referencia en el posicionamiento
          watermarkImagePreview = watermarkImg;
          cache.watermarkImage = watermarkImg;
          cache.lastWatermarkConfig = currentConfig;
          drawCachedWatermark(watermarkImg, currentConfig);
        };
        watermarkImg.src = e.target.result;
      };
      reader.readAsDataURL(watermarkImageInput.files[0]);
    }

    function drawCachedWatermark(watermarkImg, config) {
      const opacity = parseInt(config.opacity) / 100;
      const sizeOption = config.size;
      const position = config.position;
      
      // Calculate size with caching
      let { width, height } = calculateWatermarkImageSize(watermarkImg, sizeOption);
      
      // Calculate position usando la función específica para imagen
      const positions = getImageWatermarkPosition(position, width, height);
      
      // Draw image with enhanced quality and shadow
      ctx.globalAlpha = opacity;
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
      
      ctx.drawImage(watermarkImg, positions.x, positions.y, width, height);
      
      // Reset effects
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      ctx.globalAlpha = 1;
    }

    function calculateWatermarkImageSize(img, sizeOption) {
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      let width, height;
      
      switch (sizeOption) {
        case 'small':
          width = Math.min(img.width, canvasWidth * 0.15);
          height = (width / img.width) * img.height;
          break;
        case 'medium':
          width = Math.min(img.width, canvasWidth * 0.25);
          height = (width / img.width) * img.height;
          break;
        case 'large':
          width = Math.min(img.width, canvasWidth * 0.4);
          height = (width / img.width) * img.height;
          break;
        case 'custom':
          width = parseInt(document.getElementById('watermark-image-width').value) || 100;
          height = parseInt(document.getElementById('watermark-image-height').value) || 100;
          break;
        default:
          width = img.width;
          height = img.height;
      }
      
      return { width, height };
    }

    function getWatermarkPosition(position, width, height) {
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      const margin = 20;
      
      let x, y;
      
      switch (position) {
        case 'top-left':
          x = margin;
          y = margin + height;
          break;
        case 'top-center':
          x = (canvasWidth - width) / 2;
          y = margin + height;
          break;
        case 'top-right':
          x = canvasWidth - width - margin;
          y = margin + height;
          break;
        case 'center-left':
          x = margin;
          y = (canvasHeight + height) / 2;
          break;
        case 'center':
          x = (canvasWidth - width) / 2;
          y = (canvasHeight + height) / 2;
          break;
        case 'center-right':
          x = canvasWidth - width - margin;
          y = (canvasHeight + height) / 2;
          break;
        case 'bottom-left':
          x = margin;
          y = canvasHeight - margin;
          break;
        case 'bottom-center':
          x = (canvasWidth - width) / 2;
          y = canvasHeight - margin;
          break;
        case 'bottom-right':
          x = canvasWidth - width - margin;
          y = canvasHeight - margin;
          break;
        default:
          x = margin;
          y = margin + height;
      }
      
      return { x, y };
    }

    function getImageWatermarkPosition(position, width, height) {
      // Si es posición personalizada, usar las coordenadas del clic
      if (position === 'custom' && customImagePosition) {
        return {
          x: customImagePosition.x - width / 2,
          y: customImagePosition.y - height / 2
        };
      }
      
      // Si no, usar la función estándar
      return getWatermarkPosition(position, width, height);
    }

    function toggleWatermarkType() {
      const textOptions = document.getElementById('text-watermark-options');
      const imageOptions = document.getElementById('image-watermark-options');
      const textEnabled = document.getElementById('watermark-text-enabled').checked;
      const imageEnabled = document.getElementById('watermark-image-enabled').checked;
      
      // Mostrar/ocultar opciones de texto
      if (textEnabled) {
        textOptions.classList.remove('watermark-options__text--hidden');
        textOptions.classList.add('watermark-options__text');
      } else {
        textOptions.classList.remove('watermark-options__text');
        textOptions.classList.add('watermark-options__text--hidden');
      }
      
      // Mostrar/ocultar opciones de imagen
      if (imageEnabled) {
        imageOptions.classList.remove('watermark-options__image');
        imageOptions.classList.add('watermark-options__image--visible');
      } else {
        imageOptions.classList.remove('watermark-options__image--visible');
        imageOptions.classList.add('watermark-options__image');
      }
      
      updatePreview();
    }

    function toggleCustomImageSize() {
      const sizeSelect = document.getElementById('watermark-image-size');
      const customSizeDiv = document.getElementById('watermark-image-custom-size');
      
      if (sizeSelect.value === 'custom') {
        customSizeDiv.classList.add('watermark-options__custom-size--visible');
        customSizeDiv.classList.remove('watermark-options__custom-size');
      } else {
        customSizeDiv.classList.remove('watermark-options__custom-size--visible');
        customSizeDiv.classList.add('watermark-options__custom-size');
      }
      
      updatePreview();
    }

    // Funciones para posicionamiento personalizado de imagen
    function togglePositioningMode() {
      const positionSelect = document.getElementById('watermark-image-position');
      const customInfo = document.getElementById('custom-position-info');
      
      if (positionSelect.value === 'custom') {
        isPositioningMode = true;
        customInfo.style.display = 'block';
        
        // Agregar clase al canvas para el cursor
        if (canvas) {
          canvas.classList.add('positioning-mode');
        }
        
        // Si ya hay una posición personalizada, mostrar el marcador
        if (customImagePosition) {
          showPositionMarker();
        }
      } else {
        isPositioningMode = false;
        customInfo.style.display = 'none';
        customImagePosition = null;
        
        // Quitar clase del canvas
        if (canvas) {
          canvas.classList.remove('positioning-mode');
        }
        
        // Quitar marcador si existe
        removePositionMarker();
      }
      
      debouncedUpdatePreview();
    }

    function handleCanvasClick(event) {
      if (!isPositioningMode || !watermarkImagePreview) return;
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      const x = (event.clientX - rect.left) * scaleX;
      const y = (event.clientY - rect.top) * scaleY;
      
      // Guardar la posición personalizada
      customImagePosition = { x, y };
      
      // Mostrar marcador visual
      showPositionMarker();
      
      // Actualizar vista previa
      updatePreview();
      
      UIManager.showSuccess('Posición de marca de agua actualizada');
    }

    function showPositionMarker() {
      if (!customImagePosition || !canvas) return;
      
      // Quitar marcador anterior si existe
      removePositionMarker();
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = rect.width / canvas.width;
      const scaleY = rect.height / canvas.height;
      
      const marker = document.createElement('div');
      marker.className = 'custom-position-marker';
      marker.id = 'position-marker';
      
      const displayX = customImagePosition.x * scaleX;
      const displayY = customImagePosition.y * scaleY;
      
      marker.style.left = displayX + 'px';
      marker.style.top = displayY + 'px';
      
      // Agregar al contenedor del canvas
      const container = canvas.parentElement;
      container.style.position = 'relative';
      container.appendChild(marker);
    }

    function removePositionMarker() {
      const marker = document.getElementById('position-marker');
      if (marker) {
        marker.remove();
      }
    }

    // Enhanced metadata form handler with validation
    function handleMetadataSubmit(e) {
      e.preventDefault();
      
      if (!currentImage) {
        showError('Por favor, selecciona una imagen primero.');
        return;
      }

      const form = e.target;
      
      // Limpiar errores anteriores
      FormValidator.clearFormErrors('metadata-form');
      
      // Mostrar estado de carga
      form.classList.add('form-loading');

      try {
        // Recopilar datos del formulario
        const formData = new FormData(form);
        const metadata = Object.fromEntries(formData);
        
        // Validar metadatos
        const validation = SecurityManager.validateMetadata(metadata);
        
        if (!validation.isValid) {
          // Mostrar errores específicos por campo
          for (const [field, error] of Object.entries(validation.errors)) {
            FormValidator.showFieldError(field, error);
          }
          form.classList.remove('form-loading');
          return;
        }

        // Usar metadatos sanitizados
        const sanitizedMetadata = validation.sanitized;
        
        // Aquí podrías implementar la lógica para aplicar metadatos a la imagen
        // Por ejemplo, usando ExifWriter.js o similar para escribir metadatos EXIF
        
        console.log('Metadatos validados y sanitizados:', sanitizedMetadata);
        
        // Mostrar previsualización de metadatos
        showMetadataPreview(sanitizedMetadata);
        
        // Simular procesamiento
        setTimeout(() => {
          form.classList.remove('form-loading');
          UIManager.showSuccess('Metadatos guardados correctamente.');
        }, 500);
        
      } catch (error) {
        form.classList.remove('form-loading');
        console.error('Error al procesar metadatos:', error);
        UIManager.showError('Error al procesar los metadatos. Por favor, inténtalo de nuevo.');
      }
    }

    // Función para mostrar la previsualización de metadatos
    function showMetadataPreview(metadata) {
      const previewContainer = document.getElementById('metadata-preview');
      
      // Campos a mostrar
      const fields = [
        { key: 'title', label: 'Título' },
        { key: 'author', label: 'Autor' },
        { key: 'description', label: 'Descripción' },
        { key: 'keywords', label: 'Palabras clave' },
        { key: 'copyright', label: 'Copyright' }
      ];
      
      let hasContent = false;
      
      // Mostrar cada campo si tiene contenido
      fields.forEach(field => {
        const value = metadata[field.key];
        const fieldElement = document.getElementById(`preview-${field.key}`);
        const valueElement = document.getElementById(`preview-${field.key}-value`);
        
        if (value && value.trim()) {
          fieldElement.classList.remove('preview-field--hidden');
          valueElement.textContent = value;
          hasContent = true;
        } else {
          fieldElement.classList.add('preview-field--hidden');
        }
      });
      
      // Mostrar/ocultar el contenedor principal
      if (hasContent) {
        previewContainer.classList.remove('metadata-preview--hidden');
        previewContainer.classList.add('metadata-preview');
        
        // Scroll suave hacia la previsualización
        setTimeout(() => {
          previewContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
          });
        }, 100);
      } else {
        previewContainer.classList.add('metadata-preview--hidden');
      }
    }

    // Función para ocultar la previsualización de metadatos
    function hideMetadataPreview() {
      const previewContainer = document.getElementById('metadata-preview');
      if (previewContainer) {
        previewContainer.classList.add('metadata-preview--hidden');
        previewContainer.classList.remove('metadata-preview');
      }
    }

    // Enhanced watermark form handler with validation
    function handleWatermarkSubmit(e) {
      e.preventDefault();
      
      if (!currentImage) {
        showError('Por favor, selecciona una imagen primero.');
        return;
      }

      const form = e.target;
      const textEnabled = document.getElementById('watermark-text-enabled').checked;
      const imageEnabled = document.getElementById('watermark-image-enabled').checked;
      
      // Verificar que al menos una opción esté habilitada
      if (!textEnabled && !imageEnabled) {
        UIManager.showError('Debe habilitar al menos un tipo de marca de agua');
        return;
      }
      
      // Limpiar errores anteriores
      FormValidator.clearFormErrors('watermark-form');
      form.classList.add('form-loading');

      try {
        // Validar marca de agua de texto si está habilitada
        if (textEnabled) {
          const text = document.getElementById('watermark-text').value;
          const size = document.getElementById('watermark-size').value;
          const opacity = document.getElementById('watermark-opacity').value;
          
          // Validar marca de agua de texto
          const validation = SecurityManager.validateWatermarkText(text, size, opacity);
          
          if (!validation.isValid) {
            validation.errors.forEach(error => UIManager.showError(error));
            form.classList.remove('form-loading');
            return;
          }
        }
        
        // Validar marca de agua de imagen si está habilitada
        if (imageEnabled) {
          const watermarkImageInput = document.getElementById('watermark-image');
          if (!watermarkImageInput.files[0]) {
            UIManager.showError('Debe seleccionar una imagen para la marca de agua');
            form.classList.remove('form-loading');
            return;
          }
        }
        
        // Aplicar marca de agua
        updatePreview();
        
        setTimeout(() => {
          form.classList.remove('form-loading');
          UIManager.showSuccess('Marca de agua aplicada correctamente.');
        }, 300);
        
      } catch (error) {
        form.classList.remove('form-loading');
        console.error('Error al aplicar marca de agua:', error);
        showError('Error al aplicar la marca de agua. Por favor, inténtalo de nuevo.');
      }
    }

    function resetChanges() {
      if (!currentImage) return;
      
      // Limpiar formularios
      document.getElementById('metadata-form').reset();
      document.getElementById('watermark-form').reset();
      
      // Resetear tipo de marca de agua
      document.getElementById('watermark-text-enabled').checked = true;
      document.getElementById('watermark-image-enabled').checked = false;
      toggleWatermarkType();
      
      // Limpiar posicionamiento personalizado
      customImagePosition = null;
      isPositioningMode = false;
      watermarkImagePreview = null;
      removePositionMarker();
      
      const customInfo = document.getElementById('custom-position-info');
      if (customInfo) {
        customInfo.style.display = 'none';
      }
      
      if (canvas) {
        canvas.classList.remove('positioning-mode');
      }
      
      // Ocultar previsualización de metadatos
      const metadataPreview = document.getElementById('metadata-preview');
      if (metadataPreview) {
        metadataPreview.classList.add('metadata-preview--hidden');
        metadataPreview.classList.remove('metadata-preview');
      }
      
      // Resetear controles de salida
      resetOutputControls();
      
      // Limpiar historial
      historyManager.clear();
      
      // Actualizar vista previa
      updatePreview();
      
      // Guardar estado inicial
      setTimeout(() => {
        historyManager.saveState();
      }, 100);
    }

    function resetOutputControls() {
      // Reset quality to default (80%)
      const qualitySelect = document.getElementById('output-quality');
      const qualityNumber = document.getElementById('quality-number');
      
      if (qualitySelect && qualityNumber) {
        qualitySelect.value = '80';
        qualityNumber.value = '80';
        outputQuality = 0.8;
        handleQualityChange();
      }
      
      // Reset format to JPEG (or original extension if available)
      const formatSelect = document.getElementById('output-format');
      if (formatSelect && originalExtension) {
        if (['jpg', 'jpeg'].includes(originalExtension.toLowerCase())) {
          formatSelect.value = 'jpeg';
        } else if (['png'].includes(originalExtension.toLowerCase())) {
          formatSelect.value = 'png';
        } else if (['webp'].includes(originalExtension.toLowerCase())) {
          formatSelect.value = 'webp';
        } else if (['avif'].includes(originalExtension.toLowerCase())) {
          formatSelect.value = 'avif';
        } else {
          formatSelect.value = 'jpeg';
        }
        outputFormat = formatSelect.value;
        handleFormatChange();
      }
    }

    async function downloadImage() {
      if (!canvas) {
        showError('No hay imagen para descargar.');
        return;
      }

      if (!currentFile) {
        showError('Por favor, selecciona una imagen primero.');
        return;
      }
      
      try {
        // Obtener metadatos antes de la descarga
        const metadata = MetadataManager.getMetadata();
        const exifData = MetadataManager.applyMetadataToImage(canvas);
        
        // Mostrar resumen de metadatos si están presentes
        if (metadata.title || metadata.author || metadata.copyright || metadata.latitude) {
          console.log('Metadatos aplicados:', metadata);
          
          let metaInfo = [];
          if (metadata.title) metaInfo.push(`Título: ${metadata.title}`);
          if (metadata.author) metaInfo.push(`Autor: ${metadata.author}`);
          if (metadata.copyright) metaInfo.push(`Copyright: ${metadata.copyright}`);
          if (metadata.latitude && metadata.longitude) {
            metaInfo.push(`Ubicación: ${metadata.latitude.toFixed(4)}, ${metadata.longitude.toFixed(4)}`);
          }
          
          if (metaInfo.length > 0) {
            UIManager.showSuccess(`Imagen descargada con metadatos: ${metaInfo.join(' | ')}`);
          }
        }
        
        // Obtener el título y sanitizar el nombre del archivo
        const titleInput = document.getElementById('metaTitle');
        let filename = metadata.title || titleInput.value.trim() || 'imagen_editada';
        filename = sanitizeFilename(filename);
        
        // Usar el formato seleccionado en lugar de la extensión original
        const extension = getFileExtension(outputFormat);
        const fullFilename = `${filename}.${extension}`;
        
        // Obtener el tipo MIME basado en el formato seleccionado
        const mimeType = getMimeType(outputFormat);
        
        // Usar la API File System Access si está disponible (Chrome/Edge modernos)
        if ('showSaveFilePicker' in window) {
          const options = {
            suggestedName: fullFilename,
            types: [{
              description: 'Imágenes',
              accept: {
                [mimeType]: [`.${extension}`]
              }
            }],
            startIn: lastDownloadDirectory || 'desktop'
          };

          try {
            const handle = await window.showSaveFilePicker(options);
            lastDownloadDirectory = await handle.queryPermission({ mode: 'readwrite' });
            
            const writable = await handle.createWritable();
            const blob = await canvasToBlob(canvas, mimeType, outputQuality);
            await writable.write(blob);
            await writable.close();
            
            const qualityText = outputFormat === 'png' ? '' : ` (calidad: ${Math.round(outputQuality * 100)}%)`;
            showSuccess(`Imagen guardada exitosamente en formato ${outputFormat.toUpperCase()}${qualityText}!`);
            return;
          } catch (saveError) {
            // Si el usuario cancela, no mostrar error
            if (saveError.name === 'AbortError') {
              return;
            }
            console.warn('Error con File System Access API, usando fallback:', saveError);
          }
        }
        
        // Fallback para navegadores que no soportan la API o si falla
        const link = document.createElement('a');
        link.download = fullFilename;
        link.href = canvas.toDataURL(mimeType, outputQuality);
        
        // Simular click
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        const qualityText = outputFormat === 'png' ? '' : ` (calidad: ${Math.round(outputQuality * 100)}%)`;
        showSuccess(`Imagen descargada en formato ${outputFormat.toUpperCase()}${qualityText}!`);
        
      } catch (error) {
        console.error('Error al descargar:', error);
        showError('Error al descargar la imagen.');
      }
    }

    // Helper functions for format handling
    function getFileExtension(format) {
      const extensions = {
        'jpeg': 'jpg',
        'png': 'png',
        'webp': 'webp',
        'avif': 'avif'
      };
      return extensions[format] || 'jpg';
    }

    function getMimeType(format) {
      const mimeTypes = {
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'webp': 'image/webp',
        'avif': 'image/avif'
      };
      return mimeTypes[format] || 'image/jpeg';
    }

    // Enhanced canvasToBlob function using native browser capabilities
    async function canvasToBlob(canvas, mimeType, quality = 0.9) {
      try {
        // Use native canvas.toBlob method with fallback support
        return await new Promise((resolve, reject) => {
          // Check if browser supports the requested format
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = 1;
          tempCanvas.height = 1;
          
          // Test format support
          const testDataUrl = tempCanvas.toDataURL(mimeType);
          if (!testDataUrl.startsWith(`data:${mimeType}`)) {
            // Format not supported, fallback to JPEG
            console.warn(`Format ${mimeType} not supported, falling back to JPEG`);
            mimeType = 'image/jpeg';
          }
          
          // Convert canvas to blob
          canvas.toBlob((blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('Failed to convert canvas to blob'));
            }
          }, mimeType, quality);
        });
        
      } catch (error) {
        console.error('Error with canvas conversion:', error);
        // Final fallback to JPEG
        return canvasToBlob_fallback(canvas, 'image/jpeg', quality);
      }
    }
    
    // Fallback function using canvas native methods
    function canvasToBlob_fallback(canvas, mimeType, quality = 0.9) {
      return new Promise((resolve, reject) => {
        try {
          // For formats that don't support quality, ignore the quality parameter
          if (mimeType === 'image/png') {
            canvas.toBlob(resolve, mimeType);
          } else {
            canvas.toBlob(resolve, mimeType, quality);
          }
        } catch (error) {
          reject(error);
        }
      });
    }

    // Update image information display
    function updateImageInfo() {
      const imageInfoElement = document.getElementById('image-info');
      const dimensionsElement = document.getElementById('image-dimensions');
      const sizeElement = document.getElementById('image-size');
      const formatElement = document.getElementById('image-format');
      const pixelsElement = document.getElementById('image-pixels');
      const currentDimensionsElement = document.getElementById('current-dimensions');
      const currentSizeDisplay = document.getElementById('current-size-display');
      
      if (!currentImage || !imageInfoElement) return;
      
      // Show image info panel
      imageInfoElement.classList.remove('hidden');
      
      // Update dimensions
      if (dimensionsElement) {
        dimensionsElement.textContent = `${currentImage.width} × ${currentImage.height}`;
      }
      
      // Update current size display in resize section
      if (currentDimensionsElement && currentSizeDisplay) {
        currentDimensionsElement.textContent = `${currentImage.width} × ${currentImage.height}`;
        currentSizeDisplay.classList.remove('hidden');
      }
      
      // Update file size
      if (sizeElement && currentFile) {
        sizeElement.textContent = formatFileSize(currentFile.size);
      } else if (sizeElement) {
        sizeElement.textContent = 'Calculando...';
      }
      
      // Update format
      if (formatElement && currentFile) {
        const fileType = currentFile.type.split('/')[1].toUpperCase();
        formatElement.textContent = fileType || originalExtension.toUpperCase();
      } else if (formatElement) {
        formatElement.textContent = originalExtension.toUpperCase();
      }
      
      // Update total pixels
      if (pixelsElement) {
        const totalPixels = currentImage.width * currentImage.height;
        pixelsElement.textContent = formatNumber(totalPixels);
      }
    }
    
    // Format file size in human readable format
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Format number with thousands separator
    function formatNumber(num) {
      return num.toLocaleString('es-ES') + ' px';
    }

    // Initialize resize functionality
    function initResize() {
      const widthInput = document.getElementById('resize-width');
      const heightInput = document.getElementById('resize-height');
      const aspectRatioCheckbox = document.getElementById('maintain-aspect-ratio');
      const applyResizeBtn = document.getElementById('apply-resize');
      const resetResizeBtn = document.getElementById('reset-original-size');
      
      // Preset buttons
      const presetButtons = document.querySelectorAll('.preset-btn');
      
      // Add event listeners to dimension inputs
      if (widthInput) {
        widthInput.addEventListener('input', function() {
          if (aspectRatioCheckbox && aspectRatioCheckbox.checked && originalWidth && originalHeight) {
            const newHeight = Math.round((this.value * originalHeight) / originalWidth);
            if (heightInput) heightInput.value = newHeight;
          }
        });
      }
      
      if (heightInput) {
        heightInput.addEventListener('input', function() {
          if (aspectRatioCheckbox && aspectRatioCheckbox.checked && originalWidth && originalHeight) {
            const newWidth = Math.round((this.value * originalWidth) / originalHeight);
            if (widthInput) widthInput.value = newWidth;
          }
        });
      }
      
      // Preset buttons functionality
      presetButtons.forEach(button => {
        button.addEventListener('click', function() {
          const width = this.getAttribute('data-width');
          const height = this.getAttribute('data-height');
          
          if (widthInput) widthInput.value = width;
          if (heightInput) heightInput.value = height;
          
          // Update button visual state
          presetButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
          this.classList.add('ring-2', 'ring-blue-500');
        });
      });
      
      // Apply resize functionality
      if (applyResizeBtn) {
        applyResizeBtn.addEventListener('click', function() {
          const newWidth = parseInt(widthInput.value);
          const newHeight = parseInt(heightInput.value);
          
          if (newWidth > 0 && newHeight > 0 && currentImage) {
            resizeImage(newWidth, newHeight);
          }
        });
      }
      
      // Reset resize functionality
      if (resetResizeBtn) {
        resetResizeBtn.addEventListener('click', function() {
          if (originalWidth && originalHeight) {
            if (widthInput) widthInput.value = originalWidth;
            if (heightInput) heightInput.value = originalHeight;
            presetButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500'));
            
            if (currentImage) {
              resizeImage(originalWidth, originalHeight);
            }
          }
        });
      }
    }

    // Resize image function
    function resizeImage(newWidth, newHeight) {
      if (!currentImage) {
        console.error('No current image available');
        return;
      }
      
      // Validate dimensions
      if (newWidth <= 0 || newHeight <= 0) {
        console.error('Invalid dimensions:', newWidth, newHeight);
        return;
      }
      
      try {
        // Create temporary canvas for resizing
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCanvas.width = newWidth;
        tempCanvas.height = newHeight;
        
        // Draw resized image with high quality
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.drawImage(currentImage, 0, 0, newWidth, newHeight);
        
        // Create new image from the resized canvas
        const newImage = new Image();
        newImage.onload = function() {
          // Update current image
          currentImage = newImage;
          
          // Update preview canvas
          const canvas = document.getElementById('preview-canvas');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = newWidth;
            canvas.height = newHeight;
            ctx.clearRect(0, 0, newWidth, newHeight);
            ctx.drawImage(newImage, 0, 0);
            
            // Re-apply watermark if present
            updatePreview();
          }
          
          // Update image info display
          updateImageInfo();
          
          // Show success message
          showSuccessMessage(`Imagen redimensionada a ${newWidth} × ${newHeight}`);
          
          console.log('Image resized successfully to:', newWidth, 'x', newHeight);
        };
        
        newImage.onerror = function() {
          console.error('Error creating resized image');
        };
        
        // Convert canvas to data URL and set as image source
        newImage.src = tempCanvas.toDataURL('image/png');
        
      } catch (error) {
        console.error('Error during resize operation:', error);
        showSuccessMessage('Error al redimensionar la imagen');
      }
    }

    // Show success message
    function showSuccessMessage(message) {
      // Create or update success message element
      let successElement = document.getElementById('success-message');
      if (!successElement) {
        successElement = document.createElement('div');
        successElement.id = 'success-message';
        successElement.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300';
        document.body.appendChild(successElement);
      }
      
      successElement.textContent = message;
      successElement.style.opacity = '1';
      
      // Hide after 3 seconds
      setTimeout(() => {
        successElement.style.opacity = '0';
        setTimeout(() => {
          if (successElement.parentNode) {
            successElement.parentNode.removeChild(successElement);
          }
        }, 300);
      }, 3000);
    }
    
    // Character counter functionality
    function initCharacterCounters() {
      const fields = [
        { id: 'metaTitle', counter: 'title-counter', limit: 60 },
        { id: 'description', counter: 'description-counter', limit: 160 },
        { id: 'keywords', counter: 'keywords-counter', limit: 200 }
      ];

      fields.forEach(field => {
        const input = document.getElementById(field.id);
        const counter = document.getElementById(field.counter);
        
        if (input && counter) {
          // Update counter on input
          input.addEventListener('input', function() {
            updateCharacterCount(this, counter, field.limit);
          });
          
          // Initial count
          updateCharacterCount(input, counter, field.limit);
        }
      });
    }

    function updateCharacterCount(input, counter, limit) {
      const length = input.value.length;
      const remaining = limit - length;
      
      // Update counter text
      counter.textContent = `${length}/${limit} caracteres`;
      
      // Update color based on usage
      counter.classList.remove('good', 'warning', 'danger');
      
      if (length <= limit * 0.7) {
        counter.classList.add('good');
      } else if (length <= limit * 0.9) {
        counter.classList.add('warning');
      } else {
        counter.classList.add('danger');
      }
      
      // Show remaining characters if close to limit
      if (remaining <= 10 && remaining >= 0) {
        counter.textContent = `${length}/${limit} (${remaining} restantes)`;
      } else if (length > limit) {
        counter.textContent = `${length}/${limit} (${Math.abs(remaining)} sobre el límite)`;
      }
    }
    
    // Image rotation functionality
    function initRotation() {
      const rotate90Btn = document.getElementById('rotate-90');
      const rotate180Btn = document.getElementById('rotate-180');
      const rotate270Btn = document.getElementById('rotate-270');
      const resetRotationBtn = document.getElementById('reset-rotation');
      const flipHorizontalBtn = document.getElementById('flip-horizontal');
      const flipVerticalBtn = document.getElementById('flip-vertical');
      
      // Rotation buttons
      if (rotate90Btn) {
        rotate90Btn.addEventListener('click', () => rotateImage(90));
      }
      
      if (rotate180Btn) {
        rotate180Btn.addEventListener('click', () => rotateImage(180));
      }
      
      if (rotate270Btn) {
        rotate270Btn.addEventListener('click', () => rotateImage(270));
      }
      
      if (resetRotationBtn) {
        resetRotationBtn.addEventListener('click', resetRotation);
      }
      
      // Flip buttons
      if (flipHorizontalBtn) {
        flipHorizontalBtn.addEventListener('click', () => flipImage('horizontal'));
      }
      
      if (flipVerticalBtn) {
        flipVerticalBtn.addEventListener('click', () => flipImage('vertical'));
      }
    }

    function rotateImage(degrees) {
      if (!currentImage) {
        console.error('No current image available');
        return;
      }
      
      try {
        // Update rotation state
        currentRotation = (currentRotation + degrees) % 360;
        
        // Apply transformation
        applyImageTransformation();
        
        // Update rotation display
        updateRotationDisplay();
        
        // Show success message
        showSuccessMessage(`Imagen rotada ${degrees}° (Total: ${currentRotation}°)`);
        
        console.log('Image rotated:', degrees, 'degrees. Total rotation:', currentRotation);
        
      } catch (error) {
        console.error('Error rotating image:', error);
        showSuccessMessage('Error al rotar la imagen');
      }
    }

    function flipImage(direction) {
      if (!currentImage) {
        console.error('No current image available');
        return;
      }
      
      try {
        if (direction === 'horizontal') {
          isFlippedHorizontally = !isFlippedHorizontally;
        } else if (direction === 'vertical') {
          isFlippedVertically = !isFlippedVertically;
        }
        
        // Apply transformation
        applyImageTransformation();
        
        // Update rotation display
        updateRotationDisplay();
        
        // Show success message
        const flipText = direction === 'horizontal' ? 'horizontalmente' : 'verticalmente';
        showSuccessMessage(`Imagen volteada ${flipText}`);
        
        console.log('Image flipped:', direction);
        
      } catch (error) {
        console.error('Error flipping image:', error);
        showSuccessMessage('Error al voltear la imagen');
      }
    }

    function applyImageTransformation() {
      if (!currentImage) return;
      
      const canvas = document.getElementById('preview-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      // Create a temporary canvas with original image
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      
      // Use original dimensions for source
      tempCanvas.width = originalWidth;
      tempCanvas.height = originalHeight;
      tempCtx.drawImage(currentImage, 0, 0, originalWidth, originalHeight);
      
      // Calculate new dimensions based on rotation
      let newWidth, newHeight;
      if (currentRotation === 90 || currentRotation === 270) {
        newWidth = originalHeight;
        newHeight = originalWidth;
      } else {
        newWidth = originalWidth;
        newHeight = originalHeight;
      }
      
      // Set canvas size
      canvas.width = newWidth;
      canvas.height = newHeight;
      
      // Clear canvas
      ctx.clearRect(0, 0, newWidth, newHeight);
      
      // Save context state
      ctx.save();
      
      // Move to center of canvas for transformations
      ctx.translate(newWidth / 2, newHeight / 2);
      
      // Apply rotation
      if (currentRotation !== 0) {
        ctx.rotate((currentRotation * Math.PI) / 180);
      }
      
      // Apply flips
      const scaleX = isFlippedHorizontally ? -1 : 1;
      const scaleY = isFlippedVertically ? -1 : 1;
      ctx.scale(scaleX, scaleY);
      
      // Draw image centered (use original dimensions for drawing)
      ctx.drawImage(
        tempCanvas,
        -originalWidth / 2,
        -originalHeight / 2,
        originalWidth,
        originalHeight
      );
      
      // Restore context state
      ctx.restore();
      
      // Create new image from canvas for currentImage reference
      const newImageData = canvas.toDataURL('image/png');
      const newImage = new Image();
      newImage.onload = function() {
        currentImage = newImage;
        currentImage.width = newWidth;
        currentImage.height = newHeight;
        
        // Update image info
        updateImageInfo();
        
        // Update preview with watermark if present
        updatePreview();
      };
      newImage.src = newImageData;
    }

    function resetRotation() {
      if (!currentImage) return;
      
      try {
        // Reset all transformations
        currentRotation = 0;
        isFlippedHorizontally = false;
        isFlippedVertically = false;
        
        // Restore original image
        if (originalWidth && originalHeight) {
          currentImage.width = originalWidth;
          currentImage.height = originalHeight;
        }
        
        // Redraw original image
        const canvas = document.getElementById('preview-canvas');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          canvas.width = currentImage.width;
          canvas.height = currentImage.height;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(currentImage, 0, 0);
        }
        
        // Update displays
        updateRotationDisplay();
        updateImageInfo();
        updatePreview();
        
        showSuccessMessage('Rotación restablecida al original');
        
      } catch (error) {
        console.error('Error resetting rotation:', error);
        showSuccessMessage('Error al restablecer la rotación');
      }
    }

    function updateRotationDisplay() {
      const currentRotationElement = document.getElementById('current-rotation');
      const currentRotationDisplay = document.getElementById('current-rotation-display');
      
      if (currentRotationElement && currentRotationDisplay) {
        let displayText = `${currentRotation}°`;
        
        // Add flip indicators
        if (isFlippedHorizontally || isFlippedVertically) {
          const flips = [];
          if (isFlippedHorizontally) flips.push('H');
          if (isFlippedVertically) flips.push('V');
          displayText += ` (${flips.join(', ')})`;
        }
        
        currentRotationElement.textContent = displayText;
        
        // Show/hide display based on transformations
        if (currentRotation !== 0 || isFlippedHorizontally || isFlippedVertically) {
          currentRotationDisplay.classList.remove('hidden');
        } else {
          currentRotationDisplay.classList.add('hidden');
        }
      }
    }
    
    // Progress bar functionality
    function showProgressBar(title = 'Procesando...') {
      const overlay = document.getElementById('progress-overlay');
      const titleElement = document.getElementById('progress-title');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressEta = document.getElementById('progress-eta');
      
      if (overlay && titleElement) {
        titleElement.textContent = title;
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        progressEta.textContent = 'Calculando tiempo...';
        overlay.classList.add('show');
      }
    }
    
    function updateProgress(percentage, message = '', eta = '') {
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressEta = document.getElementById('progress-eta');
      
      if (progressBar && progressText) {
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${Math.round(percentage)}%`;
        
        if (message) {
          const titleElement = document.getElementById('progress-title');
          if (titleElement) titleElement.textContent = message;
        }
        
        if (eta && progressEta) {
          progressEta.textContent = eta;
        }
      }
    }
    
    function hideProgressBar() {
      const overlay = document.getElementById('progress-overlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }
    
    // Enhanced progress simulation for download operations
    async function simulateProgressSteps(steps, totalDuration = 3000) {
      const stepDuration = totalDuration / steps.length;
      const startTime = Date.now();
      
      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const progress = ((i + 1) / steps.length) * 100;
        const elapsed = Date.now() - startTime;
        const estimatedTotal = (elapsed / (i + 1)) * steps.length;
        const remaining = Math.max(0, estimatedTotal - elapsed);
        
        const eta = remaining > 1000 
          ? `${Math.ceil(remaining / 1000)}s restantes`
          : `${Math.ceil(remaining)}ms restantes`;
        
        updateProgress(progress, step.message, eta);
        
        // Simulate processing time
        await new Promise(resolve => setTimeout(resolve, step.duration || stepDuration));
      }
    }
    
    // Enhanced download function with progress bar
    async function downloadImageWithProgress() {
      if (!canvas) {
        showError('No hay imagen para descargar.');
        return;
      }

      if (!currentFile) {
        showError('Por favor, selecciona una imagen primero.');
        return;
      }
      
      try {
        // Show progress bar
        showProgressBar('Iniciando descarga...');
        
        // Define download steps
        const downloadSteps = [
          { message: 'Obteniendo metadatos...', duration: 300 },
          { message: 'Aplicando metadatos...', duration: 400 },
          { message: 'Generando nombre de archivo...', duration: 200 },
          { message: 'Configurando formato de salida...', duration: 300 },
          { message: 'Procesando imagen...', duration: 600 },
          { message: 'Generando archivo...', duration: 500 },
          { message: 'Iniciando descarga...', duration: 400 }
        ];
        
        // Start progress simulation
        const progressPromise = simulateProgressSteps(downloadSteps, 2800);
        
        // Obtener metadatos antes de la descarga
        const metadata = MetadataManager.getMetadata();
        const exifData = MetadataManager.applyMetadataToImage(canvas);
        
        // Wait for initial progress steps
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Mostrar resumen de metadatos si están presentes
        if (metadata.title || metadata.author || metadata.copyright || metadata.latitude) {
          console.log('Metadatos aplicados:', metadata);
          
          let metaInfo = [];
          if (metadata.title) metaInfo.push(`Título: ${metadata.title}`);
          if (metadata.author) metaInfo.push(`Autor: ${metadata.author}`);
          if (metadata.copyright) metaInfo.push(`Copyright: ${metadata.copyright}`);
          if (metadata.latitude && metadata.longitude) {
            metaInfo.push(`Ubicación: ${metadata.latitude}, ${metadata.longitude}`);
          }
          
          console.log('Resumen de metadatos aplicados:\n' + metaInfo.join('\n'));
        }
        
        // Wait for more progress
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Generar nombre del archivo basado en el título o usar uno por defecto
        let filename = 'imagen-editada';
        
        if (metadata.title && metadata.title.trim()) {
          filename = metadata.title.trim();
        } else if (currentFile && currentFile.name) {
          filename = currentFile.name.replace(/\.[^/.]+$/, '');
        }
        
        // Limpiar el nombre de archivo
        filename = sanitizeFilename(filename);
        
        // Usar el formato seleccionado en lugar de la extensión original
        const extension = getFileExtension(outputFormat);
        const fullFilename = `${filename}.${extension}`;
        
        // Wait for processing steps
        await new Promise(resolve => setTimeout(resolve, 900));
        
        // Obtener el tipo MIME basado en el formato seleccionado
        const mimeType = getMimeType(outputFormat);
        
        // Complete progress
        await progressPromise;
        
        // Fallback para navegadores que no soportan la API o si falla
        const link = document.createElement('a');
        link.download = fullFilename;
        link.href = canvas.toDataURL(mimeType, outputQuality);
        
        // Simular click
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Hide progress bar
        hideProgressBar();
        
        const qualityText = outputFormat === 'png' ? '' : ` (calidad: ${Math.round(outputQuality * 100)}%)`;
        showSuccess(`Imagen descargada en formato ${outputFormat.toUpperCase()}${qualityText}!`);
        
      } catch (error) {
        console.error('Error al descargar:', error);
        hideProgressBar();
        showError('Error al descargar la imagen.');
      }
    }
    
    
    // Hide image info when no image is loaded
    function hideImageInfo() {
      const imageInfoElement = document.getElementById('image-info');
      if (imageInfoElement) {
        imageInfoElement.classList.add('hidden');
      }
    }

    function removeSelectedFile() {
      currentImage = null;
      currentFile = null;
      originalExtension = 'jpg';
      watermarkImagePreview = null;
      customImagePosition = null;
      isPositioningMode = false;
      
      // Limpiar cache
      cache.watermarkImage = null;
      cache.lastWatermarkConfig = null;
      
      // Limpiar formularios
      document.getElementById('file-input').value = '';
      document.getElementById('metadata-form').reset();
      document.getElementById('watermark-form').reset();
      
      // Ocultar elementos
      document.getElementById('file-info').classList.add('file-info--hidden');
      document.getElementById('editor-container').classList.add('editor-container--hidden');
      
      // Ocultar controles de zoom
      const zoomControls = document.getElementById('zoom-controls');
      if (zoomControls) {
        zoomControls.classList.add('hidden');
      }
      
      hideImageInfo(); // Ocultar información de imagen
      
      // Limpiar canvas
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      
      // Limpiar marcador de posición si existe
      removePositionMarker();
      
      // Ocultar información de posicionamiento personalizado
      const customInfo = document.getElementById('custom-position-info');
      if (customInfo) {
        customInfo.style.display = 'none';
      }
      
      // Quitar clase de posicionamiento del canvas
      if (canvas) {
        canvas.classList.remove('positioning-mode');
      }
      
      // Ocultar preview de metadatos si está visible
      hideMetadataPreview();
      
      // Resetear controles de salida
      resetOutputControls();
      
      UIManager.hideError();
      UIManager.showSuccess('Archivo removido correctamente');
    }

    // Funciones de pantalla completa
    function toggleFullscreen() {
      const canvas = document.getElementById('preview-canvas');
      const container = canvas.parentElement;
      
      if (!document.fullscreenElement) {
        // Entrar en pantalla completa
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
        
        // Agregar clase para estilos de pantalla completa
        container.classList.add('fullscreen-mode');
        canvas.style.maxWidth = '100vw';
        canvas.style.maxHeight = '100vh';
        canvas.style.objectFit = 'contain';
        
      } else {
        // Salir de pantalla completa
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    function handleFullscreenChange() {
      const canvas = document.getElementById('preview-canvas');
      const container = canvas.parentElement;
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      
      if (!document.fullscreenElement) {
        // Saliendo de pantalla completa
        container.classList.remove('fullscreen-mode');
        canvas.style.maxWidth = '';
        canvas.style.maxHeight = '';
        canvas.style.objectFit = '';
        
        if (fullscreenBtn) {
          fullscreenBtn.innerHTML = '<i class="fas fa-expand" aria-hidden="true"></i> Pantalla completa';
        }
      } else {
        // Entrando en pantalla completa
        if (fullscreenBtn) {
          fullscreenBtn.innerHTML = '<i class="fas fa-compress" aria-hidden="true"></i> Salir';
        }
      }
    }

    function showError(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-down max-w-sm';
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle mr-3"></i>
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-red-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.add('animate-fade-out');
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    function hideError() {
      // Legacy function kept for compatibility
      const errorElement = document.getElementById('error-message');
      if (errorElement) {
        errorElement.classList.add('error--hidden');
      }
    }

    function showSuccess(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-down max-w-sm';
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-3"></i>
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-green-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.add('animate-fade-out');
          setTimeout(() => notification.remove(), 300);
        }
      }, 4000);
    }

    // Enhanced download function with progress
    async function downloadImageEnhanced() {
      if (!canvas || !currentImage) {
        showError('No hay imagen para descargar');
        return;
      }
      
      try {
        showLoadingState('Preparando descarga...');
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
        const filename = `imagen-editada-${timestamp}.png`;
        
        // Create download with enhanced quality
        const dataUrl = canvas.toDataURL('image/png', 1.0);
        const link = document.createElement('a');
        link.download = filename;
        link.href = dataUrl;
        
        // Trigger download with smooth animation
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        hideLoadingState();
        
      } catch (error) {
        console.error('Error downloading image:', error);
        hideLoadingState();
        showError('Error al descargar la imagen');
      }
    }

    // Loading state management
    function showLoadingState(message = 'Procesando...') {
      const overlay = document.createElement('div');
      overlay.id = 'loading-overlay';
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in';
      
      overlay.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm mx-4 text-center animate-slide-up">
          <div class="animate-pulse mb-4">
            <div class="w-8 h-8 bg-blue-500 rounded-full mx-auto"></div>
          </div>
          <p class="text-gray-700 dark:text-gray-300 font-medium">${message}</p>
          <div class="mt-4">
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
              <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full animate-loading-bar"></div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
    }

    function hideLoadingState() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        overlay.classList.add('animate-fade-out');
        setTimeout(() => overlay.remove(), 300);
      }
    }

    // Enhanced clear metadata function
    function clearMetadata() {
      const form = document.getElementById('metadata-form');
      if (form) {
        form.reset();
        showSuccess('Metadatos limpiados');
      }
    }

    // Performance monitoring
    function measurePerformance(operation, fn) {
      const start = performance.now();
      const result = fn();
      const end = performance.now();
      
      if (end - start > 100) { // Log operations taking more than 100ms
        console.log(`Performance: ${operation} took ${(end - start).toFixed(2)}ms`);
      }
      
      return result;
    }

    // Enhanced error handling
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showError('Se ha producido un error inesperado');
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showError('Error en operación asíncrona');
    });

    // Sistema de Geolocalización y Copyright
    const MetadataManager = {
      // Configuración de copyright
      copyrightTemplates: [
        '© {year} {author}. Todos los derechos reservados.',
        '© {year} {author}',
        'Copyright {year} by {author}',
        '{author} © {year}'
      ],
      
      // Generar copyright automático
      generateCopyright: function(author = '') {
        const year = new Date().getFullYear();
        const authorName = author || document.getElementById('metaAuthor').value || 'Autor';
        const template = this.copyrightTemplates[0]; // Usar plantilla por defecto
        
        return template
          .replace('{year}', year)
          .replace('{author}', authorName);
      },
      
      // Obtener ubicación actual del usuario
      getCurrentLocation: function() {
        const locationStatus = document.getElementById('locationStatus');
        const latInput = document.getElementById('metaLatitude');
        const lonInput = document.getElementById('metaLongitude');
        const altInput = document.getElementById('metaAltitude');
        
        if (!navigator.geolocation) {
          locationStatus.textContent = 'Geolocalización no soportada en este navegador';
          locationStatus.className = 'text-red-500 text-xs mt-1 block';
          return;
        }
        
        locationStatus.textContent = 'Obteniendo ubicación...';
        locationStatus.className = 'location-status loading';
        
        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        };
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude, altitude } = position.coords;
            
            latInput.value = latitude.toFixed(6);
            lonInput.value = longitude.toFixed(6);
            if (altitude !== null) {
              altInput.value = Math.round(altitude);
            }
            
            locationStatus.textContent = `Ubicación obtenida: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            locationStatus.className = 'location-status success';
            
            UIManager.showSuccess('Ubicación GPS obtenida correctamente');
          },
          (error) => {
            let errorMessage = 'Error al obtener ubicación: ';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage += 'Permiso denegado por el usuario';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage += 'Información de ubicación no disponible';
                break;
              case error.TIMEOUT:
                errorMessage += 'Tiempo de espera agotado';
                break;
              default:
                errorMessage += 'Error desconocido';
                break;
            }
            
            locationStatus.textContent = errorMessage;
            locationStatus.className = 'location-status error';
            UIManager.showError('No se pudo obtener la ubicación GPS');
          },
          options
        );
      },
      
      // Obtener todos los metadatos para exportar
      getMetadata: function() {
        return {
          title: document.getElementById('metaTitle').value || '',
          author: document.getElementById('metaAuthor').value || '',
          copyright: document.getElementById('metaCopyright').value || '',
          license: document.getElementById('metaLicense').value || '',
          latitude: parseFloat(document.getElementById('metaLatitude').value) || null,
          longitude: parseFloat(document.getElementById('metaLongitude').value) || null,
          altitude: parseFloat(document.getElementById('metaAltitude').value) || null,
          createdAt: new Date().toISOString(),
          software: 'ImageMetadataPro v2.0'
        };
      },
      
      // Aplicar metadatos a la imagen
      applyMetadataToImage: function(canvas) {
        const metadata = this.getMetadata();
        
        // Crear metadatos EXIF simulados (en un proyecto real usarías una librería como piexifjs)
        const exifData = {
          'Image Description': metadata.title,
          'Artist': metadata.author,
          'Copyright': metadata.copyright,
          'Software': metadata.software,
          'DateTime': new Date().toISOString().replace(/T/, ' ').replace(/\..+/, ''),
          'GPS Latitude': metadata.latitude,
          'GPS Longitude': metadata.longitude,
          'GPS Altitude': metadata.altitude
        };
        
        // Guardar metadatos en el localStorage para persistencia
        localStorage.setItem('imageMetadata', JSON.stringify(metadata));
        
        return exifData;
      },
      
      // Cargar metadatos guardados
      loadSavedMetadata: function() {
        try {
          const saved = localStorage.getItem('imageMetadata');
          if (saved) {
            const metadata = JSON.parse(saved);
            
            // Restaurar valores en los campos
            if (metadata.author) document.getElementById('metaAuthor').value = metadata.author;
            if (metadata.license) document.getElementById('metaLicense').value = metadata.license;
            
            // No restaurar ubicación automáticamente por privacidad
          }
        } catch (error) {
          console.warn('No se pudieron cargar metadatos guardados:', error);
        }
      }
    };

    // Función para copyright automático
    function generateAutoCopyright() {
      const authorInput = document.getElementById('metaAuthor');
      const copyrightInput = document.getElementById('metaCopyright');
      
      // Si no hay autor, pedirlo
      if (!authorInput.value.trim()) {
        UIManager.showError('Por favor, ingresa el nombre del autor primero');
        authorInput.focus();
        return;
      }
      
      const autoCopyright = MetadataManager.generateCopyright(authorInput.value);
      copyrightInput.value = autoCopyright;
      
      UIManager.showSuccess('Copyright generado automáticamente');
    }

    // Sistema de Filtros Avanzados  
    const FilterManager = {
      filters: {
        brightness: 0,
        contrast: 0,
        saturation: 0,
        blur: 0,
        sepia: 0,
        hueRotate: 0
      },
      
      presets: {
        none: { brightness: 0, contrast: 0, saturation: 0, blur: 0, sepia: 0, hueRotate: 0 },
        sepia: { brightness: 20, contrast: 10, saturation: -20, blur: 0, sepia: 80, hueRotate: 0 },
        grayscale: { brightness: 0, contrast: 0, saturation: -100, blur: 0, sepia: 0, hueRotate: 0 },
        vintage: { brightness: -10, contrast: 25, saturation: -30, blur: 0.5, sepia: 30, hueRotate: 0 },
        cold: { brightness: -5, contrast: 10, saturation: -15, blur: 0, sepia: 0, hueRotate: 180 },
        warm: { brightness: 15, contrast: 10, saturation: 20, blur: 0, sepia: 10, hueRotate: -10 }
      },
      
      applyFilter: function(filterName, value) {
        console.log(`Aplicando filtro ${filterName}: ${value}`);
        this.filters[filterName] = value;
        this.updateFilterDisplay(filterName, value);
        console.log('Estado actual de filtros:', this.filters);
        debouncedUpdatePreview();
      },
      
      applyPreset: function(presetName) {
        const preset = this.presets[presetName];
        if (!preset) return;
        
        // Aplicar todos los valores del preset
        Object.keys(preset).forEach(filter => {
          this.filters[filter] = preset[filter];
          this.updateFilterDisplay(filter, preset[filter]);
          
          // Actualizar sliders
          const slider = document.getElementById(filter);
          if (slider) {
            slider.value = preset[filter];
          }
        });
        
        // Resaltar botón activo
        this.highlightActivePreset(presetName);
        debouncedUpdatePreview();
      },
      
      updateFilterDisplay: function(filterName, value) {
        const display = document.getElementById(`${filterName}-value`);
        if (display) {
          display.textContent = filterName === 'blur' ? `${value}px` : value;
        }
      },
      
      highlightActivePreset: function(activePreset) {
        const presetButtons = document.querySelectorAll('.filter-preset');
        presetButtons.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
          
          if (btn.dataset.filter === activePreset) {
            btn.classList.remove('btn-outline');
            btn.classList.add('btn-primary');
          }
        });
      },
      
      reset: function() {
        Object.keys(this.filters).forEach(filter => {
          this.filters[filter] = 0;
          this.updateFilterDisplay(filter, 0);
          
          const slider = document.getElementById(filter);
          if (slider) {
            slider.value = 0;
          }
        });
        
        this.highlightActivePreset('none');
        debouncedUpdatePreview();
      },
      
      getFilterString: function() {
        const { brightness, contrast, saturation, blur, sepia, hueRotate } = this.filters;
        
        let filterStr = '';
        
        if (brightness !== 0) {
          filterStr += `brightness(${(100 + brightness) / 100}) `;
        }
        
        if (contrast !== 0) {
          filterStr += `contrast(${(100 + contrast) / 100}) `;
        }
        
        if (saturation !== 0) {
          filterStr += `saturate(${(100 + saturation) / 100}) `;
        }
        
        if (sepia > 0) {
          filterStr += `sepia(${sepia}%) `;
        }
        
        if (hueRotate !== 0) {
          filterStr += `hue-rotate(${hueRotate}deg) `;
        }
        
        if (blur > 0) {
          filterStr += `blur(${blur}px) `;
        }
        
        console.log('🎨 Filtro CSS generado:', filterStr.trim());
        return filterStr.trim();
      }
    };

    // Función para resetear filtros
    function resetFilters() {
      FilterManager.reset();
      UIManager.showSuccess('Filtros reseteados');
    }

    // Función para aplicar filtros al canvas
    function applyCanvasFilters() {
      if (!canvas) {
        console.log('No hay canvas disponible para aplicar filtros');
        return;
      }
      
      const filterString = FilterManager.getFilterString();
      console.log('Aplicando filtros CSS al canvas:', filterString);
      canvas.style.filter = filterString;
    }
    
    // ===== ZOOM FUNCTIONALITY =====
    
    function zoomIn() {
      if (currentZoom < maxZoom) {
        currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
        applyZoom();
        updateZoomLevel();
        UIManager.showSuccess(`Zoom: ${Math.round(currentZoom * 100)}%`);
      }
    }
    
    function zoomOut() {
      if (currentZoom > minZoom) {
        currentZoom = Math.max(currentZoom - zoomStep, minZoom);
        applyZoom();
        updateZoomLevel();
        UIManager.showSuccess(`Zoom: ${Math.round(currentZoom * 100)}%`);
      }
    }
    
    // Funciones de zoom específicas para rueda del ratón (más suaves)
    function zoomInWheel() {
      if (currentZoom < maxZoom) {
        const wheelStep = 0.05; // Paso más pequeño para rueda del ratón
        currentZoom = Math.min(currentZoom + wheelStep, maxZoom);
        applyZoom();
        updateZoomLevel();
      }
    }
    
    function zoomOutWheel() {
      if (currentZoom > minZoom) {
        const wheelStep = 0.05; // Paso más pequeño para rueda del ratón
        currentZoom = Math.max(currentZoom - wheelStep, minZoom);
        applyZoom();
        updateZoomLevel();
      }
    }
    
    function resetZoom() {
      currentZoom = 1.0;
      isZoomed = false;
      resetPan(); // Reset pan también
      applyZoom();
      updateZoomLevel();
      UIManager.showSuccess('Zoom reseteado');
    }
    
    function applyZoom() {
      if (!canvas) return;
      
      if (currentZoom !== 1.0) {
        isZoomed = true;
        canvas.classList.add('zoomed');
        canvas.style.transform = `scale(${currentZoom}) translate(${panX}px, ${panY}px)`;
        canvas.style.transformOrigin = 'center center';
        canvas.style.cursor = 'grab';
      } else {
        isZoomed = false;
        canvas.classList.remove('zoomed');
        canvas.style.transform = 'scale(1)';
        canvas.style.cursor = 'default';
        // Reset pan cuando no hay zoom
        panX = 0;
        panY = 0;
      }
      
      // Actualizar scroll del contenedor si es necesario
      const previewContainer = document.querySelector('.preview__container');
      if (previewContainer && isZoomed) {
        previewContainer.style.overflow = 'hidden'; // Cambiar a hidden para pan
      } else if (previewContainer) {
        previewContainer.style.overflow = 'hidden';
      }
    }
    
    function updateZoomLevel() {
      const zoomLevelElement = document.getElementById('zoom-level');
      if (zoomLevelElement) {
        zoomLevelElement.textContent = `${Math.round(currentZoom * 100)}%`;
      }
      
      // Actualizar estado de los botones
      const zoomInBtn = document.getElementById('zoom-in-btn');
      const zoomOutBtn = document.getElementById('zoom-out-btn');
      
      if (zoomInBtn) {
        zoomInBtn.disabled = currentZoom >= maxZoom;
        zoomInBtn.style.opacity = currentZoom >= maxZoom ? '0.5' : '1';
      }
      
      if (zoomOutBtn) {
        zoomOutBtn.disabled = currentZoom <= minZoom;
        zoomOutBtn.style.opacity = currentZoom <= minZoom ? '0.5' : '1';
      }
    }
    
    // Atajos de teclado para zoom
    function initZoomKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case '+':
            case '=':
              e.preventDefault();
              zoomIn();
              break;
            case '-':
              e.preventDefault();
              zoomOut();
              break;
            case '0':
              e.preventDefault();
              resetZoom();
              break;
          }
        }
      });
    }
    
    // Zoom con rueda del ratón
    function initMouseWheelZoom() {
      const previewContainer = document.querySelector('.preview__container');
      const canvas = document.getElementById('preview-canvas');
      
      if (!previewContainer) return;
      
      const handleWheelZoom = function(e) {
        // Solo hacer zoom si hay una imagen cargada
        if (!currentImage || !canvas) return;
        
        // Prevenir el scroll normal de la página
        e.preventDefault();
        
        // Determinar dirección del scroll
        const delta = e.deltaY;
        
        if (delta < 0) {
          // Scroll hacia arriba = Zoom In
          zoomInWheel();
        } else if (delta > 0) {
          // Scroll hacia abajo = Zoom Out
          zoomOutWheel();
        }
      };
      
      // Agregar event listener al contenedor del preview
      previewContainer.addEventListener('wheel', handleWheelZoom, { passive: false });
      
      // También agregar al canvas directamente cuando esté disponible
      if (canvas) {
        canvas.addEventListener('wheel', handleWheelZoom, { passive: false });
      }
      
      console.log('Mouse wheel zoom initialized');
    }
    
    // ===== PAN FUNCTIONALITY =====
    
    function initPanNavigation() {
      const canvas = document.getElementById('preview-canvas');
      if (!canvas) return;
      
      // Mouse down - iniciar pan
      canvas.addEventListener('mousedown', function(e) {
        if (!isZoomed || !currentImage) return;
        
        isPanning = true;
        startPanX = e.clientX;
        startPanY = e.clientY;
        startOffsetX = panX;
        startOffsetY = panY;
        
        canvas.style.cursor = 'grabbing';
        e.preventDefault();
      });
      
      // Mouse move - pan activo
      document.addEventListener('mousemove', function(e) {
        if (!isPanning || !isZoomed) return;
        
        const deltaX = e.clientX - startPanX;
        const deltaY = e.clientY - startPanY;
        
        // Calcular nuevas posiciones con límites
        const maxPanX = (canvas.offsetWidth * (currentZoom - 1)) / 2;
        const maxPanY = (canvas.offsetHeight * (currentZoom - 1)) / 2;
        
        panX = Math.max(-maxPanX, Math.min(maxPanX, startOffsetX + deltaX / currentZoom));
        panY = Math.max(-maxPanY, Math.min(maxPanY, startOffsetY + deltaY / currentZoom));
        
        applyZoom();
        e.preventDefault();
      });
      
      // Mouse up - finalizar pan
      document.addEventListener('mouseup', function(e) {
        if (isPanning) {
          isPanning = false;
          if (canvas && isZoomed) {
            canvas.style.cursor = 'grab';
          }
        }
      });
      
      // Mouse leave - finalizar pan
      document.addEventListener('mouseleave', function(e) {
        if (isPanning) {
          isPanning = false;
          if (canvas && isZoomed) {
            canvas.style.cursor = 'grab';
          }
        }
      });
      
      // Touch events para móviles
      canvas.addEventListener('touchstart', function(e) {
        if (!isZoomed || !currentImage) return;
        
        const touch = e.touches[0];
        isPanning = true;
        startPanX = touch.clientX;
        startPanY = touch.clientY;
        startOffsetX = panX;
        startOffsetY = panY;
        
        e.preventDefault();
      }, { passive: false });
      
      document.addEventListener('touchmove', function(e) {
        if (!isPanning || !isZoomed) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - startPanX;
        const deltaY = touch.clientY - startPanY;
        
        // Calcular nuevas posiciones con límites
        const maxPanX = (canvas.offsetWidth * (currentZoom - 1)) / 2;
        const maxPanY = (canvas.offsetHeight * (currentZoom - 1)) / 2;
        
        panX = Math.max(-maxPanX, Math.min(maxPanX, startOffsetX + deltaX / currentZoom));
        panY = Math.max(-maxPanY, Math.min(maxPanY, startOffsetY + deltaY / currentZoom));
        
        applyZoom();
        e.preventDefault();
      }, { passive: false });
      
      document.addEventListener('touchend', function(e) {
        if (isPanning) {
          isPanning = false;
        }
      });
      
      console.log('Pan navigation initialized');
    }
    
    function resetPan() {
      panX = 0;
      panY = 0;
      isPanning = false;
      if (canvas) {
        canvas.style.cursor = isZoomed ? 'grab' : 'default';
      }
    }
    
    // ===== MOBILE RESPONSIVE FEATURES =====
    
    function initMobileFeatures() {
      if (!isMobileDevice()) return;
      
      // Initialize touch gestures
      initTouchGestures();
      
      // Initialize mobile navigation
      initMobileNavigation();
      
      // Initialize mobile canvas interactions
      initMobileCanvasInteraction();
      
      // Initialize keyboard handling for mobile
      initMobileKeyboard();
      
      // Initialize orientation change handling
      initOrientationHandling();
      
      console.log('Mobile features initialized');
    }
    
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
             window.innerWidth <= 768 ||
             ('ontouchstart' in window) ||
             (navigator.maxTouchPoints > 0);
    }
    
    function initTouchGestures() {
      let startY = 0;
      let isScrolling = false;
      
      // Smooth scrolling for mobile
      document.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
        isScrolling = false;
      }, { passive: true });
      
      document.addEventListener('touchmove', function(e) {
        if (!isScrolling) {
          const currentY = e.touches[0].clientY;
          const diffY = Math.abs(currentY - startY);
          
          if (diffY > 10) {
            isScrolling = true;
          }
        }
      }, { passive: true });
      
      // Double tap to reset zoom on canvas
      let lastTap = 0;
      const canvas = document.getElementById('preview-canvas');
      
      if (canvas) {
        canvas.addEventListener('touchend', function(e) {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;
          
          if (tapLength < 500 && tapLength > 0) {
            // Double tap detected - reset canvas view
            resetCanvasView();
            e.preventDefault();
          }
          lastTap = currentTime;
        });
      }
    }
    
    function initMobileNavigation() {
      // Auto-collapse sections on mobile after interaction
      const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
      
      collapsibleHeaders.forEach(header => {
        header.addEventListener('touchend', function() {
          // Small delay to ensure smooth animation
          setTimeout(() => {
            // Auto-scroll to the opened section
            if (!header.closest('.collapsible').classList.contains('collapsed')) {
              header.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest' 
              });
            }
          }, 100);
        });
      });
      
      // Mobile sticky navigation helper
      const actionButtons = document.querySelector('.action-buttons');
      if (actionButtons && window.innerWidth <= 767) {
        // Make action buttons sticky on mobile
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              actionButtons.classList.remove('fixed-bottom');
            } else {
              actionButtons.classList.add('fixed-bottom');
            }
          });
        });
        
        // Observe the last section
        const lastSection = document.querySelector('section:last-of-type');
        if (lastSection) {
          observer.observe(lastSection);
        }
      }
    }
    
    function initMobileCanvasInteraction() {
      const canvas = document.getElementById('preview-canvas');
      if (!canvas) return;
      
      let startX = 0;
      let startY = 0;
      let scale = 1;
      let initialDistance = 0;
      
      // Pinch to zoom
      canvas.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
          // Two finger touch - prepare for zoom
          initialDistance = getDistance(e.touches[0], e.touches[1]);
          e.preventDefault();
        } else if (e.touches.length === 1) {
          // Single touch - prepare for pan
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }
      }, { passive: false });
      
      canvas.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
          // Pinch zoom
          const currentDistance = getDistance(e.touches[0], e.touches[1]);
          const scaleChange = currentDistance / initialDistance;
          scale = Math.min(Math.max(0.5, scale * scaleChange), 3);
          
          canvas.style.transform = `scale(${scale})`;
          initialDistance = currentDistance;
          e.preventDefault();
        }
      }, { passive: false });
      
      canvas.addEventListener('touchend', function(e) {
        if (e.touches.length === 0) {
          // Reset if scale is too small
          if (scale < 0.8) {
            scale = 1;
            canvas.style.transform = 'scale(1)';
          }
        }
      });
    }
    
    function initMobileKeyboard() {
      // Handle virtual keyboard appearance
      let initialViewportHeight = window.innerHeight;
      
      window.addEventListener('resize', function() {
        const currentHeight = window.innerHeight;
        const heightDifference = initialViewportHeight - currentHeight;
        
        // If height decreased significantly, keyboard is likely open
        if (heightDifference > 150) {
          document.body.classList.add('keyboard-open');
          
          // Scroll focused element into view
          const focusedElement = document.activeElement;
          if (focusedElement && focusedElement.tagName !== 'BODY') {
            setTimeout(() => {
              focusedElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
              });
            }, 100);
          }
        } else {
          document.body.classList.remove('keyboard-open');
        }
      });
      
      // Prevent zoom on input focus for iOS
      const inputs = document.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          if (this.style.fontSize !== '16px') {
            this.style.fontSize = '16px';
          }
        });
      });
    }
    
    function initOrientationHandling() {
      // Handle orientation changes
      window.addEventListener('orientationchange', function() {
        setTimeout(() => {
          // Recalculate layout after orientation change
          if (canvas && currentImage) {
            updatePreview();
          }
          
          // Reset any zoom applied to canvas
          const canvas = document.getElementById('preview-canvas');
          if (canvas) {
            canvas.style.transform = 'scale(1)';
          }
          
          // Update container widths
          updateMobileLayout();
        }, 100);
      });
    }
    
    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    function resetCanvasView() {
      const canvas = document.getElementById('preview-canvas');
      if (canvas) {
        canvas.style.transform = 'scale(1)';
        canvas.style.transformOrigin = 'center';
      }
    }
    
    function updateMobileLayout() {
      if (!isMobileDevice()) return;
      
      // Update grid layouts for current screen size
      const grids = document.querySelectorAll('.grid');
      grids.forEach(grid => {
        if (window.innerWidth <= 480) {
          // Extra small screens - single column
          grid.style.gridTemplateColumns = '1fr';
        } else if (window.innerWidth <= 768) {
          // Small screens - adjust based on content
          if (grid.classList.contains('grid-cols-2')) {
            grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
          }
        }
      });
      
      // Update button groups
      const buttonGroups = document.querySelectorAll('.button-group');
      buttonGroups.forEach(group => {
        if (window.innerWidth <= 480) {
          group.style.flexDirection = 'column';
        } else {
          group.style.flexDirection = 'row';
        }
      });
      
      // Reajustar canvas si hay una imagen cargada
      if (currentImage && canvas) {
        setupCanvas();
        updatePreview();
      }
    }
    
    // Add mobile-specific CSS class to body
    if (isMobileDevice()) {
      document.body.classList.add('mobile-device');
    }
    
    // Initialize on window load
    window.addEventListener('load', function() {
      if (isMobileDevice()) {
        updateMobileLayout();
      }
    });
    
    // Add resize event listener for responsive canvas
    window.addEventListener('resize', function() {
      // Debounce the resize event
      clearTimeout(window.resizeTimer);
      window.resizeTimer = setTimeout(function() {
        if (isMobileDevice()) {
          updateMobileLayout();
        }
      }, 250);
    });
  </script>

  <!-- Progress Overlay -->
  <div id="progress-overlay" class="progress-overlay">
    <div class="progress-container">
      <div class="progress-title" id="progress-title">Preparando descarga...</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="progress-text" id="progress-text">0%</div>
      <div class="progress-eta" id="progress-eta">Calculando tiempo...</div>
    </div>
  </div>

</body>
</html>